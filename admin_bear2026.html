<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±±ç†Šç§‘å­¸ - å¾Œå°æŒ‡æ®ä¸­å¿ƒ</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tiny.cloud/1/2nwvnffdvbvf93d6ry0sov7w0d7yabtr1d6tp8l38cb6hoh1/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; padding: 20px; margin: 0; }
        .navbar { background-color: #2c3e50; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; color: white; }
        .nav-title { font-size: 24px; font-weight: bold; display: flex; align-items: center; }
        .nav-tabs button { background: none; border: none; color: #bdc3c7; font-size: 18px; cursor: pointer; margin-left: 15px; padding: 5px 10px; transition: 0.3s; }
        .nav-tabs button.active { color: white; border-bottom: 3px solid #e74c3c; font-weight: bold; }
        .nav-right { display: flex; align-items: center; }
        .btn-home { background: #e74c3c; color: white; text-decoration: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; font-size: 14px; margin-left: 20px; }
        
        .global-pwd-bar { background: #fff3e0; padding: 10px 20px; border-radius: 10px; border: 2px solid #f39c12; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-weight: bold; color: #d35400; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        #btnAddCourseBtn { width: 100%; padding: 15px; font-size: 18px; display: block; }

        @media (min-width: 768px) {
            .global-pwd-bar { max-width: 800px; margin-left: auto; margin-right: auto; }
            #btnAddCourseBtn { max-width: 800px; margin-left: auto; margin-right: auto; }
        }

        .page-section { display: none; }
        .page-section.active { display: block; }
        .form-container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 900px; margin: 0 auto; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        .form-row { display: flex; gap: 20px; }
        .form-row .form-group { flex: 1; }
        button { cursor: pointer; background-color: #3498db; color: white; border: none; font-weight: bold; padding: 10px 20px; border-radius: 5px; font-size: 16px; }
        button:hover { background-color: #2980b9; }
        button.danger { background-color: #e74c3c; }
        button.success { background-color: #27ae60; }
        button.warning { background-color: #f39c12; }
        button.dark { background-color: #34495e; } 
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .course-list { margin-top: 30px; display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
        .admin-course-card { width: 300px; background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; cursor: pointer; transition: 0.2s; position: relative; }
        .admin-course-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card-thumb { height: 150px; background-size: cover; background-position: center; }
        .card-content { padding: 15px; }
        .card-content h3 { margin: 0 0 10px 0; font-size: 18px; color: #2c3e50; }
        .card-content p { margin: 5px 0; color: #666; font-size: 14px; }
        .btn-delete { position: absolute; top: 10px; right: 10px; background: #e74c3c; padding: 5px 10px; font-size: 12px; z-index: 10; border-radius: 3px; }
        
        .table-container { overflow-x: auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 20px; }
        
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; white-space: nowrap; }
        th { background-color: #34495e; color: white; cursor: pointer; user-select: none; }
        th:hover { background-color: #2c3e50; }
        
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; color: white; }
        .badge.sold { background-color: #27ae60; }
        .badge.locked { background-color: #f39c12; }
        .badge.deleted { background-color: #95a5a6; text-decoration: line-through; } 
        .badge.wait { background-color: #e67e22; }
        
        tr.row-deleted { background-color: #f2f2f2; color: #999; }
        tr.row-deleted td { text-decoration: line-through; }
        tr.row-deleted button { text-decoration: none !important; }
        
        tr.duplicate-row { background-color: #fff3cd !important; }

        #imgPreview { max-width: 200px; margin-top: 10px; display: none; border-radius: 5px; }
        .big-selector { font-size: 18px; padding: 15px; width: 100%; max-width: 500px; margin: 0 auto; display: block; border: 2px solid #3498db; }
        .center-box { text-align: center; margin-bottom: 20px; background: white; padding: 20px; border-radius: 10px; }
        
        .banner-list { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; justify-content: center; }
        .banner-item { width: 300px; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
        .banner-item img { width: 100%; height: 150px; object-fit: cover; border-radius: 5px; }
        
        .visual-map-container { margin-top: 30px; background: white; padding: 20px; border-radius: 10px; overflow-x: auto; text-align: center; display: none; }
        .row { display: flex; justify-content: center; gap: 5px; margin-bottom: 5px; }
        .seat { width: 40px; height: 40px; background: #eee; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; position: relative; }
        .seat.sold { background: #e74c3c; color: white; }
        .seat.locked { background: #f39c12; color: white; }
        .seat.reserved { background: #8e44ad; color: white; }
        .seat.aisle { background: transparent; cursor: default; }
        .seat-tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 5px; border-radius: 3px; font-size: 12px; white-space: nowrap; display: none; z-index: 10; }
        .seat:hover .seat-tooltip { display: block; }
        
        .classroom-preview-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .classroom-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s; }
        .classroom-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .preview-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 999; }
        .preview-box { background: white; padding: 25px; border-radius: 10px; max-width: 90%; max-height: 90%; overflow: auto; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .preview-box h3 { margin-top: 0; color: #2c3e50; }
        .preview-box p { font-size: 16px; color: #555; margin-bottom: 20px; }

        #sweeperStatus { position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; z-index: 9999; }

        /* å­¸è²»å–®æ¨£å¼ */
        .bill-config-area { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; max-width: 800px; margin: 0 auto 20px auto; }
        .bill-preview-container { background: transparent; padding: 20px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; min-height: 600px; }
        .bill-controls { background: white; padding: 10px; border-radius: 8px; width: 210mm; display: flex; gap: 10px; align-items: center; justify-content: space-between; margin-bottom: 15px; box-sizing: border-box; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .bill-container {
            width: 210mm; height: 148mm; background: white; padding: 5mm; 
            display: flex; flex-direction: column; justify-content: space-between; 
            box-sizing: border-box; position: relative; overflow: hidden; 
            box-shadow: 0 0 15px rgba(0,0,0,0.5); text-align: left;
            font-family: 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
        }

        #billArea table { width: 100% !important; flex-grow: 1; border-collapse: collapse; border: 3px solid black; table-layout: fixed; margin-bottom: 5px; min-width: 0 !important; }
        #billArea th, #billArea td { border: 1px solid black; padding: 0; white-space: normal; }
        
        .row-header td { font-size: 18px; font-weight: bold; height: 35px; text-align: center; vertical-align: middle; white-space: nowrap; overflow: hidden; }
        .note-title { height: 35px; line-height: 35px; background: #f0f0f0; font-size: 15px; font-weight: bold; text-align: center; }
        .row-items { height: 200px; vertical-align: top; } 
        .row-items td { padding: 0; vertical-align: top; }
        
        #billArea .inner-table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-top: 2px; border: none; }
        #billArea .inner-table tr { height: 30px; } 
        #billArea .inner-table td { border: none; border-bottom: 1px dashed #ccc; padding: 0; font-size: 16px; vertical-align: middle; white-space: nowrap; overflow: hidden; }
        #billArea .inner-table tr:last-child td { border-bottom: none; }
        
        .item-header { background: #e0e0e0; font-weight: bold; font-size: 15px; height: 32px; display: flex; align-items: center; padding: 0 5px; border-bottom: 2px solid #000; letter-spacing: 1px; }
        
        #billArea .col-1 { width: 45%; max-width: 45%; text-align: left; padding-left: 10px !important; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; box-sizing: border-box; } 
        #billArea .col-2 { width: 36%; max-width: 36%; text-align: center; white-space: nowrap; overflow: hidden; box-sizing: border-box; } 
        #billArea .col-3 { width: 19%; max-width: 19%; text-align: right; padding-right: 15px !important; white-space: nowrap; overflow: hidden; box-sizing: border-box; } 
        
        .note-cell { font-size: 14px; color: #000; vertical-align: top; line-height: 1.4; padding: 5px; height: 200px; white-space: pre-wrap; position: relative; box-sizing: border-box; z-index: 1; word-break: break-all; }
        .note-cell::before { content: ""; position: absolute; top: 5px; left: 5px; right: 5px; bottom: 5px; background-image: url('logo1.png'); background-repeat: no-repeat; background-position: center center; background-size: contain; opacity: 0.25; z-index: -1; }
        .row-total { height: 40px !important; }
        .total-cell { background: #fffbe6 !important; height: 40px !important; padding: 0; vertical-align: top; }
        .total-wrapper { display: flex; align-items: baseline; justify-content: center; width: 100%; height: 100%; font-size: 20px; font-weight: bold; box-sizing: border-box; padding-top: 0; }
        .total-price { font-size: 28px; margin-left: 8px; font-weight: 800; } 
        .refund-title { text-align: center; font-weight: bold; width: 25px; font-size: 14px; line-height: 1.2; padding: 0 !important; }
        .refund-policy { font-size: 13px; line-height: 1.25; text-align: justify; padding: 3px 5px !important; vertical-align: middle; letter-spacing: -0.2px; }
        .footer-row td { height: 35px; font-size: 15px; vertical-align: middle; text-align: center;}
        .date-box { display: flex; justify-content: flex-end; align-items: center; padding-right: 20px; height: 100%; }
        .date-spacer-year { display: inline-block; width: 60px; }
        .date-spacer-md { display: inline-block; width: 60px; }
        .date-item { font-size: 16px; font-weight: bold; }
        .footer-wrapper { width: 100%; text-align: center; flex-shrink: 0; }
        .footer-outside { font-size: 12px; font-weight: bold; letter-spacing: 1px; color: #333; margin-bottom: 12px; }
        .bank-outside { font-size: 13px; font-weight: bold; padding: 5px; line-height: 1.4; border-top: 1px dashed #ccc; padding-top: 8px; width: 95%; margin: 0 auto; }
        .bank-highlight { color: #c00; margin-left: 5px; }
        
        .w-num { display: inline-block; width: 24px; text-align: center; font-weight: bold; }
        .d-text { margin: 0 1px; }
        
        [contenteditable="true"] { outline: none; }
        [contenteditable="true"]:hover { background-color: rgba(255, 255, 0, 0.1); cursor: text; }
        [contenteditable="true"]:focus { background-color: rgba(255, 255, 0, 0.2); border-bottom: 1px dashed #999; }
        
        .config-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #eee; }
        .config-row input { padding: 5px; border: 1px solid #ccc; border-radius: 3px; }

        /* åº§ä½ç·¨è¼¯å™¨æ¨£å¼ (V33.0) */
        #seatEditorContainer .classroom-wrapper { overflow-x: auto; padding-bottom: 20px; text-align: center; -webkit-overflow-scrolling: touch; background: #f9f9f9; border: 1px dashed #ccc; padding: 20px; border-radius: 10px; margin-top: 10px; }
        #seatEditorContainer .classroom-inner { display: inline-block; margin: 0 auto; }
        #seatEditorContainer .stage-box { width: 100%; margin: 0 auto 20px auto; padding: 12px; border: 3px solid #333; background-color: #fff; font-weight: bold; font-size: 22px; letter-spacing: 8px; text-align: center; box-sizing: border-box; }
        #seatEditorContainer .row { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; }
        #seatEditorContainer .seat { width: 45px; height: 55px; background-color: #4CAF50; color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; user-select: none; position: relative; transition: 0.2s; box-sizing: border-box; }
        #seatEditorContainer .seat:hover { transform: scale(1.1); z-index: 10; border: 2px solid #f1c40f; }
        #seatEditorContainer .seat.blocked { background-color: #95a5a6; cursor: pointer; transform: none; } 
        #seatEditorContainer .seat.aisle { background-color: transparent; color: transparent; border: 1px dashed #ddd; cursor: pointer; } 
        #seatEditorContainer .seat.door { background-color: #fff; color: #333; border: 2px solid #333; font-size: 16px; writing-mode: vertical-rl; cursor: pointer; transform: none; } 
        #seatEditorContainer .seat.pillar { background-color: #7f8c8d; color: white; cursor: pointer; transform: none; border-radius: 2px; } 
        
        @media (max-width: 768px) {
            #seatEditorContainer .classroom-inner { max-width: 100%; }
            #seatEditorContainer .stage-box { font-size: 14px; padding: 6px; margin-bottom: 12px; letter-spacing: 5px; }
            #seatEditorContainer .row { width: 100%; gap: 2px; margin-bottom: 5px; }
            #seatEditorContainer .seat { flex: 0 1 40px; min-width: 21px; height: auto; aspect-ratio: 45 / 55; font-size: clamp(8px, 2.5vw, 12px) !important; border-radius: 3px; padding: 0; }
        }

        /* â˜…â˜…â˜… V34.2 æ–°å¢ï¼šåº§ä½è¡¨è¼¸å‡ºæ¨£å¼ (A4 æ©«å‘ + è‡ªå‹•ç¸®æ”¾) â˜…â˜…â˜… */
        #printArea {
            background: white;
            padding: 20px;
            border: 1px solid #ccc;
            margin-top: 20px;
            overflow-x: auto;
            text-align: center;
            font-family: "Microsoft JhengHei", sans-serif;
        }
        
        .print-container {
            display: inline-block;
            width: 297mm; /* A4 æ©«å‘å¯¬åº¦ */
            height: 210mm; /* A4 æ©«å‘é«˜åº¦ */
            border: 2px solid black;
            padding: 15mm;
            background: white;
            box-sizing: border-box;
            position: relative;
            overflow: hidden; /* é˜²æ­¢å…§å®¹æº¢å‡º */
        }

        .print-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            border-bottom: 2px solid black;
            padding-bottom: 10px;
            font-weight: bold;
            font-size: 18px;
        }

        .print-stage {
            border: 2px solid black;
            font-size: 32px;
            font-weight: 900;
            padding: 10px;
            margin-bottom: 20px;
            letter-spacing: 20px;
            text-align: center;
        }

        /* ç¸®æ”¾å®¹å™¨ï¼šè² è²¬å°‡å…§å®¹ç¸®æ”¾åˆ°é©åˆ A4 çš„å¤§å° */
        .print-content-scaler {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* å¾ä¸Šæ–¹é–‹å§‹ */
            width: 100%;
            height: 100%;
            transform-origin: top center; /* å¾ä¸Šæ–¹ä¸­é–“é–‹å§‹ç¸®æ”¾ */
        }

        .print-row {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 5px;
        }

        .print-seat {
            width: 90px;
            height: 60px;
            border: 1px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: black;
            box-sizing: border-box;
            cursor: text;
            background: white;
        }
        
        .print-seat:hover { background-color: #f9f9f9; }
        .print-seat.empty { }
        .print-seat.aisle { border: none; background: transparent; cursor: default; }
        .print-seat.door { border: 2px solid black; font-size: 24px; writing-mode: vertical-rl; cursor: default; }
        .print-seat.pillar { background-color: #ccc; color: white; border: 1px solid #999; cursor: default; }
        .print-seat.blocked { background: repeating-linear-gradient(45deg, #eee, #eee 10px, #ccc 10px, #ccc 20px); color: transparent; cursor: default; }

    </style>
</head>
<body>

    <div id="sweeperStatus">ğŸ§¹ æ®­å±æ¸…é™¤å™¨ï¼šå¾…å‘½</div>

    <div class="navbar">
        <div class="nav-title">
            <img src="logo1.png" style="height:40px; vertical-align:middle; margin-right:10px;">
            å±±ç†Šç§‘å­¸å¾Œå°
        </div>
        <div class="nav-right">
            <div class="nav-tabs">
                <button class="active" onclick="switchTab('monitor')">ğŸ“Š åŠƒä½ç›£æ§</button>
                <button onclick="switchTab('waitlist')">ğŸ“‹ å€™è£œåå–®</button>
                <button onclick="switchTab('courses')">ğŸ“ èª²ç¨‹ç®¡ç†</button>
                <button onclick="switchTab('banners')">ğŸ–¼ï¸ æ©«å¹…ç®¡ç†</button>
                <button onclick="switchTab('classrooms')">ğŸ« æ•™å®¤é è¦½</button>
                <button onclick="switchTab('bills')">ğŸ’° å­¸è²»å–®ç”Ÿæˆ</button>
                <button onclick="switchTab('print')">ğŸ–¨ï¸ åº§ä½è¡¨è¼¸å‡º</button>
            </div>
            <a href="index.html" class="btn-home" target="_blank">å›é¦–é </a>
        </div>
    </div>

    <div class="global-pwd-bar">
        <label>ğŸ”‘ ç®¡ç†å“¡å¯†ç¢¼ (å…¨åŸŸ)ï¼š</label>
        <input type="password" id="adminPwd" placeholder="è«‹è¼¸å…¥æ“ä½œå¯†ç¢¼" style="padding:5px; width:150px; border:1px solid #d35400; border-radius:5px;">
        <span style="font-size:12px; color:#666;">(ä»»ä½•ç·¨è¼¯/åˆªé™¤æ“ä½œçš†éœ€é©—è­‰æ­¤å¯†ç¢¼)</span>
    </div>

    <div id="tab-monitor" class="page-section active">
        <div class="center-box">
            <div style="margin-bottom:10px;">ç›®å‰æª¢è¦–ï¼š<span id="currentClassName" style="font-weight:bold;">æ‰€æœ‰èª²ç¨‹</span> | å·²åŠƒä½ï¼š<span id="totalSold" style="font-weight:bold;">0</span></div>
            <select id="classSelector" class="big-selector" onchange="loadVisualMap()"><option value="all">å…¨éƒ¨èª²ç¨‹ç¸½è¦½</option></select>
            <div id="visualMap" class="visual-map-container">
                <h3>åº§ä½è¡¨ç›£æ§ (é»æ“Šåº§ä½å¯æ“ä½œ)</h3>
                <div id="mapContent"></div>
            </div>
            <div style="margin-top:20px;">
                <input type="text" id="searchInput" placeholder="æœå°‹å§“åã€é›»è©±æˆ–è¨‚å–®ç·¨è™Ÿ..." style="padding:10px; width:300px;">
                <button onclick="exportBookingCSV()" class="success">ğŸ“¥ åŒ¯å‡º Excel</button>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th onclick="sortBookingTable('orderId')">è¨‚å–®ç·¨è™Ÿ â‡…</th>
                        <th onclick="sortBookingTable('courseName')">èª²ç¨‹ â‡…</th>
                        <th onclick="sortBookingTable('time')">æ™‚é–“ â‡…</th>
                        <th onclick="sortBookingTable('status')">ç‹€æ…‹ â‡…</th>
                        <th onclick="sortBookingTable('seatId')">åº§ä½ â‡…</th>
                        <th onclick="sortBookingTable('studentName')">å§“å â‡…</th>
                        <th onclick="sortBookingTable('parentPhone')">é›»è©± â‡…</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="bookingTable"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-waitlist" class="page-section">
        <div class="center-box">
            <select id="waitlistSelector" class="big-selector"><option value="all">é¸æ“‡èª²ç¨‹æŸ¥çœ‹å€™è£œ</option></select>
            <div style="margin-top:20px;">
                <button onclick="exportWaitlistCSV()" class="success">ğŸ“¥ åŒ¯å‡ºå€™è£œ Excel</button>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th onclick="sortWaitlistTable('courseName')">èª²ç¨‹ â‡…</th>
                        <th onclick="sortWaitlistTable('timestamp')">ç™»è¨˜æ™‚é–“ â‡…</th>
                        <th onclick="sortWaitlistTable('status')">ç‹€æ…‹ â‡…</th>
                        <th onclick="sortWaitlistTable('seq')">åºè™Ÿ â‡…</th>
                        <th onclick="sortWaitlistTable('studentName')">å§“å â‡…</th>
                        <th onclick="sortWaitlistTable('parentPhone')">é›»è©± â‡…</th>
                        <th>å‚™è¨»</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="waitlistTable"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-courses" class="page-section">
        <div id="courseListView">
            <button onclick="showCourseForm()" class="success" id="btnAddCourseBtn">â• æ–°å¢èª²ç¨‹</button>
            <div id="courseList" class="course-list"></div>
        </div>

        <div id="courseFormView" class="form-container" style="display:none;">
            <h2 id="formTitle" style="margin-top:0;">â• æ–°å¢èª²ç¨‹</h2>
            <input type="hidden" id="c_id"> 
            
            <!-- ç¬¬ä¸€åˆ—ï¼šå¹´ç´š + ç§‘ç›® + è€å¸« -->
            <div class="form-row">
                <div class="form-group">
                    <label>å¹´ç´šåˆ†é¡ (Grade)</label>
                    <select id="c_grade" onchange="updateSubjects()">
                        <option value="">è«‹é¸æ“‡å¹´ç´š</option>
                        <option value="å‡å°äº”èª²ç¨‹">å‡å°äº”èª²ç¨‹</option><option value="å‡å°å…­èª²ç¨‹">å‡å°å…­èª²ç¨‹</option>
                        <option value="å‡åœ‹ä¸€èª²ç¨‹">å‡åœ‹ä¸€èª²ç¨‹</option><option value="å‡åœ‹äºŒèª²ç¨‹">å‡åœ‹äºŒèª²ç¨‹</option><option value="å‡åœ‹ä¸‰èª²ç¨‹">å‡åœ‹ä¸‰èª²ç¨‹</option>
                        <option value="å‡é«˜ä¸€èª²ç¨‹">å‡é«˜ä¸€èª²ç¨‹</option><option value="å‡é«˜äºŒèª²ç¨‹">å‡é«˜äºŒèª²ç¨‹</option><option value="å‡é«˜ä¸‰èª²ç¨‹">å‡é«˜ä¸‰èª²ç¨‹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ç§‘ç›®åç¨± (Subject)</label>
                    <input list="subject_list" id="c_subject" placeholder="é¸æ“‡æˆ–è¼¸å…¥ç§‘ç›®">
                    <datalist id="subject_list"></datalist>
                </div>
                <div class="form-group">
                    <label>æˆèª²è€å¸«</label>
                    <input list="teacher_list" id="c_teacher" placeholder="é¸æ“‡æˆ–è¼¸å…¥è€å¸«">
                    <datalist id="teacher_list">
                        <option value="ç™½ç†Šè€å¸«"></option><option value="é˜¿å–µè€å¸«"></option><option value="å°å½¥è€å¸«"></option>
                        <option value="å°æ±è€å¸«"></option><option value="æç¿”è€å¸«"></option><option value="å† ç¶­è€å¸«"></option>
                        <option value="å°æšè€å¸«"></option><option value="é»ƒé“è€å¸«"></option><option value="åŒ–éˆè€å¸«"></option>
                        <option value="Nickè€å¸«"></option><option value="å‘¨é€¸è€å¸«"></option><option value="é»ƒæµ©è€å¸«"></option>
                        <option value="å°å¤©è€å¸«"></option><option value="å¯Œå±±è€å¸«"></option><option value="é»ƒéŸ‹è€å¸«"></option>
                        <option value="è•­æ¥­è€å¸«"></option><option value="éƒ­åºè€å¸«"></option><option value="è©©ä½©è€å¸«"></option>
                    </datalist>
                </div>
            </div>

            <!-- ç¬¬äºŒåˆ—ï¼šç­åˆ¥ + ä¸Šèª²æ™‚é–“ -->
            <div class="form-row">
                <div class="form-group">
                    <label>ç­åˆ¥ (Class Type)</label>
                    <input list="class_type_list" id="c_class_type" placeholder="ä¾‹å¦‚ï¼šé€±ä¸€ç­" onchange="autoFillTime()">
                    <datalist id="class_type_list">
                        <option value="é€±ä¸€ç­"></option>
                        <option value="é€±äºŒç­"></option>
                        <option value="é€±ä¸‰ç­"></option>
                        <option value="é€±å››ç­"></option>
                        <option value="é€±äº”ç­"></option>
                        <option value="é€±ä¸€ã€å››ç­"></option>
                        <option value="é€±äºŒã€äº”ç­"></option>
                        <option value="é€±ä¸‰ã€å…­ç­"></option>
                        <option value="é€±å…­ç­"></option>
                        <option value="é€±æ—¥ç­"></option>
                        <option value="é€±å…­ä¸Šåˆç­"></option>
                        <option value="é€±å…­ä¸‹åˆç­"></option>
                        <option value="é€±å…­æ™šä¸Šç­"></option>
                        <option value="é€±æ—¥ä¸Šåˆç­"></option>
                        <option value="é€±æ—¥ä¸‹åˆç­"></option>
                        <option value="é€±æ—¥æ™šä¸Šç­"></option>
                    </datalist>
                </div>
                <div class="form-group">
                    <label>ä¸Šèª²æ™‚é–“ (è‡ªå‹•ä»£å…¥)</label>
                    <input type="text" id="c_time_desc" placeholder="ä¾‹å¦‚ï¼šæ¯é€±å›› 18:30-21:30">
                </div>
            </div>

            <!-- ç¬¬ä¸‰åˆ—ï¼šè²»ç”¨ + å ‚æ•¸ -->
            <div class="form-row">
                <div class="form-group">
                    <label>è²»ç”¨</label>
                    <input type="text" id="c_price" placeholder="ä¾‹å¦‚ï¼š21600" value="21600" onblur="formatPrice(this)">
                </div>
                <div class="form-group">
                    <label>å ‚æ•¸</label>
                    <input type="text" id="c_lessons" placeholder="ä¾‹å¦‚ï¼š12" value="12">
                </div>
            </div>

            <!-- ç¬¬å››åˆ—ï¼šå°é¢åœ–ç‰‡ -->
            <div class="form-group">
                <label>å°é¢åœ–ç‰‡ (å»ºè­° 800x400)</label>
                <input type="file" id="c_image_file" accept="image/*" onchange="previewImage(this)">
                <input type="hidden" id="c_image_url">
                <img id="imgPreview" src="" alt="åœ–ç‰‡é è¦½">
                <div id="uploadStatus" style="font-size:12px; color:#666; margin-top:5px;"></div>
            </div>

            <!-- ç¬¬äº”åˆ—ï¼šé–‹èª²æ—¥æœŸ + ä½¿ç”¨æ•™å®¤ -->
            <div class="form-row">
                <div class="form-group">
                    <label>é–‹èª²æ—¥æœŸ (è¼¸å…¥ 7/2 è‡ªå‹•è½‰)</label>
                    <input type="text" id="c_start_date" placeholder="ä¾‹å¦‚ï¼š2026/07/02 (å››)" onblur="formatDate(this)">
                </div>
                <div class="form-group">
                    <label>ä½¿ç”¨æ•™å®¤ (åˆ‡æ›å°‡é‡ç½®ä¸‹æ–¹åº§ä½è¡¨)</label>
                    <select id="c_classroom" onchange="resetSeatEditor()">
                        <option value="high_red">é«˜ä¸­ç´…æ•™å®¤</option><option value="high_orange">é«˜ä¸­æ©˜æ•™å®¤</option><option value="high_green">é«˜ä¸­ç¶ æ•™å®¤</option>
                        <option value="high_yellow">é«˜ä¸­é»ƒæ•™å®¤</option><option value="high_blue">é«˜ä¸­è—æ•™å®¤</option><option value="middle_new_orange">åœ‹ä¸­æ–°æ©˜æ•™å®¤</option>
                        <option value="middle_new_blue">åœ‹ä¸­æ–°è—æ•™å®¤</option><option value="middle_new_yellow">åœ‹ä¸­æ–°é»ƒæ•™å®¤</option><option value="middle_new_red">åœ‹ä¸­æ–°ç´…æ•™å®¤</option>
                        <option value="middle_big_red">åœ‹ä¸­å¤§ç´…æ•™å®¤</option><option value="middle_big_orange">åœ‹ä¸­å¤§æ©˜æ•™å®¤</option><option value="middle_big_green">åœ‹ä¸­å¤§ç¶ æ•™å®¤</option>
                        <option value="test_room">ğŸ§ª æ¸¬è©¦å°ˆç”¨æ•™å®¤</option>
                    </select>
                </div>
            </div>

            <!-- ç¬¬å…­åˆ—ï¼šåº§ä½è¡¨ç·¨è¼¯å™¨ -->
            <div class="form-group" id="seatEditorContainer">
                <label style="color:#e74c3c;">ğŸª‘ åº§ä½è¡¨ç·¨è¼¯å™¨ (é»æ“Šæ ¼å­å¯åˆ‡æ›ç‹€æ…‹)</label>
                <div style="font-size:12px; color:#666; margin-bottom:5px; text-align: center;">
                    ç‹€æ…‹å¾ªç’°ï¼šğŸŸ©åº§ä½ âœ â¬œèµ°é“ âœ â¬›ä¸é–‹æ”¾ âœ ğŸŸ«æŸ±å­ âœ ğŸšªé–€ âœ (å›é ­)
                </div>
                <div id="editorLockMsg" style="display:none; color:red; font-weight:bold; background:#ffeeba; padding:10px; border-radius:5px; margin-bottom:10px; text-align: center;">
                    ğŸ”’ æ­¤èª²ç¨‹å·²æœ‰å”®å‡ºç´€éŒ„ï¼Œç‚ºä¿è­·è¨‚å–®è³‡æ–™ï¼Œåº§ä½è¡¨å·²é–å®šä¸å¯ç·¨è¼¯ã€‚
                </div>
                <div class="classroom-wrapper" style="margin: 0 auto;">
                    <div class="classroom-inner">
                        <div class="stage-box">è¬›ã€€å°</div>
                        <div id="editorGrid"></div>
                    </div>
                </div>
                <button type="button" onclick="resetSeatEditor()" class="warning" style="font-size:12px; padding:5px 10px;">â†º é‡ç½®ç‚ºé è¨­ç¯„æœ¬</button>
            </div>

            <!-- ç¬¬ä¸ƒåˆ—ï¼šä¸€éšåŠƒä½æ™‚é–“ -->
            <div class="form-row">
                <div class="form-group">
                    <label style="color:#e74c3c;">â˜… ä¸€éšåŠƒä½ (é–‹å§‹)</label>
                    <input type="datetime-local" id="c_start1">
                </div>
                <div class="form-group">
                    <label>ä¸€éšåŠƒä½ (çµæŸ)</label>
                    <input type="datetime-local" id="c_end1">
                </div>
            </div>

            <!-- ç¬¬å…«åˆ—ï¼šäºŒéšåŠƒä½æ™‚é–“ -->
            <div class="form-row">
                <div class="form-group">
                    <label>äºŒéšåŠƒä½ (é–‹å§‹)</label>
                    <input type="datetime-local" id="c_start2">
                </div>
                <div class="form-group">
                    <label>äºŒéšåŠƒä½ (çµæŸ)</label>
                    <input type="datetime-local" id="c_end2">
                </div>
            </div>
            
            <!-- ç¬¬ä¹åˆ—ï¼šå‰å°é¡¯ç¤ºæ™‚é–“ -->
            <div class="form-row" style="background:#e8f6f3; padding:10px; border-radius:5px; margin-bottom:20px;">
                <div class="form-group">
                    <label>å‰å°é¡¯ç¤ºæ™‚é–“ (é–‹å§‹)</label>
                    <input type="datetime-local" id="c_display_start">
                </div>
                <div class="form-group">
                    <label>å‰å°é¡¯ç¤ºæ™‚é–“ (çµæŸ)</label>
                    <input type="datetime-local" id="c_display_end">
                </div>
            </div>

            <!-- ç¬¬ååˆ—ï¼šå€™è£œè¨­å®š -->
            <div class="form-row" style="background:#fff3e0; padding:10px; border-radius:5px; margin-bottom:20px;">
                <div class="form-group" style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="c_waitlist_enabled" style="width:auto; transform:scale(1.5);">
                    <label for="c_waitlist_enabled" style="margin:0; cursor:pointer;">å•Ÿç”¨å€™è£œåŠŸèƒ½</label>
                </div>
                <div class="form-group">
                    <label>å€™è£œäººæ•¸é™åˆ¶ (0 ç‚ºä¸é™)</label>
                    <input type="number" id="c_waitlist_limit" placeholder="ä¾‹å¦‚ï¼š10" value="0">
                </div>
            </div>

            <!-- ç¬¬åä¸€åˆ—ï¼šèª²ç¨‹ä»‹ç´¹ -->
            <div class="form-group">
                <label>èª²ç¨‹ä»‹ç´¹ / æ³¨æ„äº‹é …</label>
                <textarea id="c_desc"></textarea>
            </div>

            <!-- ç¬¬åäºŒåˆ—ï¼šæŒ‰éˆ• -->
            <div style="display:flex; gap:10px;">
                <button onclick="saveCourse()" class="success" style="flex:1;" id="btnSave">ç¢ºèªæ–°å¢èª²ç¨‹</button>
                <button onclick="hideCourseForm()" class="warning" id="btnCancel">å–æ¶ˆè¿”å›</button>
            </div>
        </div>
      </div>

    <div id="tab-banners" class="page-section">
        <div class="center-box">
            <h3>ğŸ–¼ï¸ ä¸Šå‚³æ–°æ©«å¹…</h3>
            <input type="file" id="b_file" accept="image/*">
            <button onclick="uploadBanner()" class="success">ä¸Šå‚³</button>
            <div id="bannerStatus"></div>
        </div>
        <div id="bannerList" class="banner-list"></div>
    </div>

    <div id="tab-classrooms" class="page-section">
        <div class="classroom-preview-list" id="classroomList"></div>
    </div>

    <div id="tab-bills" class="page-section">
        <div class="bill-config-area">
            <h3>1. åƒæ•¸è¨­å®š</h3>
            <div style="margin-bottom:15px;">
                <label>é¸æ“‡éƒ¨åˆ¥ï¼š</label>
                <select id="billTypeSelector" style="padding:5px; font-size:16px; border:2px solid #2c3e50;" onchange="renderCourseConfig()">
                    <option value="junior">ğŸ« åœ‹ä¸­å°éƒ¨ (é è¨­)</option>
                    <option value="senior">ğŸ« é«˜ä¸­éƒ¨</option>
                </select>
            </div>
            <div id="courseConfigList" style="max-height:300px; overflow-y:auto; border:1px solid #ddd; padding:10px; margin-bottom:15px;"></div>
            
            <h3>2. åŒ¯å…¥èˆŠç”Ÿè³‡æ–™ (CSV)</h3>
            <div style="margin-bottom:15px;">
                <input type="file" id="csvSchoolFile" accept=".csv">
                <button onclick="importSchoolCSV()" class="warning">ğŸ“‚ åŒ¯å…¥ CSV</button>
                <span id="csvStatus" style="color:green; font-weight:bold; margin-left:10px;"></span>
                <div style="font-size:12px; color:#666; margin-top:5px;">ç³»çµ±æœƒè‡ªå‹•å°‹æ‰¾æ¨™é¡Œåˆ—ä¸­çš„ã€Œå­¸æ ¡ã€èˆ‡ã€Œå§“åã€æ¬„ä½</div>
            </div>

            <div style="display:flex; gap:10px;">
                <button onclick="saveAllBillConfigs()" class="success" style="flex:1;">ğŸ’¾ å„²å­˜è¨­å®šä¸¦ç”¢ç”Ÿå­¸è²»å–®</button>
                <button onclick="createManualBill()" class="dark" style="flex:1;">â• æ–°å¢ç©ºç™½å–®</button>
            </div>
        </div>

        <div class="bill-preview-container">
            <div style="width: 210mm; margin-bottom:10px; color:#e74c3c; font-weight:bold; font-size:16px; background:#fff3cd; padding:10px; border-radius:8px; box-sizing: border-box; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                ğŸ’¡ æç¤ºï¼šå¯ä»¥ç›´æ¥é»æ“Šå­¸è²»å–®ä¸Šçš„ã€Œå§“åã€å­¸æ ¡ã€å‚™è¨»ã€é …ç›®ã€æ—¥æœŸã€é‡‘é¡èˆ‡ç¸½è¨ˆã€æ¬„ä½é€²è¡Œæ‰‹å‹•ä¿®æ”¹ï¼
            </div>
            <div class="bill-controls">
                <button onclick="prevBill()" style="background:#5f6368; color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer;">â—€ ä¸Šä¸€å¼µ</button>
                <span id="billCounter" style="font-weight:bold; font-size:16px;">0 / 0</span>
                <button onclick="nextBill()" style="background:#5f6368; color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer;">ä¸‹ä¸€å¼µ â–¶</button>
                <div style="flex-grow:1;"></div>
                <button onclick="downloadCurrentBill()" class="warning">ğŸ“¸ ä¸‹è¼‰é€™å¼µ</button>
                <button onclick="downloadAllBills()" class="success">ğŸ“¥ å…¨éƒ¨ä¸‹è¼‰</button>
            </div>

            <div class="bill-container" id="billArea">
                <table class="bill-table">
                    <tr class="row-header">
                        <td style="width: 9%;">å§“å</td>
                        <td style="width: 16%;" id="billName" contenteditable="true"></td>
                        <td style="width: 9%;">å¹´ç´š</td>
                        <td style="width: 11%;" id="billGrade" contenteditable="true"></td>
                        <td style="width: 9%;">å­¸æ ¡</td>
                        <td style="width: 16%;" id="billSchool" contenteditable="true"></td>
                        <td style="width: 30%; padding:0; vertical-align:top;">
                            <div class="note-title">å‚™è¨»</div>
                        </td>
                    </tr>
                    <tr class="row-items">
                        <td colspan="6" rowspan="2" style="position: relative;">
                            <div class="item-header">
                                <span class="col-1">æ”¶è²»ç§‘ç›®</span>
                                <span class="col-2">èµ·å§‹æ—¥æœŸèˆ‡å ‚æ•¸</span>
                                <span class="col-3">é‡‘é¡</span>
                            </div>
                            <table class="inner-table" id="itemsTable"></table>
                        </td>
                        <td style="vertical-align: top; padding: 0;">
                            <div id="billNote" class="note-cell" contenteditable="true"></div>
                        </td>
                    </tr>
                    <tr class="row-total">
                        <td class="total-cell">
                            <div class="total-wrapper">
                                åˆè¨ˆ <span id="billTotal" class="total-price" contenteditable="true">0</span> å…ƒ
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="refund-title">é€€<br>è²»<br>è¦<br>å®š</td>
                        <td colspan="6" class="refund-policy">
                            ä¸€ã€æœ¬è¯è¦–åŒæ­£å¼ä¹‹æ”¶æ“šï¼Œè«‹ä¿ç•™ä¸‰å€‹æœˆä»¥ä¸Šï¼Œä»¥ä¾¿æ ¸æŸ¥ã€‚<br>
                            äºŒã€è£œç¿’ç­å­¸ç”Ÿç¹³ç´è²»ç”¨å¾Œé›¢ç­è€…ï¼Œè£œç¿’ç­æ‡‰ä¾æ–°ç«¹å¸‚çŸ­æœŸè£œç¿’ç­è¨­ç«‹åŠç®¡ç†è¦å‰‡ç¬¬å…­ç« ç¬¬ 36 æ¢è¦å®šè¾¦ç†é€€è²»ï¼š<br>
                            (ä¸€) å­¸ç”Ÿæ–¼å¯¦éš›é–‹èª²æ—¥å‰æå‡ºé€€è²»ç”³è«‹è€…ï¼Œæ‡‰é€€é‚„ç•¶æœŸé–‹ç­ç´„å®šç¹³ç´è²»ç”¨ç¸½é¡ä¹æˆã€‚<br>
                            (äºŒ) å­¸ç”Ÿæ–¼å¯¦éš›é–‹èª²æ—¥èµ·è‡³ç¬¬ä¸‰æ—¥ä¸Šèª²å‰æå‡ºé€€è²»ç”³è«‹è€…ï¼Œæ‡‰é€€é‚„ç•¶æœŸé–‹ç­ç´„å®šç¹³ç´è²»ç”¨ç¸½é¡å…«æˆã€‚<br>
                            (ä¸‰) å­¸ç”Ÿæ–¼å¯¦éš›é–‹èª²æ—¥èµ·ç¬¬ä¸‰æ—¥ä¸Šèª²å¾Œä¸”æœªé”å…¨æœŸä¹‹ä¸‰åˆ†ä¹‹ä¸€æœŸé–“å…§æå‡ºé€€è²»ç”³è«‹è€…ï¼Œæ‡‰é€€é‚„ç•¶æœŸé–‹ç­ç´„å®šç¹³ç´è²»ç”¨ç¸½é¡äº”æˆã€‚<br>
                            (å››) å­¸ç”Ÿæ–¼é”å…¨æœŸä¹‹ä¸‰åˆ†ä¹‹ä¸€ä»¥ä¸ŠæœŸé–“æå‡ºé€€è²»ç”³è«‹ï¼Œæ‰€æ”¶å–ä¹‹ç•¶æœŸé–‹ç­ç´„å®šç¹³ç´è²»ç”¨å¾—å…¨æ•¸ä¸äºˆé€€é‚„ã€‚
                        </td>
                    </tr>
                    <tr class="footer-row">
                        <td colspan="2" style="font-weight: bold;">ç¹³è²»æ—¥æœŸ</td>
                        <td colspan="3">
                            <div class="date-box">
                                <span class="date-spacer-year"></span><span class="date-item">å¹´</span>
                                <span class="date-spacer-md"></span><span class="date-item">æœˆ</span>
                                <span class="date-spacer-md"></span><span class="date-item">æ—¥</span>
                            </div>
                        </td>
                        <td colspan="1" style="font-weight: bold;">æ”¶æ¬¾äºº</td>
                        <td colspan="1"></td>
                    </tr>
                </table>
                <div class="footer-wrapper">
                    <div class="footer-outside" id="footerInfo">
                        æ–°ç«¹å¸‚ç§ç«‹å±±ç†Šç§‘å­¸æ–‡ç†çŸ­æœŸè£œç¿’ç­ &nbsp; åœ°å€ï¼šæ–°ç«¹å¸‚ç§‘å­¸åœ’è·¯107å··1è™Ÿ &nbsp; ç«‹æ¡ˆå­—è™Ÿï¼šåºœæ•™ç¤¾å­—ç¬¬1010019608è™Ÿ
                    </div>
                    <div class="bank-outside" id="bankInfo">
                        ç¬¬ä¸€éŠ€è¡Œ(007) ç«¹ç§‘åˆ†è¡Œ &nbsp;&nbsp; æˆ¶åï¼šæ–°ç«¹å¸‚ç§ç«‹å±±ç†Šç§‘å­¸æ–‡ç†çŸ­æœŸè£œç¿’ç­ &nbsp;&nbsp; å¸³è™Ÿï¼š303-100-13273<br>
                        <span class="bank-highlight">â˜… åŒ¯æ¬¾å¾Œè«‹å‘ŠçŸ¥æˆ‘å€‘ä¸Šèª²ç§‘ç›®ã€åŒ¯æ¬¾é‡‘é¡åŠå¸³è™Ÿå¾Œ 5 ç¢¼ä»¥åˆ©æˆ‘å€‘å°å¸³ï¼Œè¬è¬ã€‚</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-print" class="page-section">
        <div class="center-box">
            <h3>ğŸ–¨ï¸ åº§ä½è¡¨åœ–ç‰‡ç”¢ç”Ÿå™¨</h3>
            <div style="width: 100%; max-width: 500px; margin: 0 auto 15px auto; color:#e74c3c; font-weight:bold; font-size:13px; background:#fff3cd; padding:15px; border-radius:8px; box-sizing: border-box; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: left; line-height: 1.6;">
                ğŸ’¡ æç¤ºï¼šé»æ“Šä¸‹æ–¹çš„ã€Œç©ºä½ã€æˆ–ã€Œä¸Šæ–¹æ¨™é¡Œåˆ—ã€ï¼Œéƒ½å¯ä»¥ç›´æ¥æ‰‹å‹•ä¿®æ”¹æ–‡å­—ï¼<br>
                âš ï¸ æ³¨æ„ï¼šæ­¤è™•çš„ä¿®æ”¹åƒ…ä¾›åˆ—å°ä½¿ç”¨ï¼Œä¸æœƒå½±éŸ¿å‰å°çš„ç·šä¸ŠåŠƒä½çµæœã€‚<br>âš ï¸ è‹¥è¦ä¿å­˜ä¿®æ”¹ï¼Œè«‹è¨˜å¾—ä½¿ç”¨ã€Œå¦å­˜æ–°æª”ã€ã€‚
            </div>
            <div style="display:flex; flex-direction:column; gap:10px; justify-content:center; align-items:center;">
                <select id="printSourceSelector" class="big-selector" style="width:100%; max-width:500px;" onchange="updatePrintCourseList()">
                    <option value="live">ç·šä¸ŠåŠƒä½çµæœ (Live)</option>
                    <option value="manual">æ‰‹å‹•æ’ä½å­˜æª” (Saved)</option>
                    <option value="empty">ç©ºç™½æ•™å®¤ç¯„æœ¬ (Empty)</option>
                </select>
                <select id="printCourseSelector" class="big-selector" onchange="generateSeatingChart()">
                    <option value="">è«‹é¸æ“‡èª²ç¨‹/æ•™å®¤...</option>
                </select>
            </div>
            
            <div id="manualSaveArea" style="margin-top:15px; display:none; gap:10px; justify-content:center; align-items:center; background:#fff3cd; padding:10px; border-radius:5px;">
                <label>å­˜æª”åç¨±ï¼š</label>
                <input type="text" id="manualSaveName" placeholder="ä¾‹å¦‚ï¼šé€±å…­ç­æ‰‹å‹•æ’ä½" style="padding:5px;">
                <button onclick="saveManualLayout()" class="warning">ğŸ’¾ å¦å­˜æ–°æª”</button>
            </div>

            <div style="margin-top:15px;">
                <button onclick="downloadSeatingChart()" class="success">ğŸ“¸ ä¸‹è¼‰åº§ä½è¡¨åœ–ç‰‡ (A4)</button>
            </div>
        </div>
        
        <div id="printArea">
            <div class="print-container">
                <div class="print-header">
                    <div id="p_classroom">æ•™å®¤åç¨±</div>
                    <div id="p_classType">ç­ç´šï¼š</div>
                    <div id="p_time">ä¸Šèª²æ™‚é–“ï¼š</div>
                    <div id="p_teacher">è€å¸«ï¼š</div>
                </div>
                <div class="print-stage">è¬›ã€€ã€€å°</div>
                <div class="print-content-scaler">
                    <div id="printGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="previewModal" class="preview-modal" onclick="closePreview()">
        <div class="preview-box" onclick="event.stopPropagation()">
            <h3 id="previewTitle"></h3>
            <div id="previewContent" style="display:flex; justify-content:center; flex-direction:column; align-items:center;"></div>
            <button onclick="closePreview()" style="margin-top:20px;">é—œé–‰</button>
        </div>
    </div>

    <div id="opModal" class="preview-modal">
        <div class="preview-box" style="text-align: center; max-width: 400px;">
            <h3>ç®¡ç†å“¡ä¿ç•™ä½æ“ä½œ</h3>
            <p id="opTarget" style="font-weight:bold; color:#8e44ad;"></p>
            <div style="display:flex; gap:20px; justify-content:center; margin-top:20px;">
                <button class="danger" onclick="confirmOpRelease()">ğŸ—‘ï¸ é‡‹å‡ºåº§ä½</button>
                <button class="success" onclick="confirmOpSell()">ğŸ’° è½‰ç‚ºå”®å‡º</button>
            </div>
            <button onclick="closeOpModal()" style="margin-top:20px; background:#7f8c8d;">å–æ¶ˆ</button>
        </div>
    </div>

    <script type="module">
        import { db, ref, set, remove, push, update, storage, storageRef, uploadBytes, getDownloadURL, get } from './firebase-config.js';
        import { onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // â˜…â˜…â˜… é˜²å·è·‘èˆ‡æ™‚é–“æ ¡æº– â˜…â˜…â˜…
        let serverTimeOffset = 0;
        onValue(ref(db, ".info/serverTimeOffset"), (snap) => {
            serverTimeOffset = snap.val() || 0;
        });

        // â˜…â˜…â˜… é˜²é–ƒçˆå¿«ç…§è®Šæ•¸ â˜…â˜…â˜…
        let currentCourseListStr = "";
        let currentClassSelectorStr = "";
        let currentWaitlistSelectorStr = "";

        tinymce.init({ 
            selector: '#c_desc', 
            plugins: 'image link lists media table code', 
            toolbar: 'undo redo | code | fontfamily fontsize | forecolor backcolor | formatselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | image', 
            height: 400, 
            menubar: true 
        });

        const classrooms = {
            "high_red": { name: "é«˜ä¸­ç´…æ•™å®¤", layout: [ ["1-1:X", "1-2:X", "_", "1-3", "1-4", "1-5", "_", "1-6", "1-7", "1-8", "_", "1-9:X", "1-10:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8", "_", "2-9", "2-10"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8", "_", "3-9", "3-10"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8", "_", "4-9", "4-10"], ["5-1", "5-2", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "5-8", "_", "5-9", "5-10"], ["6-1", "6-2", "_", "6-3", "6-4", "6-5", "_", "6-6", "6-7", "6-8", "_", "6-9", "6-10"], ["7-1:X", "7-2:X", "_", "7-3:X", "7-4:X", "7-5:X", "_", "7-6:X", "7-7:X", "7-8:X", "_", "7-9:X", "7-10:X"], ["8-1:X", "8-2:X", "_", "8-3:X", "8-4:X", "8-5:X", "_", "8-6:X", "8-7:X", "8-8:X", "_", "_", "DOOR"] ] },
            "high_orange": { name: "é«˜ä¸­æ©˜æ•™å®¤", layout: [ ["1-1:X", "1-2:X", "_", "1-3", "1-4", "1-5", "_", "1-6", "1-7", "1-8", "_", "1-9:X", "1-10:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8", "_", "2-9", "2-10"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8", "_", "3-9", "3-10"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8", "_", "4-9", "4-10"], ["5-1", "5-2", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "5-8", "_", "5-9", "5-10"], ["6-1", "6-2", "_", "6-3", "6-4", "6-5", "_", "6-6", "6-7", "6-8", "_", "6-9", "6-10"], ["_","_","_","_","_","_","_","_","_","_","_","_","DOOR"] ] },
            "high_green": { name: "é«˜ä¸­ç¶ æ•™å®¤", layout: [ ["1-1:X", "1-2", "_", "1-3", "1-4", "1-5", "_", "1-6:X", "1-7:X", "1-8:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8"], ["5-1", "5-2", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "5-8"], ["6-1:X", "6-2:X", "_", "6-3:X", "6-4:X", "6-5:X", "_", "_", "_", "DOOR"] ] },
            "high_yellow": { name: "é«˜ä¸­é»ƒæ•™å®¤", layout: [ ["1-1", "1-2:X", "_", "1-3", "1-4", "1-5", "_", "1-6:X", "1-7:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7"], ["DOOR", "_", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7"], ["_", "_", "_", "5-3:X", "5-4:X", "5-5:X", "_", "5-6:X", "5-7:X"], ["_", "_", "_", "_", "_", "_", "_", "_", "_"] ] },
            "high_blue": { name: "é«˜ä¸­è—æ•™å®¤", layout: [ ["1-1:X", "1-2", "_", "1-3", "1-4", "1-5", "_", "1-6:X", "1-7:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7"], ["5-1:X", "5-2:X", "_", "5-3:X", "5-4:X", "_", "_", "5-6:X", "5-7:X"], ["6-1:X", "6-2:X", "_", "_", "DOOR", "_", "_", "_", "_"] ] },
            "middle_new_orange": { name: "åœ‹ä¸­æ–°æ©˜æ•™å®¤", layout: [ ["1-1:X", "1-2", "_", "1-3", "1-4", "1-5", "_", "1-6", "1-7", "1-8:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8:X"], ["DOOR", "_", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "PILLAR"] ] },
            "middle_new_blue": { name: "åœ‹ä¸­æ–°è—æ•™å®¤", layout: [ ["1-1", "1-2", "1-3", "_", "1-4", "1-5", "1-6", "1-7:X"], ["2-1", "2-2", "2-3", "_", "2-4", "2-5", "2-6", "2-7:X"], ["3-1", "3-2", "3-3", "_", "3-4", "3-5", "3-6", "3-7:X"], ["4-1", "4-2", "4-3", "_", "4-4", "4-5", "4-6", "4-7:X"], ["5-1", "5-2", "5-3", "_", "5-4", "5-5", "5-6", "5-7:X"], ["6-1:X", "6-2:X", "6-3:X", "_", "6-4:X", "6-5:X", "6-6:X", "6-7:X"], ["7-1:X", "7-2:X", "7-3:X", "_", "7-4:X", "7-5:X", "7-6:X", "7-7:X"], ["DOOR", "_", "_", "_", "_", "_", "_", "_"] ] },
            "middle_new_yellow": { name: "åœ‹ä¸­æ–°é»ƒæ•™å®¤", layout: [ ["1-1:X", "1-2", "1-3", "_", "1-4", "1-5", "1-6", "_", "1-7", "1-8:X"], ["PILLAR", "2-2", "2-3", "_", "2-4", "2-5", "2-6", "_", "2-7", "2-8:X"], ["3-1:X", "3-2", "3-3", "_", "3-4", "3-5", "3-6", "_", "3-7", "3-8"], ["4-1", "4-2", "4-3", "_", "4-4", "4-5", "4-6", "_", "4-7", "4-8"], ["5-1", "5-2", "5-3", "_", "5-4", "5-5", "5-6", "_", "5-7", "5-8"], ["6-1:X", "6-2", "6-3", "_", "6-4", "6-5", "6-6", "_", "6-7", "6-8"], ["DOOR", "_", "_", "_", "_", "_", "_", "_", "_", "_"] ] },
            "middle_new_red": { name: "åœ‹ä¸­æ–°ç´…æ•™å®¤", layout: [ ["1-1", "1-2:X", "1-3", "_", "1-4", "1-5", "1-6", "1-7", "_", "1-8", "1-9:X", "1-10:X"], ["2-1", "2-2", "2-3", "_", "2-4", "2-5", "2-6", "2-7", "_", "2-8", "2-9", "2-10"], ["3-1", "3-2", "3-3", "_", "3-4", "3-5", "3-6", "3-7", "_", "3-8", "3-9", "3-10"], ["DOOR", "_", "_", "_", "_", "_", "_", "_", "_", "_", "_", "_"], ["4-1", "4-2", "4-3", "_", "4-4", "4-5", "4-6", "4-7", "_", "4-8", "4-9", "4-10"], ["5-1", "5-2", "5-3", "_", "5-4", "5-5", "5-6", "5-7", "_", "5-8", "5-9", "5-10"], ["6-1", "6-2", "6-3", "_", "6-4", "6-5", "6-6", "6-7", "_", "6-8", "6-9", "6-10"], ["7-1", "7-2", "7-3", "_", "7-4", "7-5", "7-6", "7-7", "_", "7-8", "7-9", "7-10"], ["8-1:X", "8-2:X", "8-3:X","_","8-4:X", "8-5:X", "8-6:X", "8-7:X", "_", "8-8:X", "8-9:X", "8-10:X"] ] },
            "middle_big_red": { name: "åœ‹ä¸­å¤§ç´…æ•™å®¤", layout: [ ["1-1:X", "1-2", "_", "1-3", "1-4", "1-5", "_", "1-6", "1-7", "1-8", "_", "1-9", "1-10:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8", "_", "2-9", "2-10"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8", "_", "3-9", "3-10"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8", "_", "4-9", "4-10"], ["5-1", "5-2", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "5-8", "_", "5-9", "5-10"], ["6-1", "6-2", "_", "6-3", "6-4", "6-5", "_", "6-6", "6-7", "6-8", "_", "6-9", "6-10"], ["7-1:X", "7-2:X", "_", "7-3:X", "7-4:X", "7-5:X", "_", "7-6:X", "7-7:X", "7-8:X", "_", "7-9:X", "7-10:X"], ["_","_","_","_","_","_","_","_","_","_","_","_","DOOR"] ] },
            "middle_big_orange": { name: "åœ‹ä¸­å¤§æ©˜æ•™å®¤", layout: [ ["1-1:X", "1-2:X", "1-3", "_", "1-4", "1-5", "1-6", "_", "1-7", "1-8:X"], ["2-1", "2-2", "2-3", "_", "2-4", "2-5", "2-6", "_", "2-7", "2-8"], ["3-1", "3-2", "3-3", "_", "3-4", "3-5", "3-6", "_", "3-7", "3-8"], ["4-1", "4-2", "4-3", "_", "4-4", "4-5", "4-6", "_", "4-7", "4-8"], ["5-1", "5-2", "5-3", "_", "5-4", "5-5", "5-6", "_", "_", "DOOR"] ] },
            "middle_big_green": { name: "åœ‹ä¸­å¤§ç¶ æ•™å®¤", layout: [ ["DOOR", "_", "_", "_", "_", "_"], ["1-1", "1-2", "1-3", "_", "1-4", "1-5"], ["2-1", "2-2", "2-3", "_", "2-4", "2-5"], ["3-1", "3-2", "3-3", "_", "3-4", "3-5"], ["PILLAR", "4-2", "4-3", "_", "4-4", "4-5"] ] },
            "test_room": { name: "æ¸¬è©¦å°ˆç”¨æ•™å®¤", layout: [ ["1-1", "1-2"] ] }
        };

        let allBookings = [];
        let coursesData = {};
        let waitlistData = {};
        let seatsData = {}; 
        let waitlistDisplayList = []; 
        let schoolMap = {}; 
        let printLayouts = {}; 

        let billStudents = [];
        let currentBillIndex = -1;

        let opCourseId = null;
        let opSeatId = null;
        let bookingSort = { col: 'time', asc: false };
        let waitlistSort = { col: 'timestamp', asc: true };

        let currentEditorLayout = []; 
        let isEditorLocked = false;   

        window.switchTab = function(tabName) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tabs button').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
            if (tabName === 'bills') initBillPage();
            if (tabName === 'print') initPrintPage(); 
        };
        window.showCourseForm = function() { 
            document.getElementById('courseListView').style.display = 'none'; 
            document.getElementById('courseFormView').style.display = 'block'; 
            resetForm(); 
            resetSeatEditor();
        };
        window.hideCourseForm = function() { document.getElementById('courseListView').style.display = 'block'; document.getElementById('courseFormView').style.display = 'none'; };
        window.previewImage = function(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { document.getElementById('imgPreview').src = e.target.result; document.getElementById('imgPreview').style.display = 'block'; }; reader.readAsDataURL(input.files[0]); } };
        
        const subjectsByGrade = {
            "å‡å°äº”èª²ç¨‹": ["å°äº”é‚è¼¯æ•¸å­¸"],
            "å‡å°å…­èª²ç¨‹": ["å°å…­è³‡å„ªè‡ªç„¶", "å°å…­è³‡å„ªæ•¸å­¸"],
            "å‡åœ‹ä¸€èª²ç¨‹": ["åœ‹ä¸€è‡ªç„¶è¶…å‰", "åœ‹ä¸€æ•¸å­¸è¶…å‰", "åœ‹ä¸€ç”Ÿç‰©", "åœ‹ä¸€æ•¸å­¸"],
            "å‡åœ‹äºŒèª²ç¨‹": ["åœ‹äºŒç†åŒ–"],
            "å‡åœ‹ä¸‰èª²ç¨‹": ["åœ‹ä¸‰è‡ªç„¶ç¸½è¤‡ç¿’", "åœ‹ä¸‰æ•¸å­¸ç¸½è¤‡ç¿’", "åœ‹ä¸‰è‹±æ–‡ç¸½è¤‡ç¿’", "åœ‹ä¸‰åœ‹æ–‡ç¸½è¤‡ç¿’", "åœ‹ä¸‰ç¤¾æœƒç¸½è¤‡ç¿’"],
            "å‡é«˜ä¸€èª²ç¨‹": ["é«˜ä¸€è‡ªç„¶ï¼ˆç‰©/åŒ–ï¼‰", "é«˜ä¸€ç²˜ç«‹ç‰©ç†", "é«˜ä¸€å‘¨é€¸åŒ–å­¸", "é«˜ä¸€é»ƒæµ©æ•¸å­¸", "é«˜ä¸€æ˜è»’æ•¸å­¸", "é«˜ä¸€ç«¹ä¸­æ•¸å­¸", "é«˜ä¸€å°æšè‹±æ–‡"],
            "å‡é«˜äºŒèª²ç¨‹": ["é«˜äºŒç²˜ç«‹ç‰©ç†", "é«˜äºŒå‘¨é€¸åŒ–å­¸", "é«˜äºŒé»ƒæµ©æ•¸å­¸", "é«˜äºŒæ˜è»’æ•¸å­¸", "é«˜äºŒç«¹ä¸­æ•¸å­¸", "é«˜äºŒå°æšè‹±æ–‡"],
            "å‡é«˜ä¸‰èª²ç¨‹": ["é«˜ä¸‰ç²˜ç«‹ç‰©ç†", "é«˜ä¸‰å‘¨é€¸åŒ–å­¸", "é«˜ä¸‰é»ƒæµ©æ•¸å­¸", "é«˜ä¸‰æ˜è»’æ•¸å­¸", "å­¸æ¸¬è‹±æ–‡", "å­¸æ¸¬é»ƒæµ©æ•¸å­¸", "å­¸æ¸¬æ˜è»’æ•¸å­¸", "å­¸æ¸¬è‡ªç„¶"]
        };
        window.updateSubjects = function() { const grade = document.getElementById('c_grade').value; const list = document.getElementById('subject_list'); list.innerHTML = ""; if (subjectsByGrade[grade]) { subjectsByGrade[grade].forEach(s => list.innerHTML += `<option value="${s}">`); } };
       window.autoFillTime = function() { 
            const type = document.getElementById('c_class_type').value; 
            const timeInput = document.getElementById('c_time_desc'); 
            
            if (type === "é€±ä¸€ã€å››ç­") {
                timeInput.value = "æ¯é€±ä¸€ã€å›› 16:50-18:20";
            } else if (type === "é€±äºŒã€äº”ç­") {
                timeInput.value = "æ¯é€±äºŒã€äº” 16:50-18:20";
            } else if (type === "é€±ä¸‰ã€å…­ç­") {
                timeInput.value = "æ¯é€±ä¸‰ 16:50-18:20 åŠ æ¯é€±å…­ 08:30-10:00";
            } else if (type === "é€±å…­ä¸Šåˆç­") {
                timeInput.value = "æ¯é€±å…­ 09:00-12:00";
            } else if (type === "é€±å…­ä¸‹åˆç­") {
                timeInput.value = "æ¯é€±å…­ 13:00-16:00";
            } else if (type === "é€±å…­æ™šä¸Šç­") {
                timeInput.value = "æ¯é€±å…­ 18:00-21:00";
            } else if (type === "é€±æ—¥ä¸Šåˆç­") {
                timeInput.value = "æ¯é€±æ—¥ 09:00-12:00";
            } else if (type === "é€±æ—¥ä¸‹åˆç­") {
                timeInput.value = "æ¯é€±æ—¥ 13:00-16:00";
            } else if (type === "é€±æ—¥æ™šä¸Šç­") {
                timeInput.value = "æ¯é€±æ—¥ 18:00-21:00";
            } 
            else if (type.includes("é€±")) { 
                const day = type.replace("ç­", "").replace("é€±", "æ¯é€±"); 
                timeInput.value = `${day} 18:30-21:30`; 
            } 
        };
        window.formatPrice = function(input) { let val = input.value.replace(/[^0-9]/g, ''); if (val) input.value = "$" + parseInt(val).toLocaleString(); };
        window.formatDate = function(input) { const val = input.value.trim(); if (/^\d{1,2}\/\d{1,2}$/.test(val)) { const [m, d] = val.split('/'); const date = new Date(2026, m - 1, d); const weekDay = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()]; const mm = m.padStart(2, '0'); const dd = d.padStart(2, '0'); input.value = `2026/${mm}/${dd} (${weekDay})`; } };

        const coursesRef = ref(db, 'courses');
        onValue(coursesRef, (snapshot) => {
            coursesData = snapshot.val() || {};
            renderCourseList();
            updateClassSelector(); 
            updateWaitlistSelector();
            updateDatalists();
            renderClassroomPreview();
        });

        function updateDatalists() {
            const subjects = new Set();
            Object.values(coursesData).forEach(c => {
                if(c.subject) subjects.add(c.subject);
            });
            const subList = document.getElementById('subject_list');
            subList.innerHTML = "";
            subjects.forEach(s => subList.innerHTML += `<option value="${s}">`);
        }

        window.resetSeatEditor = function() {
            if (isEditorLocked) {
                alert("ğŸ”’ æ­¤èª²ç¨‹å·²æœ‰å”®å‡ºç´€éŒ„ï¼Œç„¡æ³•é‡ç½®åº§ä½è¡¨ï¼");
                const courseId = document.getElementById('c_id').value;
                if (courseId && coursesData[courseId]) {
                    document.getElementById('c_classroom').value = coursesData[courseId].classroom;
                }
                return;
            }

            const classroomType = document.getElementById('c_classroom').value;
            const config = classrooms[classroomType];
            if (!config) return;

            currentEditorLayout = JSON.parse(JSON.stringify(config.layout));
            renderEditorGrid();
        };

        function renderEditorGrid() {
            const grid = document.getElementById('editorGrid');
            grid.innerHTML = "";

            currentEditorLayout.forEach((row, rIndex) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';
                row.forEach((code, cIndex) => {
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    
                    let displayCode = code;
                    if (code.includes(':X')) {
                        seat.classList.add('blocked');
                        displayCode = code.split(':')[0];
                    } else if (code === "_") {
                        seat.classList.add('aisle');
                    } else if (code === "DOOR") {
                        seat.classList.add('door');
                        seat.textContent = "é–€";
                    } else if (code === "PILLAR") {
                        seat.classList.add('pillar');
                        seat.textContent = "æŸ±";
                    } else {
                        seat.textContent = code;
                    }

                    if (!isEditorLocked) {
                        seat.onclick = () => toggleSeatType(rIndex, cIndex);
                    } else {
                        seat.style.cursor = "not-allowed";
                        seat.style.opacity = "0.7";
                    }
                    
                    rowDiv.appendChild(seat);
                });
                grid.appendChild(rowDiv);
            });
        }

        function toggleSeatType(r, c) {
            const currentCode = currentEditorLayout[r][c];
            let newCode = currentCode;

            if (currentCode === "_") {
                const classroomType = document.getElementById('c_classroom').value;
                const originalCode = classrooms[classroomType].layout[r][c];
                const baseId = (originalCode === "_" || originalCode === "DOOR" || originalCode === "PILLAR") ? `${r+1}-${c+1}` : originalCode.split(':')[0];
                newCode = `${baseId}:X`;
            } 
            else if (currentCode.includes(":X")) {
                newCode = "PILLAR";
            }
            else if (currentCode === "PILLAR") {
                newCode = "DOOR";
            }
            else if (currentCode === "DOOR") {
                const classroomType = document.getElementById('c_classroom').value;
                const originalCode = classrooms[classroomType].layout[r][c];
                const baseId = (originalCode === "_" || originalCode === "DOOR" || originalCode === "PILLAR") ? `${r+1}-${c+1}` : originalCode.split(':')[0];
                newCode = baseId;
            }
            else {
                newCode = "_";
            }

            currentEditorLayout[r][c] = newCode;
            renderEditorGrid();
        }

        window.saveCourse = async function() {
            const btn = document.getElementById('btnSave');
            let pwd = document.getElementById('adminPwd').value.trim();
            
            if (!pwd) { 
                pwd = prompt("âš ï¸ æ‚¨å°šæœªè¼¸å…¥å¯†ç¢¼ï¼\nè«‹ç›´æ¥åœ¨æ­¤è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨å¡«å…¥ä¸Šæ–¹ï¼š");
                if (!pwd || !pwd.trim()) {
                    return; 
                }
                pwd = pwd.trim();
                document.getElementById('adminPwd').value = pwd; 
            }

            btn.disabled = true;
            btn.textContent = "è™•ç†ä¸­...";

            try {
                const id = document.getElementById('c_id').value;
                const descContent = tinymce.get('c_desc').getContent();
                const grade = document.getElementById('c_grade').value;
                const subject = document.getElementById('c_subject').value;
                const classType = document.getElementById('c_class_type').value;
                const teacher = document.getElementById('c_teacher').value;
                const classroom = document.getElementById('c_classroom').value;
                const start1 = document.getElementById('c_start1').value;
                const end1 = document.getElementById('c_end1').value;
                const start2 = document.getElementById('c_start2').value;
                const end2 = document.getElementById('c_end2').value;
                const price = document.getElementById('c_price').value;
                const lessons = document.getElementById('c_lessons').value;
                const timeDesc = document.getElementById('c_time_desc').value;
                const startDate = document.getElementById('c_start_date').value;
                const displayStart = document.getElementById('c_display_start').value;
                const displayEnd = document.getElementById('c_display_end').value;
                const fileInput = document.getElementById('c_image_file');
                const oldImageUrl = document.getElementById('c_image_url').value;
                
                const waitlistEnabled = document.getElementById('c_waitlist_enabled').checked;
                const waitlistLimit = document.getElementById('c_waitlist_limit').value;

                if (!grade || !subject || !start1) throw new Error("è«‹å¡«å¯«å®Œæ•´è³‡æ–™ï¼");

                let totalSeats = 0;
                currentEditorLayout.forEach(row => {
                    row.forEach(seatCode => {
                        if (seatCode !== "_" && seatCode !== "DOOR" && seatCode !== "PILLAR" && !seatCode.includes(":X")) {
                            totalSeats++;
                        }
                    });
                });

                let imageUrl = oldImageUrl || "https://via.placeholder.com/400x200?text=No+Image";
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const storagePath = `course_images/${Date.now()}_${file.name}`;
                    const imgRef = storageRef(storage, storagePath);
                    document.getElementById('uploadStatus').textContent = "ä¸Šå‚³åœ–ç‰‡ä¸­...";
                    const metadata = { contentType: file.type };
                    await uploadBytes(imgRef, file, metadata);
                    imageUrl = await getDownloadURL(imgRef);
                }

                const courseData = {
                    grade, subject, classType, teacher, classroom,
                    start1, end1, start2, end2, price, lessons,
                    timeDescription: timeDesc, startDate: startDate,
                    displayStart, displayEnd, desc: descContent, 
                    image: imageUrl, updatedAt: Date.now(),
                    waitlistEnabled: waitlistEnabled,
                    waitlistLimit: parseInt(waitlistLimit) || 0,
                    totalSeats: totalSeats,
                    layout: currentEditorLayout,
                    adminPwd: pwd
                };

                let courseId = id;
                if (id) {
                    await update(ref(db, `courses/${id}`), courseData);
                    alert("âœ… èª²ç¨‹æ›´æ–°æˆåŠŸï¼åº§ä½è¡¨å·²åŒæ­¥æ›´æ–°ã€‚");
                } else {
                    const newRef = push(coursesRef);
                    courseId = newRef.key;
                    courseData.createdAt = Date.now();
                    await set(newRef, courseData);
                    alert("âœ… èª²ç¨‹æ–°å¢æˆåŠŸï¼åº§ä½è¡¨å·²å»ºç«‹ã€‚");
                }

                const start1Time = new Date(start1).getTime();
                const end1Time = end1 ? new Date(end1).getTime() : 9999999999999;
                const start2Time = start2 ? new Date(start2).getTime() : 9999999999999;
                const end2Time = end2 ? new Date(end2).getTime() : 9999999999999;

                await set(ref(db, `seats/${courseId}/_settings`), {
                    start1: start1Time, 
                    end1: end1Time, 
                    start2: start2Time,
                    end2: end2Time,
                    adminPwd: pwd
                });

                hideCourseForm();

            } catch (err) {
                alert("éŒ¯èª¤ï¼š" + err.message);
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.textContent = id ? "ç¢ºèªæ›´æ–°èª²ç¨‹" : "ç¢ºèªæ–°å¢èª²ç¨‹";
            }
        };

        window.editCourse = function(key) {
            const c = coursesData[key];
            showCourseForm();
            document.getElementById('formTitle').textContent = "âœï¸ ç·¨è¼¯èª²ç¨‹";
            document.getElementById('btnSave').textContent = "ç¢ºèªæ›´æ–°èª²ç¨‹";
            
            document.getElementById('c_id').value = key;
            document.getElementById('c_grade').value = c.grade;
            document.getElementById('c_subject').value = c.subject;
            document.getElementById('c_class_type').value = c.classType || "";
            document.getElementById('c_teacher').value = c.teacher;
            document.getElementById('c_classroom').value = c.classroom;
            document.getElementById('c_start1').value = c.start1;
            document.getElementById('c_end1').value = c.end1 || "";
            document.getElementById('c_start2').value = c.start2 || "";
            document.getElementById('c_end2').value = c.end2 || "";
            document.getElementById('c_price').value = c.price;
            document.getElementById('c_lessons').value = c.lessons || "12";
            document.getElementById('c_time_desc').value = c.timeDescription || "";
            document.getElementById('c_start_date').value = c.startDate || "";
            document.getElementById('c_display_start').value = c.displayStart || "";
            document.getElementById('c_display_end').value = c.displayEnd || "";
            document.getElementById('c_image_url').value = c.image;
            
            document.getElementById('c_waitlist_enabled').checked = c.waitlistEnabled || false;
            document.getElementById('c_waitlist_limit').value = c.waitlistLimit || 0;

            tinymce.get('c_desc').setContent(c.desc);
            
            const img = document.getElementById('imgPreview');
            img.src = c.image;
            img.style.display = 'block';

            const courseSeats = seatsData[key] || {};
            let hasSold = false;
            Object.values(courseSeats).forEach(s => {
                if (s.status === 'sold') hasSold = true;
            });

            isEditorLocked = hasSold;
            const lockMsg = document.getElementById('editorLockMsg');
            const classroomSelect = document.getElementById('c_classroom');
            
            if (hasSold) {
                lockMsg.style.display = 'block';
                classroomSelect.disabled = true; 
            } else {
                lockMsg.style.display = 'none';
                classroomSelect.disabled = false;
            }

            if (c.layout) {
                currentEditorLayout = JSON.parse(JSON.stringify(c.layout));
            } else {
                const config = classrooms[c.classroom];
                if (config) {
                    currentEditorLayout = JSON.parse(JSON.stringify(config.layout));
                }
            }
            renderEditorGrid();
        };

        window.resetForm = function() {
            document.getElementById('formTitle').textContent = "â• æ–°å¢èª²ç¨‹";
            document.getElementById('btnSave').textContent = "ç¢ºèªæ–°å¢èª²ç¨‹";
            document.querySelectorAll('input').forEach(i => i.value = '');
            document.getElementById('c_lessons').value = "12";
            document.getElementById('c_price').value = "21600"; 
            document.getElementById('c_waitlist_enabled').checked = false; 
            document.getElementById('c_waitlist_limit').value = "0"; 
            tinymce.get('c_desc').setContent('');
            document.getElementById('uploadStatus').textContent = "";
            document.getElementById('imgPreview').style.display = 'none';
            
            isEditorLocked = false;
            document.getElementById('editorLockMsg').style.display = 'none';
            document.getElementById('c_classroom').disabled = false;
        };

        function renderCourseList() {
            // â˜…â˜…â˜… é˜²é–ƒçˆæ©Ÿåˆ¶ â˜…â˜…â˜…
            const newDataStr = JSON.stringify(coursesData);
            if (currentCourseListStr === newDataStr) return;
            currentCourseListStr = newDataStr;

            const listDiv = document.getElementById('courseList');
            listDiv.innerHTML = "";
            Object.keys(coursesData).forEach(key => {
                const c = coursesData[key];
                const card = document.createElement('div');
                card.className = 'admin-course-card';
                card.onclick = (e) => { if(!e.target.classList.contains('btn-delete')) editCourse(key); };
                card.innerHTML = `
                    <div class="card-thumb" style="background-image: url('${c.image}');"></div>
                    <div class="card-content">
                        <h3>[${c.grade}] ${c.subject} ${c.classType || ''}</h3>
                        <p>ğŸ‘¨â€ğŸ« ${c.teacher} | â° ${c.timeDescription || '-'}</p>
                    </div>
                    <button class="btn-delete" onclick="window.deleteCourse('${key}')">åˆªé™¤</button>
                `;
                listDiv.appendChild(card);
            });
        }

        window.deleteCourse = function(courseId) {
            let pwd = document.getElementById('adminPwd').value.trim();
            if (!pwd) { 
                pwd = prompt("âš ï¸ æ‚¨å°šæœªè¼¸å…¥å¯†ç¢¼ï¼\nè«‹ç›´æ¥åœ¨æ­¤è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨å¡«å…¥ä¸Šæ–¹ï¼š");
                if (!pwd || !pwd.trim()) return;
                pwd = pwd.trim();
                document.getElementById('adminPwd').value = pwd; 
            }
            if (confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤ï¼Ÿ")) remove(ref(db, `courses/${courseId}`));
        };

        const allSeatsRef = ref(db, 'seats');
        onValue(allSeatsRef, (snapshot) => {
            seatsData = snapshot.val() || {}; 
            allBookings = [];
            Object.keys(seatsData).forEach(courseId => {
                const seats = seatsData[courseId];
                const c = coursesData[courseId];
                const courseName = c ? `[${c.grade}] ${c.subject} ${c.classType || ''}` : courseId;
                Object.keys(seats).forEach(seatId => {
                    if (seatId === '_settings') return;
                    const info = seats[seatId];
                    if (info.status === 'sold' || info.status === 'locked' || info.status === 'deleted') { 
                        allBookings.push({
                            courseId, courseName, seatId, status: info.status,
                            studentName: info.studentName || '-', parentPhone: info.parentPhone || '-',
                            time: info.soldTime || '-', rawTime: info.timestamp,
                            orderId: info.orderId || '-'
                        });
                    }
                });
            });
            renderTable();
            updateStats();
            loadVisualMap();
        });

        window.sortBookingTable = function(col) {
            if (bookingSort.col === col) bookingSort.asc = !bookingSort.asc;
            else { bookingSort.col = col; bookingSort.asc = true; }
            renderTable();
        };

        function renderTable() {
            const filterId = document.getElementById('classSelector').value;
            const searchText = document.getElementById('searchInput').value.trim().toLowerCase();
            const tbody = document.getElementById('bookingTable');
            tbody.innerHTML = "";
            
            let displayList = allBookings.filter(b => {
                if (filterId !== 'all' && b.courseId !== filterId) return false;
                if (searchText && !b.studentName.includes(searchText) && !b.parentPhone.includes(searchText) && !b.orderId.includes(searchText)) return false;
                return true;
            });

            displayList.sort((a, b) => {
                let valA = a[bookingSort.col] || '';
                let valB = b[bookingSort.col] || '';
                if (bookingSort.col === 'time') { 
                    valA = a.rawTime || Date.parse(a.time) || 0; 
                    valB = b.rawTime || Date.parse(b.time) || 0; 
                }
                if (valA < valB) return bookingSort.asc ? -1 : 1;
                if (valA > valB) return bookingSort.asc ? 1 : -1;
                return 0;
            });

            const nameCounts = {};
            const phoneCounts = {};
            displayList.forEach(b => {
                if (b.status === 'sold') {
                    nameCounts[b.studentName] = (nameCounts[b.studentName] || 0) + 1;
                    phoneCounts[b.parentPhone] = (phoneCounts[b.parentPhone] || 0) + 1;
                }
            });

            displayList.forEach(b => {
                const tr = document.createElement('tr');
                let statusBadge = '';
                let btnText = 'é‡‹å‡º';
                let btnClass = 'danger';
                
                if (b.status === 'sold') {
                    statusBadge = '<span class="badge sold">å·²åŠƒä½</span>';
                    if (nameCounts[b.studentName] > 1 || phoneCounts[b.parentPhone] > 1) {
                        tr.classList.add('duplicate-row');
                    }
                } else if (b.status === 'locked') {
                    statusBadge = '<span class="badge locked">å¡«å¯«ä¸­</span>';
                } else if (b.status === 'deleted') {
                    statusBadge = '<span class="badge deleted">å·²é‡‹å‡º</span>';
                    tr.classList.add('row-deleted'); 
                    btnText = 'æ°¸ä¹…åˆªé™¤';
                    btnClass = 'dark'; 
                }
                
                tr.innerHTML = `<td>${b.orderId}</td><td>${b.courseName}</td><td>${b.time}</td><td>${statusBadge}</td><td>${b.seatId}</td><td>${b.studentName}</td><td>${b.parentPhone}</td>
                <td>
                    <button class="warning" style="padding:5px 10px; font-size:12px;" onclick="window.editOrder('${b.courseId}', '${b.seatId}', '${b.parentPhone}', '${b.orderId}', '${b.studentName}')">ç·¨è¼¯</button>
                    <button class="${btnClass}" style="padding:5px 10px; font-size:12px;" onclick="window.releaseSeat('${b.courseId}', '${b.seatId}', '${b.status}')">${btnText}</button>
                </td>`;
                tbody.appendChild(tr);
            });
        }

        window.loadVisualMap = function() {
            const courseId = document.getElementById('classSelector').value;
            const mapContainer = document.getElementById('visualMap');
            const mapContent = document.getElementById('mapContent');
            
            if (courseId === 'all' || !coursesData[courseId]) {
                mapContainer.style.display = 'none';
                return;
            }

            mapContainer.style.display = 'block';
            mapContent.innerHTML = "";
            
            const c = coursesData[courseId];
            let layoutToRender = [];
            
            if (c.layout) {
                layoutToRender = c.layout;
            } else {
                const config = classrooms[c.classroom];
                if (config) layoutToRender = config.layout;
            }

            const currentSeats = seatsData[courseId] || {};

            if (layoutToRender && layoutToRender.length > 0) {
                layoutToRender.forEach(row => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'row';
                    row.forEach(seatCode => {
                        const seat = document.createElement('div');
                        seat.className = 'seat';
                        let code = seatCode;
                        let isBlocked = false;
                        if (seatCode.includes(':X')) { code = seatCode.split(':')[0]; isBlocked = true; }

                        if (code === "_") seat.classList.add('aisle');
                        else if (code === "DOOR") { seat.textContent = "é–€"; seat.classList.add('aisle'); }
                        else if (code === "PILLAR") { seat.textContent = "æŸ±"; seat.classList.add('aisle'); }
                        else {
                            seat.textContent = code;
                            const info = currentSeats[code];
                            
                            if (info) {
                                if (info.status === 'sold') {
                                    seat.classList.add('sold');
                                    seat.innerHTML += `<div class="seat-tooltip">${info.studentName}<br>${info.parentPhone}</div>`;
                                } else if (info.status === 'locked') {
                                    seat.classList.add('locked');
                                    if (info.user === 'admin_reserved') {
                                        seat.classList.add('reserved'); 
                                        seat.innerHTML += `<div class="seat-tooltip">ä¿ç•™ä½</div>`;
                                    } else {
                                        seat.innerHTML += `<div class="seat-tooltip">å¡«å¯«ä¸­...</div>`;
                                    }
                                }
                            }
                            
                            seat.onclick = () => toggleReserve(courseId, code, info);
                        }
                        rowDiv.appendChild(seat);
                    });
                    mapContent.appendChild(rowDiv);
                });
            }
        };

        window.toggleReserve = async function(courseId, seatId, info) {
            let pwd = document.getElementById('adminPwd').value.trim();
            if (!pwd) { 
                pwd = prompt("âš ï¸ æ‚¨å°šæœªè¼¸å…¥å¯†ç¢¼ï¼\nè«‹ç›´æ¥åœ¨æ­¤è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨å¡«å…¥ä¸Šæ–¹ï¼š");
                if (!pwd || !pwd.trim()) return;
                pwd = pwd.trim();
                document.getElementById('adminPwd').value = pwd; 
            }

            if (info && info.status === 'sold') {
                if (confirm(`ç¢ºå®šè¦é‡‹å‡º ${seatId} (${info.studentName}) å—ï¼Ÿ`)) {
                    update(ref(db, `seats/${courseId}/${seatId}`), {
                        status: 'deleted',
                        adminPwd: pwd
                    });
                }
            } else if (info && info.status === 'locked' && info.user === 'admin_reserved') {
                openOpModal(courseId, seatId);
            } else if (!info || (info && info.status === 'deleted')) {
                const snap = await get(ref(db, `seats/${courseId}/${seatId}`));
                if (snap.exists() && snap.val().status === 'sold') {
                     if (!confirm("âš ï¸ è­¦å‘Šï¼šé€™å€‹ä½å­å‰›å‰›è¢«å­¸ç”Ÿæ¶èµ°äº†ï¼ç¢ºå®šè¦å¼·åˆ¶è¦†è“‹å—ï¼Ÿ")) return;
                }

                if (confirm(`è¦å°‡ ${seatId} è¨­ç‚ºä¿ç•™ä½å—ï¼Ÿ(å‰å°é¡¯ç¤ºç‚ºå¡«å¯«ä¸­)`)) {
                    set(ref(db, `seats/${courseId}/${seatId}`), {
                        status: 'locked',
                        user: 'admin_reserved',
                        timestamp: Date.now(),
                        adminPwd: pwd 
                    }).catch(err => {
                        alert("ä¿ç•™å¤±æ•—ï¼šå¯†ç¢¼éŒ¯èª¤æˆ–æ¬Šé™ä¸è¶³ï¼");
                    });
                }
            }
        };

        window.openOpModal = function(courseId, seatId) {
            opCourseId = courseId;
            opSeatId = seatId;
            document.getElementById('opTarget').textContent = `åº§ä½ï¼š${seatId}`;
            document.getElementById('opModal').style.display = 'flex';
        };

        window.closeOpModal = function() {
            document.getElementById('opModal').style.display = 'none';
            opCourseId = null;
            opSeatId = null;
        };

        window.confirmOpRelease = function() {
            if (!opCourseId || !opSeatId) return;
            set(ref(db, `seats/${opCourseId}/${opSeatId}`), null).then(() => {
                closeOpModal();
            });
        };

        window.confirmOpSell = function() {
            if (!opCourseId || !opSeatId) return;
            let pwd = document.getElementById('adminPwd').value.trim();
            if (!pwd) { 
                pwd = prompt("âš ï¸ æ‚¨å°šæœªè¼¸å…¥å¯†ç¢¼ï¼\nè«‹ç›´æ¥åœ¨æ­¤è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨å¡«å…¥ä¸Šæ–¹ï¼š");
                if (!pwd || !pwd.trim()) return;
                pwd = pwd.trim();
                document.getElementById('adminPwd').value = pwd; 
            }
            
            const name = prompt("è«‹è¼¸å…¥å­¸ç”Ÿå§“å (ç•™ç©ºå‰‡ç‚º'ç¾å ´ä¿ç•™')", "ç¾å ´ä¿ç•™");
            const phone = prompt("è«‹è¼¸å…¥å®¶é•·é›»è©± (ç•™ç©ºå‰‡ç‚º'0000000000')", "0000000000");
            
            const orderId = "ADMIN_" + Date.now();
            const seatData = {
                status: 'sold',
                studentName: name,
                parentPhone: phone,
                soldTime: new Date().toLocaleString(),
                timestamp: Date.now(), 
                orderId: orderId,
                adminPwd: pwd 
            };
            
            set(ref(db, `seats/${opCourseId}/${opSeatId}`), seatData).then(() => {
                alert("å·²æˆåŠŸè½‰ç‚ºå·²å”®å‡ºï¼");
                closeOpModal();
            }).catch(err => alert("å¤±æ•—ï¼š" + err.message));
        };

        function updateClassSelector() {
            // â˜…â˜…â˜… é˜²é–ƒçˆæ©Ÿåˆ¶ (åªæ¯”å°é¸é …å…§å®¹) â˜…â˜…â˜…
            const optionsData = Object.keys(coursesData).map(k => `${k}-${coursesData[k].grade}-${coursesData[k].subject}-${coursesData[k].classType}`).join('|');
            if (currentClassSelectorStr === optionsData) return;
            currentClassSelectorStr = optionsData;

            const selector = document.getElementById('classSelector');
            const currentVal = selector.value;
            selector.innerHTML = '<option value="all">å…¨éƒ¨èª²ç¨‹ç¸½è¦½</option>';
            Object.keys(coursesData).forEach(key => {
                const c = coursesData[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `[${c.grade}] ${c.subject} ${c.classType || ''}`;
                selector.appendChild(option);
            });
            selector.value = currentVal;
        }

        window.releaseSeat = function(courseId, seatId, currentStatus) {
            let pwd = document.getElementById('adminPwd').value.trim();
            if (!pwd) { 
                pwd = prompt("âš ï¸ æ‚¨å°šæœªè¼¸å…¥å¯†ç¢¼ï¼\nè«‹ç›´æ¥åœ¨æ­¤è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨å¡«å…¥ä¸Šæ–¹ï¼š");
                if (!pwd || !pwd.trim()) return;
                pwd = pwd.trim();
                document.getElementById('adminPwd').value = pwd; 
            }

            if (currentStatus === 'deleted') {
                if (confirm("âš ï¸ ç¢ºå®šè¦ã€æ°¸ä¹…åˆªé™¤ã€‘æ­¤ç´€éŒ„å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚")) {
                    set(ref(db, `seats/${courseId}/${seatId}`), null); 
                }
            } else {
                if (confirm("ç¢ºå®šé‡‹å‡ºåº§ä½ï¼Ÿ(è³‡æ–™å°‡ä¿ç•™ä¸¦æ¨™è¨˜ç‚ºå·²é‡‹å‡º)")) {
                    update(ref(db, `seats/${courseId}/${seatId}`), {
                        status: 'deleted', 
                        adminPwd: pwd
                    });
                }
            }
        };

        window.editOrder = async function(courseId, seatId, oldPhone, orderId, oldName) {
            let pwd = document.getElementById('adminPwd').value.trim();
            if (!pwd) { 
                pwd = prompt("âš ï¸ æ‚¨å°šæœªè¼¸å…¥å¯†ç¢¼ï¼\nè«‹ç›´æ¥åœ¨æ­¤è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨å¡«å…¥ä¸Šæ–¹ï¼š");
                if (!pwd || !pwd.trim()) return;
                pwd = pwd.trim();
                document.getElementById('adminPwd').value = pwd; 
            }

            const newName = prompt("ä¿®æ”¹å­¸ç”Ÿå§“åï¼š", oldName);
            if (newName === null) return;
            const newPhone = prompt("ä¿®æ”¹å®¶é•·é›»è©± (è‹¥ä¿®æ”¹é›»è©±ï¼Œç³»çµ±å°‡è‡ªå‹•æ¬ç§»è¨‚å–®)ï¼š", oldPhone);
            if (newPhone === null) return;

            try {
                const seatUpdate = {
                    studentName: newName,
                    parentPhone: newPhone,
                    adminPwd: pwd
                };
                await update(ref(db, `seats/${courseId}/${seatId}`), seatUpdate);

                if (newPhone !== oldPhone) {
                    const oldOrderRef = ref(db, `orders/${oldPhone}/${orderId}`);
                    const snap = await get(oldOrderRef);
                    if (snap.exists()) {
                        const orderData = snap.val();
                        orderData.studentName = newName;
                        orderData.parentPhone = newPhone;
                        orderData.adminPwd = pwd;
                        await set(ref(db, `orders/${newPhone}/${orderId}`), orderData);
                        await remove(oldOrderRef);
                    }
                } else {
                    await update(ref(db, `orders/${oldPhone}/${orderId}`), { 
                        studentName: newName,
                        adminPwd: pwd
                    });
                }
                alert("ä¿®æ”¹æˆåŠŸï¼");
            } catch (err) {
                alert("ä¿®æ”¹å¤±æ•—ï¼š" + err.message);
                console.error(err);
            }
        };

        function updateStats() {
            document.getElementById('totalSold').textContent = allBookings.filter(b => b.status === 'sold').length;
        }

        window.exportBookingCSV = function() {
            let pwd = document.getElementById('adminPwd').value.trim();
            if (!pwd) { 
                pwd = prompt("âš ï¸ æ‚¨å°šæœªè¼¸å…¥å¯†ç¢¼ï¼\nè«‹ç›´æ¥åœ¨æ­¤è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨å¡«å…¥ä¸Šæ–¹ï¼š");
                if (!pwd || !pwd.trim()) return;
                pwd = pwd.trim();
                document.getElementById('adminPwd').value = pwd; 
            }

            const filterId = document.getElementById('classSelector').value;
            let csv = "\uFEFFè¨‚å–®ç·¨è™Ÿ,èª²ç¨‹,æ™‚é–“,ç‹€æ…‹,åº§ä½,å§“å,é›»è©±\n";
            allBookings.forEach(b => {
                if (filterId !== 'all' && b.courseId !== filterId) return;
                let statusText = b.status === 'sold' ? 'å·²åŠƒä½' : (b.status === 'deleted' ? 'å·²é‡‹å‡º' : 'å¡«å¯«ä¸­');
                csv += `'${b.orderId},${b.courseName},${b.time},${statusText},${b.seatId},${b.studentName},'${b.parentPhone}\n`;
            });
            downloadCSV(csv, "booking_data.csv");
        };

        window.exportWaitlistCSV = function() {
            let pwd = document.getElementById('adminPwd').value.trim();
            if (!pwd) { 
                pwd = prompt("âš ï¸ æ‚¨å°šæœªè¼¸å…¥å¯†ç¢¼ï¼\nè«‹ç›´æ¥åœ¨æ­¤è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨å¡«å…¥ä¸Šæ–¹ï¼š");
                if (!pwd || !pwd.trim()) return;
                pwd = pwd.trim();
                document.getElementById('adminPwd').value = pwd; 
            }

            const filterId = document.getElementById('waitlistSelector').value;
            let csv = "\uFEFFèª²ç¨‹,ç™»è¨˜æ™‚é–“,ç‹€æ…‹,åºè™Ÿ,å§“å,é›»è©±,å‚™è¨»\n";
            
            const list = waitlistData[filterId] || {};
            const c = coursesData[filterId];
            const courseName = c ? `[${c.grade}] ${c.subject} ${c.classType || ''}` : filterId;
            
            let exportList = Object.keys(list).map(key => ({ ...list[key], key, courseName }));
            const activeItems = exportList.filter(w => w.status !== 'deleted');
            activeItems.sort((a, b) => a.timestamp - b.timestamp);
            const rankMap = {};
            activeItems.forEach((item, index) => { rankMap[item.key] = index + 1; });

            exportList.forEach(w => {
                let seq = rankMap[w.key] || '-';
                let statusText = w.status === 'deleted' ? 'å·²åˆªé™¤' : 'å€™è£œä¸­';
                csv += `${w.courseName},${new Date(w.timestamp).toLocaleString()},${statusText},${seq},${w.studentName},'${w.parentPhone},${w.note || ''}\n`;
            });
            downloadCSV(csv, "waitlist_data.csv");
        };

        function downloadCSV(content, fileName) {
            const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
        }

        document.getElementById('classSelector').addEventListener('change', () => {
            const sel = document.getElementById('classSelector');
            document.getElementById('currentClassName').textContent = sel.options[sel.selectedIndex].text;
            renderTable();
            loadVisualMap();
        });
        document.getElementById('searchInput').addEventListener('input', renderTable);

        const bannersRef = ref(db, 'banners');
        onValue(bannersRef, (snapshot) => {
            const data = snapshot.val() || {};
            const list = document.getElementById('bannerList');
            list.innerHTML = "";
            Object.keys(data).forEach(key => {
                const b = data[key];
                const item = document.createElement('div');
                item.className = 'banner-item';
                item.innerHTML = `<img src="${b.url}"><button class="btn-delete" onclick="window.deleteBanner('${key}')">åˆªé™¤</button>`;
                list.appendChild(item);
            });
        });

        window.uploadBanner = async function() {
            let pwd = document.getElementById('adminPwd').value.trim();
            if (!pwd) { 
                pwd = prompt("âš ï¸ æ‚¨å°šæœªè¼¸å…¥å¯†ç¢¼ï¼\nè«‹ç›´æ¥åœ¨æ­¤è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨å¡«å…¥ä¸Šæ–¹ï¼š");
                if (!pwd || !pwd.trim()) return;
                pwd = pwd.trim();
                document.getElementById('adminPwd').value = pwd; 
            }
            const fileInput = document.getElementById('b_file');
            if (fileInput.files.length === 0) return alert("è«‹é¸æ“‡åœ–ç‰‡");
            const file = fileInput.files[0];
            const storagePath = `banners/${Date.now()}_${file.name}`;
            const imgRef = storageRef(storage, storagePath);
            document.getElementById('bannerStatus').textContent = "ä¸Šå‚³ä¸­...";
            const metadata = { contentType: file.type };
            await uploadBytes(imgRef, file, metadata);
            const url = await getDownloadURL(imgRef);
            await push(bannersRef, { url: url, createdAt: Date.now(), adminPwd: pwd });
            document.getElementById('bannerStatus').textContent = "";
            fileInput.value = "";
        };

        window.deleteBanner = function(key) {
            let pwd = document.getElementById('adminPwd').value.trim();
            if (!pwd) { 
                pwd = prompt("âš ï¸ æ‚¨å°šæœªè¼¸å…¥å¯†ç¢¼ï¼\nè«‹ç›´æ¥åœ¨æ­¤è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨å¡«å…¥ä¸Šæ–¹ï¼š");
                if (!pwd || !pwd.trim()) return;
                pwd = pwd.trim();
                document.getElementById('adminPwd').value = pwd; 
            }
            if (confirm("ç¢ºå®šåˆªé™¤æ­¤æ©«å¹…ï¼Ÿ")) remove(ref(db, `banners/${key}`));
        };

        const waitlistRef = ref(db, 'waitlist');
        onValue(waitlistRef, (snapshot) => {
            waitlistData = snapshot.val() || {};
            updateWaitlistSelector();
            renderWaitlistTable();
        });

        function updateWaitlistSelector() {
            // â˜…â˜…â˜… é˜²é–ƒçˆæ©Ÿåˆ¶ (åªæ¯”å°é¸é …å…§å®¹) â˜…â˜…â˜…
            const optionsData = Object.keys(coursesData).map(k => `${k}-${coursesData[k].grade}-${coursesData[k].subject}-${coursesData[k].classType}`).join('|');
            if (currentWaitlistSelectorStr === optionsData) return;
            currentWaitlistSelectorStr = optionsData;

            const selector = document.getElementById('waitlistSelector');
            const currentVal = selector.value;
            selector.innerHTML = '<option value="all">é¸æ“‡èª²ç¨‹æŸ¥çœ‹å€™è£œ</option>';
            Object.keys(coursesData).forEach(key => {
                const c = coursesData[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `[${c.grade}] ${c.subject} ${c.classType || ''}`;
                selector.appendChild(option);
            });
            selector.value = currentVal;
        }

        window.sortWaitlistTable = function(col) {
            if (waitlistSort.col === col) waitlistSort.asc = !waitlistSort.asc;
            else { waitlistSort.col = col; waitlistSort.asc = true; }
            renderWaitlistTable();
        };

        function renderWaitlistTable() {
            const filterId = document.getElementById('waitlistSelector').value;
            const tbody = document.getElementById('waitlistTable');
            tbody.innerHTML = "";
            
            waitlistDisplayList = [];
            
            if (filterId === 'all') {
                tbody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>è«‹é¸æ“‡ç‰¹å®šèª²ç¨‹ä»¥æŸ¥çœ‹æ’åºèˆ‡åºè™Ÿ</td></tr>";
                return;
            }

            const list = waitlistData[filterId] || {};
            const c = coursesData[filterId];
            const courseName = c ? `[${c.grade}] ${c.subject} ${c.classType || ''}` : filterId;

            waitlistDisplayList = Object.keys(list).map(key => ({ 
                ...list[key], 
                key, 
                courseName 
            }));

            const activeItems = waitlistDisplayList.filter(w => w.status !== 'deleted');
            activeItems.sort((a, b) => a.timestamp - b.timestamp);
            const rankMap = {};
            activeItems.forEach((item, index) => {
                rankMap[item.key] = index + 1;
            });

            waitlistDisplayList.sort((a, b) => {
                if (waitlistSort.col === 'seq') {
                    const rankA = rankMap[a.key] || 999999;
                    const rankB = rankMap[b.key] || 999999;
                    return waitlistSort.asc ? rankA - rankB : rankB - rankA;
                }
                
                let valA = a[waitlistSort.col] || '';
                let valB = b[waitlistSort.col] || '';
                if (valA < valB) return waitlistSort.asc ? -1 : 1;
                if (valA > valB) return waitlistSort.asc ? 1 : -1;
                return 0;
            });

            const nameCounts = {};
            const phoneCounts = {};
            waitlistDisplayList.forEach(w => {
                if (w.status !== 'deleted') {
                    nameCounts[w.studentName] = (nameCounts[w.studentName] || 0) + 1;
                    phoneCounts[w.parentPhone] = (phoneCounts[w.parentPhone] || 0) + 1;
                }
            });

            waitlistDisplayList.forEach(w => {
                const tr = document.createElement('tr');
                const time = new Date(w.timestamp).toLocaleString();
                
                let btnText = 'åˆªé™¤';
                let btnClass = 'danger';
                let statusBadge = '<span class="badge wait">å€™è£œä¸­</span>';
                let seqDisplay = rankMap[w.key] || '-';
                
                if (w.status === 'deleted') {
                    tr.classList.add('row-deleted'); 
                    btnText = 'æ°¸ä¹…åˆªé™¤';
                    btnClass = 'dark';
                    statusBadge = '<span class="badge deleted">å·²åˆªé™¤</span>';
                } else {
                    if (nameCounts[w.studentName] > 1 || phoneCounts[w.parentPhone] > 1) {
                        tr.classList.add('duplicate-row');
                    }
                }

                tr.innerHTML = `
                    <td>${courseName}</td>
                    <td>${time}</td>
                    <td>${statusBadge}</td>
                    <td style="font-weight:bold; color:#d35400;">${seqDisplay}</td>
                    <td>${w.studentName}</td>
                    <td>${w.parentPhone}</td>
                    <td>${w.note || '-'}</td>
                    <td>
                        <button class="warning" style="padding:5px 10px; font-size:12px;" onclick="window.editWaitlist('${filterId}', '${w.key}', '${w.studentName}', '${w.parentPhone}', '${w.note}')">ç·¨è¼¯</button>
                        <button class="${btnClass}" style="padding:5px 10px; font-size:12px;" onclick="window.deleteWaitlist('${filterId}', '${w.key}', '${w.status}')">${btnText}</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        window.deleteWaitlist = function(courseId, waitlistId, currentStatus) {
            let pwd = document.getElementById('adminPwd').value.trim();
            if (!pwd) { 
                pwd = prompt("âš ï¸ æ‚¨å°šæœªè¼¸å…¥å¯†ç¢¼ï¼\nè«‹ç›´æ¥åœ¨æ­¤è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨å¡«å…¥ä¸Šæ–¹ï¼š");
                if (!pwd || !pwd.trim()) return;
                pwd = pwd.trim();
                document.getElementById('adminPwd').value = pwd; 
            }

            if (currentStatus === 'deleted') {
                if (confirm("ç¢ºå®šè¦ã€æ°¸ä¹…åˆªé™¤ã€‘æ­¤å€™è£œå—ï¼Ÿ")) {
                    set(ref(db, `waitlist/${courseId}/${waitlistId}`), null);
                }
            } else {
                if (confirm("ç¢ºå®šç§»é™¤æ­¤å€™è£œï¼Ÿ(è³‡æ–™å°‡ä¿ç•™ï¼Œåºè™Ÿå°‡é‡‹å‡º)")) {
                    update(ref(db, `waitlist/${courseId}/${waitlistId}`), {
                        status: 'deleted',
                        adminPwd: pwd
                    });
                }
            }
        };

        window.editWaitlist = function(courseId, waitlistId, oldName, oldPhone, oldNote) {
            let pwd = document.getElementById('adminPwd').value.trim();
            if (!pwd) { 
                pwd = prompt("âš ï¸ æ‚¨å°šæœªè¼¸å…¥å¯†ç¢¼ï¼\nè«‹ç›´æ¥åœ¨æ­¤è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨å¡«å…¥ä¸Šæ–¹ï¼š");
                if (!pwd || !pwd.trim()) return;
                pwd = pwd.trim();
                document.getElementById('adminPwd').value = pwd; 
            }

            const newName = prompt("ä¿®æ”¹å§“å", oldName);
            const newPhone = prompt("ä¿®æ”¹é›»è©±", oldPhone);
            const newNote = prompt("ä¿®æ”¹å‚™è¨»", oldNote);

            if (newName && newPhone) {
                update(ref(db, `waitlist/${courseId}/${waitlistId}`), {
                    studentName: newName,
                    parentPhone: newPhone,
                    note: newNote,
                    adminPwd: pwd
                }).then(() => alert("ä¿®æ”¹æˆåŠŸ")).catch(e => alert("ä¿®æ”¹å¤±æ•—ï¼š" + e.message));
            }
        };

        document.getElementById('waitlistSelector').addEventListener('change', renderWaitlistTable);

        function renderClassroomPreview() {
            const list = document.getElementById('classroomList');
            list.innerHTML = "";
            Object.keys(classrooms).forEach(key => {
                const c = classrooms[key];
                const card = document.createElement('div');
                card.className = 'classroom-card';
                card.innerHTML = `<h4>${c.name}</h4><div style="font-size:12px; color:#666;">ä»£ç¢¼: ${key}</div>`;
                card.onclick = () => showPreview(key); 
                list.appendChild(card);
            });
        }
        
        window.showPreview = function(key) {
            const modal = document.getElementById('previewModal');
            const title = document.getElementById('previewTitle');
            const content = document.getElementById('previewContent');
            const config = classrooms[key];
            
            title.textContent = config.name;
            content.innerHTML = "";
            
            config.layout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';
                row.forEach(seatCode => {
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    let code = seatCode;
                    if (seatCode.includes(':X')) { code = seatCode.split(':')[0]; seat.classList.add('blocked'); }
                    if (code === "_") seat.classList.add('aisle');
                    else if (code === "DOOR") { seat.textContent = "é–€"; seat.classList.add('aisle'); }
                    else if (code === "PILLAR") { seat.textContent = "æŸ±"; seat.classList.add('aisle'); }
                    else seat.textContent = code;
                    rowDiv.appendChild(seat);
                });
                content.appendChild(rowDiv);
            });
            
            modal.style.display = "flex";
        };
        
        window.closePreview = function() {
            document.getElementById('previewModal').style.display = "none";
        };
        
        renderClassroomPreview();

        const ZOMBIE_TIMEOUT = 2 * 60 * 1000; 
        const SWEEP_INTERVAL = 10 * 1000; 

        function startZombieSweeper() {
            const statusDiv = document.getElementById('sweeperStatus');
            
            setInterval(() => {
                const now = Date.now() + serverTimeOffset; // â˜…â˜…â˜… å°å…¥ä¼ºæœå™¨æ™‚é–“æ ¡æº– â˜…â˜…â˜…
                let clearedCount = 0;

                Object.keys(seatsData).forEach(courseId => {
                    const seats = seatsData[courseId];
                    Object.keys(seats).forEach(seatId => {
                        if (seatId === '_settings') return;
                        const info = seats[seatId];
                        
                        if (info.status === 'locked' && info.user !== 'admin_reserved') {
                            if (now - info.timestamp > ZOMBIE_TIMEOUT) {
                                set(ref(db, `seats/${courseId}/${seatId}`), null);
                                clearedCount++;
                                console.log(`[Sweeper] æ¸…é™¤æ®­å±åº§ä½: ${courseId} - ${seatId}`);
                            }
                        }
                    });
                });

                if (clearedCount > 0) {
                    statusDiv.textContent = `ğŸ§¹ å‰›å‰›æ¸…é™¤äº† ${clearedCount} å€‹æ®­å±åº§ä½`;
                    statusDiv.style.backgroundColor = "#e74c3c";
                    setTimeout(() => {
                        statusDiv.textContent = "ğŸ§¹ æ®­å±æ¸…é™¤å™¨ï¼šå¾…å‘½";
                        statusDiv.style.backgroundColor = "rgba(0,0,0,0.7)";
                    }, 3000);
                }
            }, SWEEP_INTERVAL);
        }

        startZombieSweeper();

        window.initBillPage = function() {
            window.renderCourseConfig();
            window.processBills();
        };

        // ç›£è½ print_layouts è³‡æ–™
        onValue(ref(db, 'print_layouts'), (snapshot) => {
            printLayouts = snapshot.val() || {};
            // å¦‚æœç•¶å‰åœ¨ print é é¢ï¼Œæ›´æ–°é¸å–®
            if (document.getElementById('tab-print').classList.contains('active')) {
                updatePrintCourseList();
            }
        });

        window.renderCourseConfig = function() {
            const container = document.getElementById('courseConfigList');
            container.innerHTML = "";
            const billType = document.getElementById('billTypeSelector').value;

            Object.keys(coursesData).forEach(key => {
                const c = coursesData[key];
                const isSeniorCourse = c.grade.includes("é«˜");
                if (billType === 'senior' && !isSeniorCourse) return;
                if (billType === 'junior' && isSeniorCourse) return;

                const div = document.createElement('div');
                div.className = "config-row";
                div.innerHTML = `
                    <input type="checkbox" id="bill_check_${key}" style="margin-right:10px;" checked onchange="window.processBills()">
                    <span style="font-weight:bold; display:inline-block; width:200px;">${c.subject}</span>
                    <input type="text" id="bill_date_${key}" placeholder="æ—¥æœŸ (å¦‚ 3/5)" style="width:80px;" value="${c.billDate || ''}">
                    <input type="text" id="bill_count_${key}" placeholder="å ‚æ•¸ (å¦‚ 12)" style="width:60px;" value="${c.billCount || ''}">
                    <input type="text" id="bill_price_${key}" placeholder="é‡‘é¡" style="width:80px;" value="${c.billPrice || c.price.replace(/[$,]/g, '')}">
                    <input type="text" id="bill_note_${key}" placeholder="å‚™è¨» (é¸å¡«)" style="width:150px;" value="${c.billNote || ''}">
                `;
                container.appendChild(div);
            });

            // æ¸²æŸ“å®Œè¨­å®šå¾Œï¼Œè‡ªå‹•è§¸ç™¼ä¸€æ¬¡ processBills ä»¥æ›´æ–°é è¦½
            window.processBills();
        };

        window.saveAllBillConfigs = function() {
            let pwd = document.getElementById('adminPwd').value.trim();
            if (!pwd) { 
                pwd = prompt("âš ï¸ æ‚¨å°šæœªè¼¸å…¥å¯†ç¢¼ï¼\nè«‹ç›´æ¥åœ¨æ­¤è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨å¡«å…¥ä¸Šæ–¹ï¼š");
                if (!pwd || !pwd.trim()) return;
                pwd = pwd.trim();
                document.getElementById('adminPwd').value = pwd; 
            }

            const updates = {};
            Object.keys(coursesData).forEach(key => {
                // åªå„²å­˜æœ‰é¡¯ç¤ºåœ¨ç•«é¢ä¸Šçš„è¨­å®š (é¿å…è¦†è“‹åˆ°å¦ä¸€éƒ¨åˆ¥çš„è¨­å®š)
                if (document.getElementById(`bill_date_${key}`)) {
                    const date = document.getElementById(`bill_date_${key}`).value;
                    const count = document.getElementById(`bill_count_${key}`).value;
                    const price = document.getElementById(`bill_price_${key}`).value;
                    const note = document.getElementById(`bill_note_${key}`).value;
                    
                    updates[`courses/${key}/billDate`] = date;
                    updates[`courses/${key}/billCount`] = count;
                    updates[`courses/${key}/billPrice`] = price;
                    updates[`courses/${key}/billNote`] = note;
                    updates[`courses/${key}/adminPwd`] = pwd;
                }
            });

            update(ref(db), updates).then(() => {
                alert("âœ… è¨­å®šå·²å„²å­˜ï¼");
                window.processBills();
            }).catch(err => alert("å„²å­˜å¤±æ•—ï¼š" + err.message));
        };

        window.importSchoolCSV = function() {
            const fileInput = document.getElementById('csvSchoolFile');
            if (fileInput.files.length === 0) return alert("è«‹é¸æ“‡ CSV æª”æ¡ˆ");
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                let count = 0;

                if (lines.length === 0) return;

                // è®€å–ç¬¬ä¸€è¡Œæ¨™é¡Œï¼Œå°‹æ‰¾ã€Œå­¸æ ¡ã€èˆ‡ã€Œå§“åã€çš„ç´¢å¼• (ä¸¦æ¸…é™¤ BOM èˆ‡å¼•è™Ÿ)
                const headers = lines[0].split(',').map(h => h.trim().replace(/["']/g, '').replace(/^\uFEFF/, ''));
                const schoolIdx = headers.findIndex(h => h.includes('å­¸æ ¡'));
                const nameIdx = headers.findIndex(h => h.includes('å§“å'));

                if (schoolIdx === -1 || nameIdx === -1) {
                    return alert("âŒ CSV æª”æ¡ˆæ¨™é¡Œåˆ—å¿…é ˆåŒ…å«ã€Œå­¸æ ¡ã€èˆ‡ã€Œå§“åã€æ¬„ä½ï¼");
                }

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    if (!line.trim()) continue;
                    const parts = line.split(',');
                    if (parts.length > Math.max(schoolIdx, nameIdx)) {
                        const school = parts[schoolIdx].trim().replace(/["']/g, '');
                        const name = parts[nameIdx].trim().replace(/["']/g, '');
                        if (name && school) { 
                            schoolMap[name] = school;
                            count++;
                        }
                    }
                }
                document.getElementById('csvStatus').textContent = `âœ… å·²åŒ¯å…¥ ${count} ç­†å­¸æ ¡è³‡æ–™`;
                window.processBills(); 
            };
            reader.readAsText(file);
        };

        window.processBills = function() {
            const billType = document.getElementById('billTypeSelector').value;
            const studentMap = {};
            
            const footerInfo = document.getElementById('footerInfo');
            const bankInfo = document.getElementById('bankInfo');
            
            if (billType === 'senior') {
                footerInfo.innerHTML = 'æ–°ç«¹å¸‚ç§ç«‹å±±ç†Šå‡å¤§æ–‡ç†çŸ­æœŸè£œç¿’ç­ &nbsp; åœ°å€ï¼šæ–°ç«¹å¸‚ç§‘å­¸åœ’è·¯107å··2è™ŸB1 &nbsp; ç«‹æ¡ˆå­—è™Ÿï¼šåºœæ•™ç¤¾å­—ç¬¬1120072237è™Ÿ';
                bankInfo.innerHTML = 'ç¬¬ä¸€éŠ€è¡Œ(007) ç«¹ç§‘åˆ†è¡Œ &nbsp;&nbsp; æˆ¶åï¼šæ–°ç«¹å¸‚ç§ç«‹å±±ç†Šå‡å¤§æ–‡ç†çŸ­æœŸè£œç¿’ç­ &nbsp;&nbsp; å¸³è™Ÿï¼š303-100-34751<br><span class="bank-highlight">â˜… åŒ¯æ¬¾å¾Œè«‹å‘ŠçŸ¥æˆ‘å€‘ä¸Šèª²ç§‘ç›®ã€åŒ¯æ¬¾é‡‘é¡åŠå¸³è™Ÿå¾Œ 5 ç¢¼ä»¥åˆ©æˆ‘å€‘å°å¸³ï¼Œè¬è¬ã€‚</span>';
            } else {
                footerInfo.innerHTML = 'æ–°ç«¹å¸‚ç§ç«‹å±±ç†Šç§‘å­¸æ–‡ç†çŸ­æœŸè£œç¿’ç­ &nbsp; åœ°å€ï¼šæ–°ç«¹å¸‚ç§‘å­¸åœ’è·¯107å··1è™Ÿ &nbsp; ç«‹æ¡ˆå­—è™Ÿï¼šåºœæ•™ç¤¾å­—ç¬¬1010019608è™Ÿ';
                bankInfo.innerHTML = 'ç¬¬ä¸€éŠ€è¡Œ(007) ç«¹ç§‘åˆ†è¡Œ &nbsp;&nbsp; æˆ¶åï¼šæ–°ç«¹å¸‚ç§ç«‹å±±ç†Šç§‘å­¸æ–‡ç†çŸ­æœŸè£œç¿’ç­ &nbsp;&nbsp; å¸³è™Ÿï¼š303-100-13273<br><span class="bank-highlight">â˜… åŒ¯æ¬¾å¾Œè«‹å‘ŠçŸ¥æˆ‘å€‘ä¸Šèª²ç§‘ç›®ã€åŒ¯æ¬¾é‡‘é¡åŠå¸³è™Ÿå¾Œ 5 ç¢¼ä»¥åˆ©æˆ‘å€‘å°å¸³ï¼Œè¬è¬ã€‚</span>';
            }

            Object.keys(seatsData).forEach(courseId => {
                const seats = seatsData[courseId];
                const c = coursesData[courseId];
                if (!c) return;

                // æª¢æŸ¥æ˜¯å¦å‹¾é¸
                const checkbox = document.getElementById(`bill_check_${courseId}`);
                if (!checkbox || !checkbox.checked) return;

                const isSeniorCourse = c.grade.includes("é«˜");
                if (billType === 'senior' && !isSeniorCourse) return;
                if (billType === 'junior' && isSeniorCourse) return;

                Object.keys(seats).forEach(seatId => {
                    if (seatId === '_settings') return;
                    const info = seats[seatId];
                    if (info.status === 'sold') {
                        const name = info.studentName;
                        if (!studentMap[name]) {
                            studentMap[name] = {
                                name: name,
                                phone: info.parentPhone,
                                items: [],
                                total: 0,
                                grade: inferGrade(c.grade),
                                school: schoolMap[name] || "" 
                            };
                        }
                        
                        // å„ªå…ˆä½¿ç”¨è¼¸å…¥æ¡†çš„å€¼ï¼Œè‹¥ç„¡å‰‡ç”¨é è¨­å€¼
                        let priceInput = document.getElementById(`bill_price_${courseId}`);
                        let price = priceInput ? parseInt(priceInput.value) : (parseInt(c.billPrice) || parseInt(c.price.replace(/[$,]/g, '')) || 0);
                        
                        let dateInput = document.getElementById(`bill_date_${courseId}`);
                        let countInput = document.getElementById(`bill_count_${courseId}`);
                        let noteInput = document.getElementById(`bill_note_${courseId}`);

                        let dateVal = dateInput ? dateInput.value : (c.billDate || "");
                        let countVal = countInput ? countInput.value : (c.billCount || "");
                        let noteVal = noteInput ? noteInput.value : (c.billNote || "");

                        studentMap[name].items.push({
                            name: c.subject + (c.classType ? ` (${c.classType})` : ''),
                            dateHtml: formatBillDate(dateVal, countVal),
                            price: price,
                            note: noteVal
                        });
                        studentMap[name].total += price;
                    }
                });
            });

            billStudents = Object.values(studentMap);
            // é‡ç½®é è¦½ï¼šç¢ºä¿ç„¡è³‡æ–™æ™‚ç•«é¢è¢«æ¸…ç©º
            if (billStudents.length > 0) {
                loadBill(0);
            } else {
                document.getElementById('billName').textContent = "ç„¡è³‡æ–™";
                document.getElementById('billGrade').textContent = "";
                document.getElementById('billSchool').textContent = "";
                document.getElementById('billTotal').textContent = "0";
                document.getElementById('billNote').innerText = "";
                document.getElementById('itemsTable').innerHTML = "<tr><td colspan='3' style='text-align:center; padding: 20px;'>æ­¤éƒ¨åˆ¥ç›®å‰æ²’æœ‰å­¸è²»å–®è³‡æ–™</td></tr>";
                document.getElementById('billCounter').textContent = "0 / 0";
            }
        };

        function formatBillDate(dateStr, count) {
            let html = "";
            if (dateStr) {
                const parts = dateStr.split('/');
                if (parts.length === 2) {
                    html += `è‡ª<span class="w-num">${parts[0]}</span><span class="d-text">æœˆ</span><span class="w-num">${parts[1]}</span><span class="d-text">æ—¥</span>èµ·`;
                } else {
                    html += dateStr;
                }
            }
            if (count) {
                html += ` å…± <span class="w-num">${count}</span> å ‚`;
            }
            return html;
        }

        function inferGrade(gradeStr) {
            if (!gradeStr) return "";
            if (gradeStr.includes("å°äº”")) return "äº”";
            if (gradeStr.includes("å°å…­")) return "å…­";
            if (gradeStr.includes("åœ‹ä¸€")) return "ä¸ƒ";
            if (gradeStr.includes("åœ‹äºŒ")) return "å…«";
            if (gradeStr.includes("åœ‹ä¸‰")) return "ä¹";
            if (gradeStr.includes("é«˜ä¸€")) return "é«˜ä¸€";
            if (gradeStr.includes("é«˜äºŒ")) return "é«˜äºŒ";
            if (gradeStr.includes("é«˜ä¸‰")) return "é«˜ä¸‰";
            return "";
        }

        window.prevBill = function() {
            if (currentBillIndex > 0) {
                loadBill(currentBillIndex - 1);
            }
        };

        window.nextBill = function() {
            if (currentBillIndex < billStudents.length - 1) {
                loadBill(currentBillIndex + 1);
            }
        };

        window.loadBill = function(index) {
            currentBillIndex = index;
            const s = billStudents[index];
            
            document.getElementById('billCounter').textContent = `${index + 1} / ${billStudents.length}`;
            document.getElementById('billName').textContent = s.name;
            document.getElementById('billGrade').textContent = s.grade;
            document.getElementById('billSchool').textContent = s.school;
            document.getElementById('billTotal').textContent = s.total.toLocaleString();
            
            let notes = [];
            s.items.forEach(item => {
                if (item.note) {
                    notes.push(`ã€${item.name}ã€‘\n${item.note}`);
                }
            });
            document.getElementById('billNote').innerText = notes.join("\n\n");

            const tbody = document.getElementById('itemsTable');
            tbody.innerHTML = "";
            
            s.items.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="col-1" contenteditable="true">${item.name}</td>
                    <td class="col-2" contenteditable="true">${item.dateHtml}</td>
                    <td class="col-3" contenteditable="true">$${item.price.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });

            for(let i = s.items.length; i < 6; i++) {
                const tr = document.createElement('tr');
                if (i === s.items.length) {
                    tr.innerHTML = '<td class="col-1" style="color:black; font-weight:bold;">ã€€ã€ ä»¥ ä¸‹ ç©º ç™½ ã€‘</td><td colspan="2"></td>';
                } else {
                    tr.innerHTML = '<td colspan="3">&nbsp;</td>';
                }
                tbody.appendChild(tr);
            }
        };

        window.createManualBill = function() {
            const emptyStudent = {
                name: "å§“å",
                grade: "",
                school: "",
                total: 0,
                items: [{ name: "ç§‘ç›®åç¨±", dateHtml: "æ—¥æœŸ", price: 0 }]
            };
            billStudents.push(emptyStudent); 
            loadBill(billStudents.length - 1); // åˆ‡æ›åˆ°æœ€å¾Œä¸€å¼µ (æ–°å¢çš„)
        };

        window.downloadCurrentBill = function() {
            const element = document.getElementById('billArea');
            const name = document.getElementById('billName').textContent || "å­¸è²»å–®";
            html2canvas(element, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${name}_å­¸è²»å–®.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        };

        window.downloadAllBills = async function() {
            if (!confirm(`ç¢ºå®šè¦ä¸‹è¼‰å…¨éƒ¨ ${billStudents.length} å¼µå­¸è²»å–®å—ï¼Ÿ`)) return;
            
            for (let i = 0; i < billStudents.length; i++) {
                loadBill(i);
                await new Promise(r => setTimeout(r, 500)); 
                const element = document.getElementById('billArea');
                const name = billStudents[i].name;
                
                await html2canvas(element, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `${name}_å­¸è²»å–®.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                });
            }
            alert("âœ… å…¨éƒ¨ä¸‹è¼‰å®Œæˆï¼");
        };

        // â˜…â˜…â˜… V34.0 æ–°å¢ï¼šåº§ä½è¡¨è¼¸å‡ºé‚è¼¯ (åˆ†æµç‰ˆ) â˜…â˜…â˜…
        window.initPrintPage = function() {
            updatePrintCourseList();
        };

        window.updatePrintCourseList = function() {
            const source = document.getElementById('printSourceSelector').value;
            const selector = document.getElementById('printCourseSelector');
            const saveArea = document.getElementById('manualSaveArea');
            
            selector.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
            saveArea.style.display = 'none';

            if (source === 'live') {
                saveArea.style.display = 'flex'; // Live æ¨¡å¼ä¹Ÿå…è¨±å¦å­˜æ–°æª”
                Object.keys(coursesData).forEach(key => {
                    const c = coursesData[key];
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `[Live] ${c.grade} ${c.subject} ${c.classType || ''}`;
                    selector.appendChild(option);
                });
            } else if (source === 'manual') {
                saveArea.style.display = 'flex'; // é¡¯ç¤ºå­˜æª”å€
                Object.keys(printLayouts).forEach(key => {
                    const layout = printLayouts[key];
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `[Saved] ${layout.name}`;
                    selector.appendChild(option);
                });
            } else if (source === 'empty') {
                saveArea.style.display = 'flex'; // é¡¯ç¤ºå­˜æª”å€
                Object.keys(classrooms).forEach(key => {
                    const c = classrooms[key];
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `[Empty] ${c.name}`;
                    selector.appendChild(option);
                });
            }
        };

        window.generateSeatingChart = function() {
            const source = document.getElementById('printSourceSelector').value;
            const selectedId = document.getElementById('printCourseSelector').value;
            const grid = document.getElementById('printGrid');
            grid.innerHTML = "";
            
            if (!selectedId) return;

            let layoutToRender = null;
            let currentSeats = {};
            let classroomName = "";
            let classType = "";
            let time = "";
            let teacher = "";

            if (source === 'live') {
                const c = coursesData[selectedId];
                if (!c) return;
                
                classroomName = classrooms[c.classroom] ? classrooms[c.classroom].name : c.classroom;
                classType = `ç­ç´šï¼š${c.subject} ${c.classType || ''}`;
                time = `ä¸Šèª²æ™‚é–“ï¼š${c.timeDescription || '-'}`;
                teacher = `è€å¸«ï¼š${c.teacher}`;
                
                layoutToRender = c.layout || (classrooms[c.classroom] ? classrooms[c.classroom].layout : null);
                currentSeats = seatsData[selectedId] || {};

            } else if (source === 'manual') {
                const saved = printLayouts[selectedId];
                if (!saved) return;

                classroomName = saved.classroomName;
                classType = `ç­ç´šï¼š${saved.name}`; // ä½¿ç”¨å­˜æª”åç¨±
                time = `ä¸Šèª²æ™‚é–“ï¼š${saved.time || ''}`;
                teacher = `è€å¸«ï¼š${saved.teacher || ''}`;
                
                layoutToRender = saved.layout; // é€™æ˜¯å­˜æª”æ™‚çš„ layout (å«åå­—)
                // æ‰‹å‹•æ¨¡å¼ä¸‹ï¼Œåå­—ç›´æ¥å­˜åœ¨ layout è£¡ï¼Œä¸éœ€è¦ currentSeats

            } else if (source === 'empty') {
                const c = classrooms[selectedId];
                if (!c) return;

                classroomName = c.name;
                classType = "ç­ç´šï¼š(è«‹é»æ“Šè¼¸å…¥)";
                time = "ä¸Šèª²æ™‚é–“ï¼š";
                teacher = "è€å¸«ï¼š";
                layoutToRender = c.layout;
                currentSeats = {}; // ç©ºç™½
            }

            if (!layoutToRender) return;

            // æ›´æ–°æ¨™é ­ (å¯ç·¨è¼¯)
            document.getElementById('p_classroom').textContent = classroomName;
            document.getElementById('p_classType').textContent = classType;
            document.getElementById('p_time').textContent = time;
            document.getElementById('p_teacher').textContent = teacher;
            
            // é–‹å•Ÿæ¨™é ­ç·¨è¼¯åŠŸèƒ½ (æ–¹ä¾¿æ‰‹å‹•æ¨¡å¼ä¿®æ”¹)
            document.getElementById('p_classType').contentEditable = true;
            document.getElementById('p_time').contentEditable = true;
            document.getElementById('p_teacher').contentEditable = true;

            layoutToRender.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'print-row';
                row.forEach(seatCode => {
                    const seat = document.createElement('div');
                    seat.className = 'print-seat';
                    
                    let code = seatCode;
                    let isBlocked = false;
                    
                    // è™•ç†æ‰‹å‹•å­˜æª”çš„æ ¼å¼ (å¯èƒ½å·²ç¶“åŒ…å«åå­—)
                    let manualName = "";
                    if (source === 'manual' && printLayouts[selectedId].seatMap) {
                         // é€™è£¡éœ€è¦çŸ¥é“ seatIdï¼Œä½† layout åªæœ‰ code
                         // æˆ‘å€‘å‡è¨­ code å°±æ˜¯ key
                    }

                    if (code.includes(':X')) { code = code.split(':')[0]; isBlocked = true; }

                    if (code === "_") {
                        seat.classList.add('aisle');
                    } else if (code === "DOOR") {
                        seat.classList.add('door');
                        seat.textContent = "é–€";
                    } else if (code === "PILLAR") {
                        seat.classList.add('pillar');
                        seat.textContent = "æŸ±";
                    } else {
                        // æ­£å¸¸åº§ä½
                        if (isBlocked) {
                            seat.classList.add('blocked');
                            seat.textContent = code; 
                        } else {
                            seat.dataset.id = code; // ç¶å®š ID
                            seat.contentEditable = true; // å…è¨±ç·¨è¼¯

                            if (source === 'live') {
                                const info = currentSeats[code];
                                if (info && info.status === 'sold') {
                                    seat.textContent = info.studentName;
                                    if (info.studentName.length > 3) seat.style.fontSize = "14px";
                                }
                            } else if (source === 'manual') {
                                const saved = printLayouts[selectedId];
                                if (saved.seatMap && saved.seatMap[code]) {
                                    seat.textContent = saved.seatMap[code];
                                    if (saved.seatMap[code].length > 3) seat.style.fontSize = "14px";
                                }
                            }
                            // empty æ¨¡å¼ä¸å¡«å­—
                        }
                    }
                    rowDiv.appendChild(seat);
                });
                grid.appendChild(rowDiv);
            });

            // â˜…â˜…â˜… V34.3 è‡ªå‹•ç¸®æ”¾é‚è¼¯ (ä¿®å¾©å¤§æ•™å®¤ç¸®å¤ªå°) â˜…â˜…â˜…
            setTimeout(() => {
                const container = document.querySelector('.print-container');
                const gridEl = document.getElementById('printGrid');
                
                // å…ˆé‡ç½®ç¸®æ”¾ï¼Œæ‰èƒ½å–å¾—çœŸå¯¦å¤§å°
                gridEl.style.transform = 'none';
                
                // å‹•æ…‹å–å¾— A4 å®¹å™¨çš„å¯ç”¨å…§éƒ¨å¯¬åº¦ (æ‰£é™¤å·¦å³ padding çš„å®‰å…¨è·é›¢)
                const availableWidth = container.clientWidth - 40; 
                const gridWidth = gridEl.scrollWidth;

                // åªæœ‰åœ¨æ ¼å­å¯¬åº¦è¶…éå¯ç”¨å¯¬åº¦æ™‚æ‰ç¸®å°ï¼Œä¸”ä¾æ“šå¯¦éš›è¶…å‡ºçš„æ¯”ä¾‹ç²¾æº–ç¸®æ”¾
                if (gridWidth > availableWidth && availableWidth > 0) {
                    const scale = availableWidth / gridWidth;
                    gridEl.style.transform = `scale(${scale})`; 
                }
            }, 100); 
        };

        // â˜…â˜…â˜… V34.0 æ–°å¢ï¼šæ‰‹å‹•å„²å­˜åº§ä½è¡¨ (å¦å­˜æ–°æª”) â˜…â˜…â˜…
        window.saveManualLayout = function() {
            let pwd = document.getElementById('adminPwd').value.trim();
            if (!pwd) { 
                pwd = prompt("âš ï¸ æ‚¨å°šæœªè¼¸å…¥å¯†ç¢¼ï¼\nè«‹ç›´æ¥åœ¨æ­¤è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨å¡«å…¥ä¸Šæ–¹ï¼š");
                if (!pwd || !pwd.trim()) return;
                pwd = pwd.trim();
                document.getElementById('adminPwd').value = pwd; 
            }

            const saveName = document.getElementById('manualSaveName').value.trim();
            if (!saveName) return alert("è«‹è¼¸å…¥å­˜æª”åç¨±ï¼");

            // æª¢æŸ¥æ˜¯å¦åŒå
            let existingKey = null;
            for (let key in printLayouts) {
                if (printLayouts[key].name === saveName) {
                    existingKey = key;
                    break;
                }
            }

            if (existingKey) {
                if (!confirm(`âš ï¸ æª”åã€Œ${saveName}ã€å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦è¦†è“‹åŸæœ¬çš„å­˜æª”ï¼Ÿ`)) {
                    return;
                }
            }

            const source = document.getElementById('printSourceSelector').value;
            const selectedId = document.getElementById('printCourseSelector').value;
            
            // æŠ“å–ç•¶å‰ç•«é¢ä¸Šçš„è³‡æ–™
            const seatMap = {};
            document.querySelectorAll('.print-seat[data-id]').forEach(seat => {
                const text = seat.textContent.trim();
                if (text) {
                    seatMap[seat.dataset.id] = text;
                }
            });

            // æŠ“å–æ¨™é ­
            const classType = document.getElementById('p_classType').textContent;
            const time = document.getElementById('p_time').textContent;
            const teacher = document.getElementById('p_teacher').textContent;
            const classroomName = document.getElementById('p_classroom').textContent;

            // æ±ºå®š Layout ä¾†æº (ç‚ºäº†ä¸‹æ¬¡èƒ½é‚„åŸæ ¼å­å½¢ç‹€)
            let baseLayout = [];
            if (source === 'live') {
                const c = coursesData[selectedId];
                baseLayout = c.layout || classrooms[c.classroom].layout;
            } else if (source === 'empty') {
                baseLayout = classrooms[selectedId].layout;
            } else if (source === 'manual') {
                baseLayout = printLayouts[selectedId].layout;
            }

            const saveId = existingKey ? existingKey : "LAYOUT_" + Date.now();
            const saveData = {
                name: saveName,
                classroomName: classroomName,
                classType: classType, // é€™è£¡å­˜çš„æ˜¯å®Œæ•´æ¨™é¡Œå­—ä¸²
                time: time,
                teacher: teacher,
                layout: baseLayout,
                seatMap: seatMap,
                updatedAt: Date.now(),
                adminPwd: pwd
            };

            // å¯«å…¥ print_layouts ç¯€é» (èˆ‡ seats åˆ†é–‹)
            update(ref(db, `print_layouts/${saveId}`), saveData).then(() => {
                alert("âœ… å·²å¦å­˜æ–°æª”ï¼æ‚¨å¯ä»¥åœ¨ã€Œæ‰‹å‹•æ’ä½å­˜æª”ã€ä¸­æ‰¾åˆ°å®ƒã€‚");
                // é‡æ–°æ•´ç†é¸å–®
                document.getElementById('printSourceSelector').value = 'manual';
                updatePrintCourseList();
            }).catch(err => alert("å­˜æª”å¤±æ•—ï¼š" + err.message));
        };

        window.downloadSeatingChart = function() {
            const element = document.querySelector('.print-container');
            // æª”åå–è‡ªæ¨™é¡Œ
            const title = document.getElementById('p_classType').textContent.replace('ç­ç´šï¼š', '').trim() || "åº§ä½è¡¨";
            const filename = `${title}_åº§ä½è¡¨.png`;

            html2canvas(element, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        };

    </script>
</body>
</html>