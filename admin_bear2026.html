<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ» å±±ç†Šç§‘å­¸ - å¾Œå°æŒ‡æ®ä¸­å¿ƒ</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tiny.cloud/1/2nwvnffdvbvf93d6ry0sov7w0d7yabtr1d6tp8l38cb6hoh1/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; padding: 20px; margin: 0; }
        .navbar { background-color: #2c3e50; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; color: white; }
        .nav-title { font-size: 24px; font-weight: bold; display: flex; align-items: center; }
        .nav-tabs button { background: none; border: none; color: #bdc3c7; font-size: 18px; cursor: pointer; margin-left: 20px; padding: 5px 10px; transition: 0.3s; }
        .nav-tabs button.active { color: white; border-bottom: 3px solid #e74c3c; font-weight: bold; }
        .nav-right { display: flex; align-items: center; }
        .btn-home { background: #e74c3c; color: white; text-decoration: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; font-size: 14px; margin-left: 20px; }
        
        /* â˜…â˜…â˜… å…¨åŸŸå¯†ç¢¼æ¡†æ¨£å¼ â˜…â˜…â˜… */
        .global-pwd-bar { background: #fff3e0; padding: 10px 20px; border-radius: 10px; border: 2px solid #f39c12; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-weight: bold; color: #d35400; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .page-section { display: none; }
        .page-section.active { display: block; }
        .form-container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 900px; margin: 0 auto; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        .form-row { display: flex; gap: 20px; }
        .form-row .form-group { flex: 1; }
        button { cursor: pointer; background-color: #3498db; color: white; border: none; font-weight: bold; padding: 10px 20px; border-radius: 5px; font-size: 16px; }
        button:hover { background-color: #2980b9; }
        button.danger { background-color: #e74c3c; }
        button.success { background-color: #27ae60; }
        button.warning { background-color: #f39c12; }
        button.dark { background-color: #34495e; } /* æ°¸ä¹…åˆªé™¤æŒ‰éˆ• */
        
        .course-list { margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .admin-course-card { background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; cursor: pointer; transition: 0.2s; position: relative; }
        .admin-course-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card-thumb { height: 150px; background-size: cover; background-position: center; }
        .card-content { padding: 15px; }
        .card-content h3 { margin: 0 0 10px 0; font-size: 18px; color: #2c3e50; }
        .card-content p { margin: 5px 0; color: #666; font-size: 14px; }
        .btn-delete { position: absolute; top: 10px; right: 10px; background: #e74c3c; padding: 5px 10px; font-size: 12px; z-index: 10; border-radius: 3px; }
        
        .table-container { overflow-x: auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        
        /* å¼·åˆ¶è¡¨æ ¼ä¸æ›è¡Œ */
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; white-space: nowrap; }
        
        th { background-color: #34495e; color: white; }
        
        /* ç‹€æ…‹æ¨™ç±¤æ¨£å¼ */
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; color: white; }
        .badge.sold { background-color: #27ae60; }
        .badge.locked { background-color: #f39c12; }
        .badge.deleted { background-color: #95a5a6; text-decoration: line-through; } 
        
        /* è»Ÿåˆªé™¤è¡Œæ¨£å¼ */
        tr.row-deleted { background-color: #f2f2f2; color: #999; }
        tr.row-deleted td { text-decoration: line-through; }
        tr.row-deleted button { text-decoration: none !important; }

        #imgPreview { max-width: 200px; margin-top: 10px; display: none; border-radius: 5px; }
        .big-selector { font-size: 18px; padding: 15px; width: 100%; max-width: 500px; margin: 0 auto; display: block; border: 2px solid #3498db; }
        .center-box { text-align: center; margin-bottom: 20px; background: white; padding: 20px; border-radius: 10px; }
        .banner-list { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
        .banner-item { width: 300px; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
        .banner-item img { width: 100%; height: 150px; object-fit: cover; border-radius: 5px; }
        .visual-map-container { margin-top: 30px; background: white; padding: 20px; border-radius: 10px; overflow-x: auto; text-align: center; display: none; }
        .row { display: flex; justify-content: center; gap: 5px; margin-bottom: 5px; }
        .seat { width: 40px; height: 40px; background: #eee; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; position: relative; }
        .seat.sold { background: #e74c3c; color: white; }
        .seat.locked { background: #f39c12; color: white; }
        .seat.reserved { background: #8e44ad; color: white; }
        .seat.aisle { background: transparent; cursor: default; }
        .seat-tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 5px; border-radius: 3px; font-size: 12px; white-space: nowrap; display: none; z-index: 10; }
        .seat:hover .seat-tooltip { display: block; }
        .classroom-preview-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .classroom-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s; }
        .classroom-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .preview-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 999; }
        .preview-box { background: white; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 90%; overflow: auto; text-align: center; }
        #sweeperStatus { position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; z-index: 9999; }
    </style>
</head>
<body>

    <div id="sweeperStatus">ğŸ§¹ æ®­å±æ¸…é™¤å™¨ï¼šå¾…å‘½</div>

    <div class="navbar">
        <div class="nav-title">
            <img src="logo1.png" style="height:40px; vertical-align:middle; margin-right:10px;">
            å±±ç†Šç§‘å­¸å¾Œå°
        </div>
        <div class="nav-right">
            <div class="nav-tabs">
                <button class="active" onclick="switchTab('monitor')">ğŸ“Š åŠƒä½ç›£æ§</button>
                <button onclick="switchTab('courses')">ğŸ“ èª²ç¨‹ç®¡ç†</button>
                <button onclick="switchTab('banners')">ğŸ–¼ï¸ æ©«å¹…ç®¡ç†</button>
                <button onclick="switchTab('waitlist')">ğŸ“‹ å€™è£œåå–®</button>
                <button onclick="switchTab('classrooms')">ğŸ« æ•™å®¤é è¦½</button>
            </div>
            <a href="index.html" class="btn-home" target="_blank">ğŸ  å›é¦–é </a>
        </div>
    </div>

    <div class="global-pwd-bar">
        <label>ğŸ”‘ ç®¡ç†å“¡å¯†ç¢¼ (å…¨åŸŸ)ï¼š</label>
        <input type="password" id="adminPwd" placeholder="è«‹è¼¸å…¥æ“ä½œå¯†ç¢¼" style="padding:5px; width:150px; border:1px solid #d35400; border-radius:5px;">
        <span style="font-size:12px; color:#666;">(ä»»ä½•ç·¨è¼¯/åˆªé™¤æ“ä½œçš†éœ€é©—è­‰æ­¤å¯†ç¢¼)</span>
    </div>

    <div id="tab-monitor" class="page-section active">
        <div class="center-box">
            <div style="margin-bottom:10px;">ç›®å‰æª¢è¦–ï¼š<span id="currentClassName" style="font-weight:bold;">æ‰€æœ‰èª²ç¨‹</span> | å·²åŠƒä½ï¼š<span id="totalSold" style="font-weight:bold;">0</span></div>
            <select id="classSelector" class="big-selector" onchange="loadVisualMap()"><option value="all">å…¨éƒ¨èª²ç¨‹ç¸½è¦½</option></select>
            <div id="visualMap" class="visual-map-container">
                <h3>åº§ä½è¡¨ç›£æ§ (é»æ“Šåº§ä½å¯æ“ä½œ)</h3>
                <div id="mapContent"></div>
            </div>
            <div style="margin-top:20px;">
                <input type="text" id="searchInput" placeholder="æœå°‹å§“åã€é›»è©±æˆ–è¨‚å–®ç·¨è™Ÿ..." style="padding:10px; width:300px;">
                <button onclick="exportToCSV()" class="success">ğŸ“¥ åŒ¯å‡º Excel</button>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>è¨‚å–®ç·¨è™Ÿ</th><th>èª²ç¨‹</th><th>åº§ä½</th><th>ç‹€æ…‹</th><th>å§“å</th><th>é›»è©±</th><th>æ™‚é–“</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="bookingTable"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-courses" class="page-section">
        <div id="courseListView">
            <button onclick="showCourseForm()" class="success" style="width:100%; padding:15px; font-size:18px;">â• æ–°å¢èª²ç¨‹</button>
            <div id="courseList" class="course-list"></div>
        </div>

        <div id="courseFormView" class="form-container" style="display:none;">
            <h2 id="formTitle" style="margin-top:0;">â• æ–°å¢èª²ç¨‹</h2>
            <input type="hidden" id="c_id"> 
            <div class="form-row">
                <div class="form-group">
                    <label>å¹´ç´šåˆ†é¡ (Grade)</label>
                    <select id="c_grade" onchange="updateSubjects()">
                        <option value="">è«‹é¸æ“‡å¹´ç´š</option>
                        <option value="å‡å°äº”èª²ç¨‹">å‡å°äº”èª²ç¨‹</option><option value="å‡å°å…­èª²ç¨‹">å‡å°å…­èª²ç¨‹</option>
                        <option value="å‡åœ‹ä¸€èª²ç¨‹">å‡åœ‹ä¸€èª²ç¨‹</option><option value="å‡åœ‹äºŒèª²ç¨‹">å‡åœ‹äºŒèª²ç¨‹</option><option value="å‡åœ‹ä¸‰èª²ç¨‹">å‡åœ‹ä¸‰èª²ç¨‹</option>
                        <option value="å‡é«˜ä¸€èª²ç¨‹">å‡é«˜ä¸€èª²ç¨‹</option><option value="å‡é«˜äºŒèª²ç¨‹">å‡é«˜äºŒèª²ç¨‹</option><option value="å‡é«˜ä¸‰èª²ç¨‹">å‡é«˜ä¸‰èª²ç¨‹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ç§‘ç›®åç¨± (Subject)</label>
                    <input list="subject_list" id="c_subject" placeholder="é¸æ“‡æˆ–è¼¸å…¥ç§‘ç›®">
                    <datalist id="subject_list"></datalist>
                </div>
                <div class="form-group">
                    <label>ç­åˆ¥ (Class Type)</label>
                    <input list="class_type_list" id="c_class_type" placeholder="ä¾‹å¦‚ï¼šé€±ä¸€å››ç­" onchange="autoFillTime()">
                    <datalist id="class_type_list">
                        <option value="é€±ä¸€å››ç­"></option><option value="é€±äºŒäº”ç­"></option><option value="é€±ä¸‰å…­ç­"></option>
                        <option value="é€±ä¸€ç­"></option><option value="é€±äºŒç­"></option><option value="é€±ä¸‰ç­"></option>
                        <option value="é€±å››ç­"></option><option value="é€±äº”ç­"></option><option value="é€±å…­ç­"></option>
                        <option value="é€±æ—¥ç­"></option><option value="é€±å…­æ—©ä¸Šç­"></option><option value="é€±å…­ä¸‹åˆç­"></option>
                        <option value="é€±å…­æ™šä¸Šç­"></option><option value="é€±æ—¥æ—©ä¸Šç­"></option><option value="é€±æ—¥ä¸‹åˆç­"></option>
                        <option value="é€±æ—¥æ™šä¸Šç­"></option>
                    </datalist>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>æˆèª²è€å¸«</label>
                    <input list="teacher_list" id="c_teacher" placeholder="é¸æ“‡æˆ–è¼¸å…¥è€å¸«">
                    <datalist id="teacher_list">
                        <option value="ç™½ç†Šè€å¸«"></option><option value="é˜¿å–µè€å¸«"></option><option value="å°å½¥è€å¸«"></option>
                        <option value="å°æ±è€å¸«"></option><option value="æç¿”è€å¸«"></option><option value="å† ç¶­è€å¸«"></option>
                        <option value="å°æšè€å¸«"></option><option value="é»ƒé“è€å¸«"></option><option value="åŒ–éˆè€å¸«"></option>
                    </datalist>
                </div>
                <div class="form-group">
                    <label>ä½¿ç”¨æ•™å®¤</label>
                    <select id="c_classroom">
                        <option value="high_red">é«˜ä¸­ç´…æ•™å®¤</option><option value="high_orange">é«˜ä¸­æ©˜æ•™å®¤</option><option value="high_green">é«˜ä¸­ç¶ æ•™å®¤</option>
                        <option value="high_yellow">é«˜ä¸­é»ƒæ•™å®¤</option><option value="high_blue">é«˜ä¸­è—æ•™å®¤</option><option value="middle_new_orange">åœ‹ä¸­æ–°æ©˜æ•™å®¤</option>
                        <option value="middle_new_blue">åœ‹ä¸­æ–°è—æ•™å®¤</option><option value="middle_new_yellow">åœ‹ä¸­æ–°é»ƒæ•™å®¤</option><option value="middle_new_red">åœ‹ä¸­æ–°ç´…æ•™å®¤</option>
                        <option value="middle_big_red">åœ‹ä¸­å¤§ç´…æ•™å®¤</option><option value="middle_da_chiao">åœ‹ä¸­å¤§æ©‹æ•™å®¤</option><option value="middle_big_green">åœ‹ä¸­å¤§ç¶ æ•™å®¤</option>
                        <option value="test_room">ğŸ§ª æ¸¬è©¦å°ˆç”¨æ•™å®¤</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ä¸Šèª²æ™‚é–“ (è‡ªå‹•ä»£å…¥)</label>
                    <input type="text" id="c_time_desc" placeholder="ä¾‹å¦‚ï¼šæ¯é€±å›› 18:30-21:30">
                </div>
                <div class="form-group">
                    <label>é–‹èª²æ—¥æœŸ (è¼¸å…¥ 7/2 è‡ªå‹•è½‰)</label>
                    <input type="text" id="c_start_date" placeholder="ä¾‹å¦‚ï¼š2026/07/02 (å››)" onblur="formatDate(this)">
                </div>
            </div>
            <div class="form-group">
                <label>å°é¢åœ–ç‰‡ (å»ºè­° 800x400)</label>
                <input type="file" id="c_image_file" accept="image/*" onchange="previewImage(this)">
                <input type="hidden" id="c_image_url">
                <img id="imgPreview" src="" alt="åœ–ç‰‡é è¦½">
                <div id="uploadStatus" style="font-size:12px; color:#666; margin-top:5px;"></div>
            </div>
            <div class="form-row" style="background:#e8f6f3; padding:10px; border-radius:5px; margin-bottom:20px;">
                <div class="form-group">
                    <label>å‰å°é¡¯ç¤ºæ™‚é–“ (é–‹å§‹)</label>
                    <input type="datetime-local" id="c_display_start">
                </div>
                <div class="form-group">
                    <label>å‰å°é¡¯ç¤ºæ™‚é–“ (çµæŸ)</label>
                    <input type="datetime-local" id="c_display_end">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label style="color:#e74c3c;">â˜… ä¸€éšåŠƒä½ (é–‹å§‹)</label>
                    <input type="datetime-local" id="c_start1">
                </div>
                <div class="form-group">
                    <label>ä¸€éšåŠƒä½ (çµæŸ)</label>
                    <input type="datetime-local" id="c_end1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>äºŒéšåŠƒä½ (é–‹å§‹)</label>
                    <input type="datetime-local" id="c_start2">
                </div>
                <div class="form-group">
                    <label>äºŒéšåŠƒä½ (çµæŸ)</label>
                    <input type="datetime-local" id="c_end2">
                </div>
            </div>
            
            <div class="form-row" style="background:#fff3e0; padding:10px; border-radius:5px; margin-bottom:20px;">
                <div class="form-group" style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="c_waitlist_enabled" style="width:auto; transform:scale(1.5);">
                    <label for="c_waitlist_enabled" style="margin:0; cursor:pointer;">å•Ÿç”¨å€™è£œåŠŸèƒ½</label>
                </div>
                <div class="form-group">
                    <label>å€™è£œäººæ•¸é™åˆ¶ (0 ç‚ºä¸é™)</label>
                    <input type="number" id="c_waitlist_limit" placeholder="ä¾‹å¦‚ï¼š10" value="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>è²»ç”¨</label>
                    <input type="text" id="c_price" placeholder="ä¾‹å¦‚ï¼š21600" onblur="formatPrice(this)">
                </div>
                <div class="form-group">
                    <label>å ‚æ•¸</label>
                    <input type="text" id="c_lessons" placeholder="ä¾‹å¦‚ï¼š12" value="12">
                </div>
            </div>
            <div class="form-group">
                <label>èª²ç¨‹ä»‹ç´¹ / æ³¨æ„äº‹é …</label>
                <textarea id="c_desc"></textarea>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="saveCourse()" class="success" style="flex:1;" id="btnSave">ç¢ºèªæ–°å¢èª²ç¨‹</button>
                <button onclick="hideCourseForm()" class="warning" id="btnCancel">å–æ¶ˆè¿”å›</button>
            </div>
        </div>
    </div>

    <div id="tab-banners" class="page-section">
        <div class="form-container">
            <h3>ä¸Šå‚³æ–°æ©«å¹…</h3>
            <input type="file" id="b_file" accept="image/*">
            <button onclick="uploadBanner()" class="success">ä¸Šå‚³</button>
            <div id="bannerStatus"></div>
        </div>
        <div id="bannerList" class="banner-list"></div>
    </div>

    <div id="tab-waitlist" class="page-section">
        <div class="center-box">
            <select id="waitlistSelector" class="big-selector"><option value="all">é¸æ“‡èª²ç¨‹æŸ¥çœ‹å€™è£œ</option></select>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>èª²ç¨‹</th><th>å§“å</th><th>é›»è©±</th><th>å‚™è¨»</th><th>ç™»è¨˜æ™‚é–“</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="waitlistTable"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-classrooms" class="page-section">
        <div class="classroom-preview-list" id="classroomList"></div>
    </div>

    <div id="previewModal" class="preview-modal" onclick="closePreview()">
        <div class="preview-box" onclick="event.stopPropagation()">
            <h3 id="previewTitle"></h3>
            <div id="previewContent" style="display:flex; justify-content:center; flex-direction:column; align-items:center;"></div>
            <button onclick="closePreview()" style="margin-top:20px;">é—œé–‰</button>
        </div>
    </div>

    <script type="module">
        import { db, ref, set, remove, push, update, storage, storageRef, uploadBytes, getDownloadURL, get } from './firebase-config.js';
        import { onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        tinymce.init({ selector: '#c_desc', plugins: 'image link lists media table', toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | image', height: 400, menubar: true });

        // â˜…â˜…â˜… å®Œæ•´çš„æ•™å®¤ä½ˆå±€è¨­å®š (çµ•ç„¡çœç•¥) â˜…â˜…â˜…
        const classrooms = {
            "high_red": { name: "é«˜ä¸­ç´…æ•™å®¤", layout: [ ["1-1:X", "1-2:X", "_", "1-3", "1-4", "1-5", "_", "1-6", "1-7", "1-8", "_", "1-9:X", "1-10:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8", "_", "2-9", "2-10"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8", "_", "3-9", "3-10"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8", "_", "4-9", "4-10"], ["5-1", "5-2", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "5-8", "_", "5-9", "5-10"], ["6-1", "6-2", "_", "6-3", "6-4", "6-5", "_", "6-6", "6-7", "6-8", "_", "6-9", "6-10"], ["7-1:X", "7-2:X", "_", "7-3:X", "7-4:X", "7-5:X", "_", "7-6:X", "7-7:X", "7-8:X", "_", "7-9:X", "7-10:X"], ["8-1:X", "8-2:X", "_", "8-3:X", "8-4:X", "8-5:X", "_", "8-6:X", "8-7:X", "8-8:X", "_", "_", "DOOR"] ] },
            "high_orange": { name: "é«˜ä¸­æ©˜æ•™å®¤", layout: [ ["1-1:X", "1-2", "_", "1-3", "1-4", "1-5", "_", "1-6", "1-7", "1-8", "_", "1-9:X", "1-10:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8", "_", "2-9", "2-10"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8", "_", "3-9", "3-10"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8", "_", "4-9", "4-10"], ["5-1", "5-2", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "5-8", "_", "5-9", "5-10"], ["6-1", "6-2", "_", "6-3", "6-4", "6-5", "_", "6-6", "6-7", "6-8", "_", "6-9", "6-10"], ["_","_","_","_","_","_","_","_","_","_","_","_","DOOR"] ] },
            "high_green": { name: "é«˜ä¸­ç¶ æ•™å®¤", layout: [ ["1-1:X", "1-2", "_", "1-3", "1-4", "1-5", "_", "1-6:X", "1-7:X", "1-8:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8"], ["5-1", "5-2", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "5-8"], ["6-1:X", "6-2:X", "_", "6-3:X", "6-4:X", "6-5:X", "_", "_", "_", "DOOR"] ] },
            "high_yellow": { name: "é«˜ä¸­é»ƒæ•™å®¤", layout: [ ["1-1", "1-2:X", "_", "1-3", "1-4", "1-5", "_", "1-6:X", "1-7:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7"], ["DOOR", "_", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7"], ["_", "_", "_", "5-3:X", "5-4:X", "5-5:X", "_", "5-6:X", "5-7:X"], ["_", "_", "_", "_", "_", "_", "_", "_", "_"] ] },
            "high_blue": { name: "é«˜ä¸­è—æ•™å®¤", layout: [ ["1-1:X", "1-2", "_", "1-3", "1-4", "1-5", "_", "1-6:X", "1-7:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7"], ["5-1:X", "5-2:X", "_", "5-3:X", "5-4:X", "5-5:X", "_", "5-6:X", "5-7:X"], ["6-1:X", "6-2:X", "_", "_", "DOOR", "_", "_", "_", "_"] ] },
            "middle_new_orange": { name: "åœ‹ä¸­æ–°æ©˜æ•™å®¤", layout: [ ["1-1:X", "1-2", "_", "1-3", "1-4", "1-5", "_", "1-6", "1-7", "1-8:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8:X"], ["DOOR", "_", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "PILLAR"] ] },
            "middle_new_blue": { name: "åœ‹ä¸­æ–°è—æ•™å®¤", layout: [ ["1-1", "1-2", "1-3", "_", "1-4", "1-5", "1-6", "1-7:X"], ["2-1", "2-2", "2-3", "_", "2-4", "2-5", "2-6", "2-7:X"], ["3-1", "3-2", "3-3", "_", "3-4", "3-5", "3-6", "3-7:X"], ["4-1", "4-2", "4-3", "_", "4-4", "4-5", "4-6", "4-7:X"], ["5-1", "5-2", "5-3", "_", "5-4", "5-5", "5-6", "5-7:X"], ["6-1:X", "6-2:X", "6-3:X", "_", "6-4:X", "6-5:X", "6-6:X", "6-7:X"], ["7-1:X", "7-2:X", "7-3:X", "_", "7-4:X", "7-5:X", "7-6:X", "7-7:X"], ["DOOR", "_", "_", "_", "_", "_", "_", "_"] ] },
            "middle_new_yellow": { name: "åœ‹ä¸­æ–°é»ƒæ•™å®¤", layout: [ ["1-1", "1-2", "1-3", "_", "1-4", "1-5", "1-6", "_", "1-7", "1-8:X"], ["PILLAR", "2-2", "2-3", "_", "2-4", "2-5", "2-6", "_", "2-7", "2-8:X"], ["3-1:X", "3-2", "3-3", "_", "3-4", "3-5", "3-6", "_", "3-7", "3-8"], ["4-1", "4-2", "4-3", "_", "4-4", "4-5", "4-6", "_", "4-7", "4-8"], ["5-1", "5-2", "5-3", "_", "5-4", "5-5", "5-6", "_", "5-7", "5-8"], ["6-1:X", "6-2", "6-3", "_", "6-4", "6-5", "6-6", "_", "6-7", "6-8"], ["DOOR", "_", "_", "_", "_", "_", "_", "_", "_", "_"] ] },
            "middle_new_red": { name: "åœ‹ä¸­æ–°ç´…æ•™å®¤", layout: [ ["1-1", "1-2:X", "1-3", "_", "1-4", "1-5", "1-6", "1-7", "_", "1-8", "1-9:X", "1-10:X"], ["2-1", "2-2", "2-3", "_", "2-4", "2-5", "2-6", "2-7", "_", "2-8", "2-9", "2-10"], ["3-1", "3-2", "3-3", "_", "3-4", "3-5", "3-6", "3-7", "_", "3-8", "3-9", "3-10"], ["DOOR", "_", "_", "_", "_", "_", "_", "_", "_", "_", "_", "_"], ["4-1", "4-2", "4-3", "_", "4-4", "4-5", "4-6", "4-7", "_", "4-8", "4-9", "4-10"], ["5-1", "5-2", "5-3", "_", "5-4", "5-5", "5-6", "5-7", "_", "5-8", "5-9", "5-10"], ["6-1", "6-2", "6-3", "_", "6-4", "6-5", "6-6", "6-7", "_", "6-8", "6-9", "6-10"], ["7-1", "7-2", "7-3", "_", "7-4", "7-5", "7-6", "7-7", "_", "7-8", "7-9", "7-10"], ["8-1:X", "8-2:X", "8-3:X","_","8-4:X", "8-5:X", "8-6:X", "8-7:X", "_", "8-8:X", "8-9:X", "8-10:X"] ] },
            "middle_big_red": { name: "åœ‹ä¸­å¤§ç´…æ•™å®¤", layout: [ ["1-1:X", "1-2", "_", "1-3", "1-4", "1-5", "_", "1-6", "1-7", "1-8", "_", "1-9", "1-10:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8", "_", "2-9", "2-10"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8", "_", "3-9", "3-10"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8", "_", "4-9", "4-10"], ["5-1", "5-2", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "5-8", "_", "5-9", "5-10"], ["6-1", "6-2", "_", "6-3", "6-4", "6-5", "_", "6-6", "6-7", "6-8", "_", "6-9", "6-10"], ["7-1", "7-2", "_", "7-3", "7-4", "7-5", "_", "7-6", "7-7", "7-8", "_", "7-9", "7-10"], ["_","_","_","_","_","_","_","_","_","_","_","_","DOOR"] ] },
            "middle_da_chiao": { name: "åœ‹ä¸­å¤§æ©‹æ•™å®¤", layout: [ ["1-1:X", "1-2:X", "1-3", "_", "1-4", "1-5", "1-6", "_", "1-7", "1-8:X"], ["2-1", "2-2", "2-3", "_", "2-4", "2-5", "2-6", "_", "2-7", "2-8"], ["3-1", "3-2", "3-3", "_", "3-4", "3-5", "3-6", "_", "3-7", "3-8"], ["4-1", "4-2", "4-3", "_", "4-4", "4-5", "4-6", "_", "4-7", "4-8:X"], ["5-1", "5-2", "5-3", "_", "5-4", "5-5", "5-6", "_", "5-7", "5-8"], ["_","_","_","_","_","_","_","_","_","DOOR"] ] },
            "middle_big_green": { name: "åœ‹ä¸­å¤§ç¶ æ•™å®¤", layout: [ ["DOOR", "_", "_", "_", "_", "_"], ["1-1", "1-2", "1-3", "_", "1-4", "1-5"], ["2-1", "2-2", "2-3", "_", "2-4", "2-5"], ["3-1", "3-2", "3-3", "_", "3-4", "3-5"], ["PILLAR", "4-2", "4-3", "_", "4-4", "4-5"] ] },
            "test_room": { name: "æ¸¬è©¦å°ˆç”¨æ•™å®¤", layout: [ ["1-1", "1-2"] ] }
        };

        let allBookings = [];
        let coursesData = {};
        let waitlistData = {};
        let seatsData = {}; 

        window.switchTab = function(tabName) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tabs button').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        };
        window.showCourseForm = function() { document.getElementById('courseListView').style.display = 'none'; document.getElementById('courseFormView').style.display = 'block'; resetForm(); };
        window.hideCourseForm = function() { document.getElementById('courseListView').style.display = 'block'; document.getElementById('courseFormView').style.display = 'none'; };
        window.previewImage = function(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { document.getElementById('imgPreview').src = e.target.result; document.getElementById('imgPreview').style.display = 'block'; }; reader.readAsDataURL(input.files[0]); } };
        
        const subjectsByGrade = {
            "å‡å°äº”èª²ç¨‹": ["å°äº”é‚è¼¯æ•¸å­¸"],
            "å‡å°å…­èª²ç¨‹": ["å°å…­è³‡å„ªè‡ªç„¶", "å°å…­è³‡å„ªæ•¸å­¸"],
            "å‡åœ‹ä¸€èª²ç¨‹": ["åœ‹ä¸€è‡ªç„¶è¶…å‰", "åœ‹ä¸€æ•¸å­¸è¶…å‰", "åœ‹ä¸€ç”Ÿç‰©", "åœ‹ä¸€æ•¸å­¸"],
            "å‡åœ‹äºŒèª²ç¨‹": ["åœ‹äºŒç†åŒ–"],
            "å‡åœ‹ä¸‰èª²ç¨‹": ["åœ‹ä¸‰è‡ªç„¶ç¸½è¤‡ç¿’", "åœ‹ä¸‰æ•¸å­¸ç¸½è¤‡ç¿’", "åœ‹ä¸‰è‹±æ–‡ç¸½è¤‡ç¿’", "åœ‹ä¸‰åœ‹æ–‡ç¸½è¤‡ç¿’", "åœ‹ä¸‰ç¤¾æœƒç¸½è¤‡ç¿’"],
            "å‡é«˜ä¸€èª²ç¨‹": ["é«˜ä¸€è‡ªç„¶ï¼ˆç‰©/åŒ–ï¼‰", "é«˜ä¸€ç²˜ç«‹ç‰©ç†", "é«˜ä¸€å‘¨é€¸åŒ–å­¸", "é«˜ä¸€é»ƒæµ©æ•¸å­¸", "é«˜ä¸€æ˜è»’æ•¸å­¸", "é«˜ä¸€ç«¹ä¸­æ•¸å­¸", "é«˜ä¸€å°æšè‹±æ–‡"],
            "å‡é«˜äºŒèª²ç¨‹": ["é«˜äºŒç²˜ç«‹ç‰©ç†", "é«˜äºŒå‘¨é€¸åŒ–å­¸", "é«˜äºŒé»ƒæµ©æ•¸å­¸", "é«˜äºŒæ˜è»’æ•¸å­¸", "é«˜äºŒç«¹ä¸­æ•¸å­¸", "é«˜äºŒå°æšè‹±æ–‡"],
            "å‡é«˜ä¸‰èª²ç¨‹": ["é«˜ä¸‰ç²˜ç«‹ç‰©ç†", "é«˜ä¸‰å‘¨é€¸åŒ–å­¸", "é«˜ä¸‰é»ƒæµ©æ•¸å­¸", "é«˜ä¸‰æ˜è»’æ•¸å­¸", "å­¸æ¸¬è‹±æ–‡", "å­¸æ¸¬é»ƒæµ©æ•¸å­¸", "å­¸æ¸¬æ˜è»’æ•¸å­¸", "å­¸æ¸¬è‡ªç„¶"]
        };
        window.updateSubjects = function() { const grade = document.getElementById('c_grade').value; const list = document.getElementById('subject_list'); list.innerHTML = ""; if (subjectsByGrade[grade]) { subjectsByGrade[grade].forEach(s => list.innerHTML += `<option value="${s}">`); } };
        window.autoFillTime = function() { const type = document.getElementById('c_class_type').value; const timeInput = document.getElementById('c_time_desc'); if (type.includes("é€±")) { const day = type.replace("ç­", "").replace("é€±", "æ¯é€±"); timeInput.value = `${day} 18:30-21:30`; } };
        window.formatPrice = function(input) { let val = input.value.replace(/[^0-9]/g, ''); if (val) input.value = "$" + parseInt(val).toLocaleString(); };
        window.formatDate = function(input) { const val = input.value.trim(); if (/^\d{1,2}\/\d{1,2}$/.test(val)) { const [m, d] = val.split('/'); const date = new Date(2026, m - 1, d); const weekDay = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()]; const mm = m.padStart(2, '0'); const dd = d.padStart(2, '0'); input.value = `2026/${mm}/${dd} (${weekDay})`; } };

        const coursesRef = ref(db, 'courses');
        onValue(coursesRef, (snapshot) => {
            coursesData = snapshot.val() || {};
            renderCourseList();
            updateClassSelector(); 
            updateWaitlistSelector();
            updateDatalists();
            renderClassroomPreview();
        });

        function updateDatalists() {
            const subjects = new Set();
            const classTypes = new Set();
            Object.values(coursesData).forEach(c => {
                if(c.subject) subjects.add(c.subject);
                if(c.classType) classTypes.add(c.classType);
            });
            const subList = document.getElementById('subject_list');
            subList.innerHTML = "";
            subjects.forEach(s => subList.innerHTML += `<option value="${s}">`);
            const typeList = document.getElementById('class_type_list');
            typeList.innerHTML = "";
            classTypes.forEach(t => typeList.innerHTML += `<option value="${t}">`);
        }

        window.saveCourse = async function() {
            const btn = document.getElementById('btnSave');
            btn.disabled = true;
            btn.textContent = "è™•ç†ä¸­...";

            try {
                const id = document.getElementById('c_id').value;
                const descContent = tinymce.get('c_desc').getContent();
                const grade = document.getElementById('c_grade').value;
                const subject = document.getElementById('c_subject').value;
                const classType = document.getElementById('c_class_type').value;
                const teacher = document.getElementById('c_teacher').value;
                const classroom = document.getElementById('c_classroom').value;
                const start1 = document.getElementById('c_start1').value;
                const end1 = document.getElementById('c_end1').value;
                const start2 = document.getElementById('c_start2').value;
                const end2 = document.getElementById('c_end2').value;
                const price = document.getElementById('c_price').value;
                const lessons = document.getElementById('c_lessons').value;
                const timeDesc = document.getElementById('c_time_desc').value;
                const startDate = document.getElementById('c_start_date').value;
                const displayStart = document.getElementById('c_display_start').value;
                const displayEnd = document.getElementById('c_display_end').value;
                const fileInput = document.getElementById('c_image_file');
                const oldImageUrl = document.getElementById('c_image_url').value;
                
                const waitlistEnabled = document.getElementById('c_waitlist_enabled').checked;
                const waitlistLimit = document.getElementById('c_waitlist_limit').value;

                if (!grade || !subject || !start1) throw new Error("è«‹å¡«å¯«å®Œæ•´è³‡æ–™ï¼");

                let totalSeats = 0;
                if (classrooms[classroom]) {
                    classrooms[classroom].layout.forEach(row => {
                        row.forEach(seatCode => {
                            if (seatCode !== "_" && seatCode !== "DOOR" && seatCode !== "PILLAR" && !seatCode.includes(":X")) {
                                totalSeats++;
                            }
                        });
                    });
                }

                let imageUrl = oldImageUrl || "https://via.placeholder.com/400x200?text=No+Image";
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const storagePath = `course_images/${Date.now()}_${file.name}`;
                    const imgRef = storageRef(storage, storagePath);
                    document.getElementById('uploadStatus').textContent = "ä¸Šå‚³åœ–ç‰‡ä¸­...";
                    const metadata = { contentType: file.type };
                    await uploadBytes(imgRef, file, metadata);
                    imageUrl = await getDownloadURL(imgRef);
                }

                const courseData = {
                    grade, subject, classType, teacher, classroom,
                    start1, end1, start2, end2, price, lessons,
                    timeDescription: timeDesc, startDate: startDate,
                    displayStart, displayEnd, desc: descContent, 
                    image: imageUrl, updatedAt: Date.now(),
                    waitlistEnabled: waitlistEnabled,
                    waitlistLimit: parseInt(waitlistLimit) || 0,
                    totalSeats: totalSeats 
                };

                let courseId = id;
                if (id) {
                    await update(ref(db, `courses/${id}`), courseData);
                    alert("âœ… èª²ç¨‹æ›´æ–°æˆåŠŸï¼");
                } else {
                    const newRef = push(coursesRef);
                    courseId = newRef.key;
                    courseData.createdAt = Date.now();
                    await set(newRef, courseData);
                    alert("âœ… èª²ç¨‹æ–°å¢æˆåŠŸï¼");
                }

                const start1Time = new Date(start1).getTime();
                const end1Time = end1 ? new Date(end1).getTime() : 9999999999999;
                const start2Time = start2 ? new Date(start2).getTime() : 9999999999999;
                const end2Time = end2 ? new Date(end2).getTime() : 9999999999999;

                await set(ref(db, `seats/${courseId}/_settings`), {
                    start1: start1Time, 
                    end1: end1Time, 
                    start2: start2Time,
                    end2: end2Time
                });

                hideCourseForm();

            } catch (err) {
                alert("éŒ¯èª¤ï¼š" + err.message);
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.textContent = id ? "ç¢ºèªæ›´æ–°èª²ç¨‹" : "ç¢ºèªæ–°å¢èª²ç¨‹";
            }
        };

        window.editCourse = function(key) {
            const c = coursesData[key];
            showCourseForm();
            document.getElementById('formTitle').textContent = "âœï¸ ç·¨è¼¯èª²ç¨‹";
            document.getElementById('btnSave').textContent = "ç¢ºèªæ›´æ–°èª²ç¨‹";
            
            document.getElementById('c_id').value = key;
            document.getElementById('c_grade').value = c.grade;
            document.getElementById('c_subject').value = c.subject;
            document.getElementById('c_class_type').value = c.classType || "";
            document.getElementById('c_teacher').value = c.teacher;
            document.getElementById('c_classroom').value = c.classroom;
            document.getElementById('c_start1').value = c.start1;
            document.getElementById('c_end1').value = c.end1 || "";
            document.getElementById('c_start2').value = c.start2 || "";
            document.getElementById('c_end2').value = c.end2 || "";
            document.getElementById('c_price').value = c.price;
            document.getElementById('c_lessons').value = c.lessons || "12";
            document.getElementById('c_time_desc').value = c.timeDescription || "";
            document.getElementById('c_start_date').value = c.startDate || "";
            document.getElementById('c_display_start').value = c.displayStart || "";
            document.getElementById('c_display_end').value = c.displayEnd || "";
            document.getElementById('c_image_url').value = c.image;
            
            document.getElementById('c_waitlist_enabled').checked = c.waitlistEnabled || false;
            document.getElementById('c_waitlist_limit').value = c.waitlistLimit || 0;

            tinymce.get('c_desc').setContent(c.desc);
            
            const img = document.getElementById('imgPreview');
            img.src = c.image;
            img.style.display = 'block';
        };

        window.resetForm = function() {
            document.getElementById('formTitle').textContent = "â• æ–°å¢èª²ç¨‹";
            document.getElementById('btnSave').textContent = "ç¢ºèªæ–°å¢èª²ç¨‹";
            document.querySelectorAll('input').forEach(i => i.value = '');
            document.getElementById('c_lessons').value = "12";
            document.getElementById('c_waitlist_enabled').checked = false; 
            document.getElementById('c_waitlist_limit').value = "0"; 
            tinymce.get('c_desc').setContent('');
            document.getElementById('uploadStatus').textContent = "";
            document.getElementById('imgPreview').style.display = 'none';
        };

        function renderCourseList() {
            const listDiv = document.getElementById('courseList');
            listDiv.innerHTML = "";
            Object.keys(coursesData).forEach(key => {
                const c = coursesData[key];
                const card = document.createElement('div');
                card.className = 'admin-course-card';
                card.onclick = (e) => { if(!e.target.classList.contains('btn-delete')) editCourse(key); };
                card.innerHTML = `
                    <div class="card-thumb" style="background-image: url('${c.image}');"></div>
                    <div class="card-content">
                        <h3>[${c.grade}] ${c.subject} ${c.classType || ''}</h3>
                        <p>ğŸ‘¨â€ğŸ« ${c.teacher} | â° ${c.timeDescription || '-'}</p>
                    </div>
                    <button class="btn-delete" onclick="window.deleteCourse('${key}')">åˆªé™¤</button>
                `;
                listDiv.appendChild(card);
            });
        }

        window.deleteCourse = function(courseId) {
            if (confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤ï¼Ÿ")) remove(ref(db, `courses/${courseId}`));
        };

        const allSeatsRef = ref(db, 'seats');
        onValue(allSeatsRef, (snapshot) => {
            seatsData = snapshot.val() || {}; 
            allBookings = [];
            Object.keys(seatsData).forEach(courseId => {
                const seats = seatsData[courseId];
                const c = coursesData[courseId];
                const courseName = c ? `[${c.grade}] ${c.subject} ${c.classType || ''}` : courseId;
                Object.keys(seats).forEach(seatId => {
                    if (seatId === '_settings') return;
                    const info = seats[seatId];
                    if (info.status === 'sold' || info.status === 'locked' || info.status === 'deleted') { // é¡¯ç¤ºæ‰€æœ‰ç‹€æ…‹
                        allBookings.push({
                            courseId, courseName, seatId, status: info.status,
                            studentName: info.studentName || '-', parentPhone: info.parentPhone || '-',
                            time: info.soldTime || '-', rawTime: info.timestamp,
                            orderId: info.orderId || '-'
                        });
                    }
                });
            });
            allBookings.sort((a, b) => b.rawTime - a.rawTime);
            renderTable();
            updateStats();
            loadVisualMap();
        });

        // â˜…â˜…â˜… ä¿®æ”¹ï¼šrenderTable æ”¯æ´é¡¯ç¤º 'deleted' ç‹€æ…‹ â˜…â˜…â˜…
        function renderTable() {
            const filterId = document.getElementById('classSelector').value;
            const searchText = document.getElementById('searchInput').value.trim().toLowerCase();
            const tbody = document.getElementById('bookingTable');
            tbody.innerHTML = "";
            allBookings.forEach(b => {
                if (filterId !== 'all' && b.courseId !== filterId) return;
                if (searchText && !b.studentName.includes(searchText) && !b.parentPhone.includes(searchText) && !b.orderId.includes(searchText)) return;
                
                const tr = document.createElement('tr');
                let statusBadge = '';
                let btnText = 'é‡‹å‡º';
                let btnClass = 'danger';
                
                if (b.status === 'sold') {
                    statusBadge = '<span class="badge sold">å·²åŠƒä½</span>';
                } else if (b.status === 'locked') {
                    statusBadge = '<span class="badge locked">å¡«å¯«ä¸­</span>';
                } else if (b.status === 'deleted') {
                    statusBadge = '<span class="badge deleted">å·²é‡‹å‡º(ä¿ç•™)</span>';
                    tr.classList.add('row-deleted'); // è®Šç°
                    btnText = 'æ°¸ä¹…åˆªé™¤';
                    btnClass = 'dark'; // æ·±è‰²æŒ‰éˆ•
                }
                
                tr.innerHTML = `<td>${b.orderId}</td><td>${b.courseName}</td><td>${b.seatId}</td><td>${statusBadge}</td><td>${b.studentName}</td><td>${b.parentPhone}</td><td>${b.time}</td>
                <td>
                    <button class="warning" style="padding:5px 10px; font-size:12px;" onclick="window.editOrder('${b.courseId}', '${b.seatId}', '${b.parentPhone}', '${b.orderId}', '${b.studentName}')">ç·¨è¼¯</button>
                    <button class="${btnClass}" style="padding:5px 10px; font-size:12px;" onclick="window.releaseSeat('${b.courseId}', '${b.seatId}', '${b.status}')">${btnText}</button>
                </td>`;
                tbody.appendChild(tr);
            });
        }

        window.loadVisualMap = function() {
            const courseId = document.getElementById('classSelector').value;
            const mapContainer = document.getElementById('visualMap');
            const mapContent = document.getElementById('mapContent');
            
            if (courseId === 'all' || !coursesData[courseId]) {
                mapContainer.style.display = 'none';
                return;
            }

            mapContainer.style.display = 'block';
            mapContent.innerHTML = "";
            
            const classroomType = coursesData[courseId].classroom;
            const config = classrooms[classroomType];
            const currentSeats = seatsData[courseId] || {};

            config.layout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';
                row.forEach(seatCode => {
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    let code = seatCode;
                    let isBlocked = false;
                    if (seatCode.includes(':X')) { code = seatCode.split(':')[0]; isBlocked = true; }

                    if (code === "_") seat.classList.add('aisle');
                    else if (code === "DOOR") { seat.textContent = "é–€"; seat.classList.add('aisle'); }
                    else if (code === "PILLAR") { seat.textContent = "æŸ±"; seat.classList.add('aisle'); }
                    else {
                        seat.textContent = code;
                        const info = currentSeats[code];
                        
                        if (info) {
                            if (info.status === 'sold') {
                                seat.classList.add('sold');
                                seat.innerHTML += `<div class="seat-tooltip">${info.studentName}<br>${info.parentPhone}</div>`;
                            } else if (info.status === 'locked') {
                                seat.classList.add('locked');
                                if (info.user === 'admin_reserved') {
                                    seat.classList.add('reserved'); 
                                    seat.innerHTML += `<div class="seat-tooltip">ä¿ç•™ä½</div>`;
                                } else {
                                    seat.innerHTML += `<div class="seat-tooltip">å¡«å¯«ä¸­...</div>`;
                                }
                            }
                        }
                        
                        seat.onclick = () => toggleReserve(courseId, code, info);
                    }
                    rowDiv.appendChild(seat);
                });
                mapContent.appendChild(rowDiv);
            });
        };

        // â˜…â˜…â˜… ä¿®æ”¹ï¼štoggleReserve æ”¯æ´é»‘ç®±è½‰å”®å‡º (ä½¿ç”¨å…¨åŸŸå¯†ç¢¼) â˜…â˜…â˜…
        window.toggleReserve = async function(courseId, seatId, info) {
            const pwd = document.getElementById('adminPwd').value.trim();

            if (info && info.status === 'sold') {
                // å¦‚æœå·²ç¶“æ˜¯ soldï¼Œè©¢å•é‡‹å‡º
                if (confirm(`ç¢ºå®šè¦é‡‹å‡º ${seatId} (${info.studentName}) å—ï¼Ÿ`)) {
                    // â˜…â˜…â˜… æ”¹ç‚ºè»Ÿåˆªé™¤ â˜…â˜…â˜…
                    update(ref(db, `seats/${courseId}/${seatId}`), {
                        status: 'deleted',
                        adminPwd: pwd
                    });
                }
            } else if (info && info.status === 'deleted') {
                // å¦‚æœæ˜¯å·²è»Ÿåˆªé™¤ï¼Œè©¢å•æ°¸ä¹…åˆªé™¤
                if (confirm(`ç¢ºå®šè¦ã€æ°¸ä¹…åˆªé™¤ã€‘${seatId} çš„ç´€éŒ„å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                    set(ref(db, `seats/${courseId}/${seatId}`), null);
                }
            } else if (info && info.status === 'locked' && info.user === 'admin_reserved') {
                const action = prompt("æ­¤ç‚ºã€ç®¡ç†å“¡ä¿ç•™ä½ã€‘ã€‚è«‹é¸æ“‡æ“ä½œï¼š\nè¼¸å…¥ 'D' é‡‹å‡ºåº§ä½ (è®Šå›ç¶ è‰²)\nè¼¸å…¥ 'S' è½‰ç‚ºå·²å”®å‡º (è®Šç´…è‰²)", "D");
                
                if (action && action.toUpperCase() === 'D') {
                    set(ref(db, `seats/${courseId}/${seatId}`), null);
                } else if (action && action.toUpperCase() === 'S') {
                    if (!pwd) { alert("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼æ‰èƒ½è½‰ç‚ºå”®å‡ºï¼"); return; }
                    
                    const name = prompt("è«‹è¼¸å…¥å­¸ç”Ÿå§“å (ç•™ç©ºå‰‡ç‚º'ç¾å ´ä¿ç•™')", "ç¾å ´ä¿ç•™");
                    const phone = prompt("è«‹è¼¸å…¥å®¶é•·é›»è©± (ç•™ç©ºå‰‡ç‚º'0000000000')", "0000000000");
                    
                    const orderId = "ADMIN_" + Date.now();
                    const seatData = {
                        status: 'sold',
                        studentName: name,
                        parentPhone: phone,
                        soldTime: new Date().toLocaleString(),
                        orderId: orderId,
                        adminPwd: pwd 
                    };
                    
                    set(ref(db, `seats/${courseId}/${seatId}`), seatData).then(() => {
                        alert("å·²æˆåŠŸè½‰ç‚ºå·²å”®å‡ºï¼");
                    }).catch(err => alert("å¤±æ•—ï¼š" + err.message));
                }
            } else if (!info) {
                if (!pwd) { alert("âš ï¸ è«‹å…ˆè¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼æ‰èƒ½é€²è¡Œé»‘ç®±ä¿ç•™ï¼"); return; }
                
                const snap = await get(ref(db, `seats/${courseId}/${seatId}`));
                if (snap.exists() && snap.val().status === 'sold') {
                     if (!confirm("âš ï¸ è­¦å‘Šï¼šé€™å€‹ä½å­å‰›å‰›è¢«å­¸ç”Ÿæ¶èµ°äº†ï¼ç¢ºå®šè¦å¼·åˆ¶è¦†è“‹å—ï¼Ÿ")) return;
                }

                if (confirm(`è¦å°‡ ${seatId} è¨­ç‚ºä¿ç•™ä½å—ï¼Ÿ(å‰å°é¡¯ç¤ºç‚ºå¡«å¯«ä¸­)`)) {
                    set(ref(db, `seats/${courseId}/${seatId}`), {
                        status: 'locked',
                        user: 'admin_reserved',
                        timestamp: Date.now(),
                        adminPwd: pwd 
                    }).catch(err => {
                        alert("ä¿ç•™å¤±æ•—ï¼šå¯†ç¢¼éŒ¯èª¤æˆ–æ¬Šé™ä¸è¶³ï¼");
                    });
                }
            }
        };

        function updateClassSelector() {
            const selector = document.getElementById('classSelector');
            const currentVal = selector.value;
            selector.innerHTML = '<option value="all">å…¨éƒ¨èª²ç¨‹ç¸½è¦½</option>';
            Object.keys(coursesData).forEach(key => {
                const c = coursesData[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `[${c.grade}] ${c.subject} ${c.classType || ''}`;
                selector.appendChild(option);
            });
            selector.value = currentVal;
        }

        // â˜…â˜…â˜… ä¿®æ”¹ï¼šreleaseSeat æ”¯æ´è»Ÿåˆªé™¤/ç¡¬åˆªé™¤é‚è¼¯ â˜…â˜…â˜…
        window.releaseSeat = function(courseId, seatId, currentStatus) {
            const pwd = document.getElementById('adminPwd').value.trim();
            if (!pwd) return alert("è«‹å…ˆè¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼");

            if (currentStatus === 'deleted') {
                if (confirm("âš ï¸ ç¢ºå®šè¦ã€æ°¸ä¹…åˆªé™¤ã€‘æ­¤ç´€éŒ„å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚")) {
                    set(ref(db, `seats/${courseId}/${seatId}`), null); // ç¡¬åˆªé™¤
                }
            } else {
                if (confirm("ç¢ºå®šé‡‹å‡ºåº§ä½ï¼Ÿ(è³‡æ–™å°‡ä¿ç•™ä¸¦æ¨™è¨˜ç‚ºå·²é‡‹å‡º)")) {
                    update(ref(db, `seats/${courseId}/${seatId}`), {
                        status: 'deleted', // è»Ÿåˆªé™¤
                        adminPwd: pwd
                    });
                }
            }
        };

        window.editOrder = async function(courseId, seatId, oldPhone, orderId, oldName) {
            const pwd = document.getElementById('adminPwd').value.trim();
            if (!pwd) return alert("è«‹å…ˆè¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼");

            const newName = prompt("ä¿®æ”¹å­¸ç”Ÿå§“åï¼š", oldName);
            if (newName === null) return;
            const newPhone = prompt("ä¿®æ”¹å®¶é•·é›»è©± (è‹¥ä¿®æ”¹é›»è©±ï¼Œç³»çµ±å°‡è‡ªå‹•æ¬ç§»è¨‚å–®)ï¼š", oldPhone);
            if (newPhone === null) return;

            try {
                const seatUpdate = {
                    studentName: newName,
                    parentPhone: newPhone,
                    adminPwd: pwd
                };
                await update(ref(db, `seats/${courseId}/${seatId}`), seatUpdate);

                if (newPhone !== oldPhone) {
                    const oldOrderRef = ref(db, `orders/${oldPhone}/${orderId}`);
                    const snap = await get(oldOrderRef);
                    if (snap.exists()) {
                        const orderData = snap.val();
                        orderData.studentName = newName;
                        orderData.parentPhone = newPhone;
                        orderData.adminPwd = pwd;
                        await set(ref(db, `orders/${newPhone}/${orderId}`), orderData);
                        await remove(oldOrderRef);
                    }
                } else {
                    await update(ref(db, `orders/${oldPhone}/${orderId}`), { 
                        studentName: newName,
                        adminPwd: pwd
                    });
                }
                alert("ä¿®æ”¹æˆåŠŸï¼");
            } catch (err) {
                alert("ä¿®æ”¹å¤±æ•—ï¼š" + err.message);
                console.error(err);
            }
        };

        function updateStats() {
            document.getElementById('totalSold').textContent = allBookings.filter(b => b.status === 'sold').length;
        }

        window.exportToCSV = function() {
            let csv = "\uFEFFè¨‚å–®ç·¨è™Ÿ,èª²ç¨‹,åº§ä½,ç‹€æ…‹,å§“å,é›»è©±,æ™‚é–“\n";
            allBookings.forEach(b => csv += `'${b.orderId},${b.courseName},${b.seatId},${b.status},${b.studentName},'${b.parentPhone},${b.time}\n`);
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "booking_data.csv";
            link.click();
        };

        document.getElementById('classSelector').addEventListener('change', () => {
            const sel = document.getElementById('classSelector');
            document.getElementById('currentClassName').textContent = sel.options[sel.selectedIndex].text;
            renderTable();
            loadVisualMap();
        });
        document.getElementById('searchInput').addEventListener('input', renderTable);

        const bannersRef = ref(db, 'banners');
        onValue(bannersRef, (snapshot) => {
            const data = snapshot.val() || {};
            const list = document.getElementById('bannerList');
            list.innerHTML = "";
            Object.keys(data).forEach(key => {
                const b = data[key];
                const item = document.createElement('div');
                item.className = 'banner-item';
                item.innerHTML = `<img src="${b.url}"><button class="btn-delete" onclick="window.deleteBanner('${key}')">åˆªé™¤</button>`;
                list.appendChild(item);
            });
        });

        window.uploadBanner = async function() {
            const fileInput = document.getElementById('b_file');
            if (fileInput.files.length === 0) return alert("è«‹é¸æ“‡åœ–ç‰‡");
            const file = fileInput.files[0];
            const storagePath = `banners/${Date.now()}_${file.name}`;
            const imgRef = storageRef(storage, storagePath);
            document.getElementById('bannerStatus').textContent = "ä¸Šå‚³ä¸­...";
            const metadata = { contentType: file.type };
            await uploadBytes(imgRef, file, metadata);
            const url = await getDownloadURL(imgRef);
            await push(bannersRef, { url: url, createdAt: Date.now() });
            document.getElementById('bannerStatus').textContent = "";
            fileInput.value = "";
        };

        window.deleteBanner = function(key) {
            if (confirm("ç¢ºå®šåˆªé™¤æ­¤æ©«å¹…ï¼Ÿ")) remove(ref(db, `banners/${key}`));
        };

        const waitlistRef = ref(db, 'waitlist');
        onValue(waitlistRef, (snapshot) => {
            waitlistData = snapshot.val() || {};
            updateWaitlistSelector();
            renderWaitlistTable();
        });

        function updateWaitlistSelector() {
            const selector = document.getElementById('waitlistSelector');
            const currentVal = selector.value;
            selector.innerHTML = '<option value="all">é¸æ“‡èª²ç¨‹æŸ¥çœ‹å€™è£œ</option>';
            Object.keys(coursesData).forEach(key => {
                const c = coursesData[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `[${c.grade}] ${c.subject} ${c.classType || ''}`;
                selector.appendChild(option);
            });
            selector.value = currentVal;
        }

        // â˜…â˜…â˜… ä¿®æ”¹ï¼šrenderWaitlistTable æ”¯æ´é¡¯ç¤º 'deleted' ç‹€æ…‹ â˜…â˜…â˜…
        function renderWaitlistTable() {
            const filterId = document.getElementById('waitlistSelector').value;
            const tbody = document.getElementById('waitlistTable');
            tbody.innerHTML = "";
            if (filterId === 'all') return;
            const list = waitlistData[filterId] || {};
            const sortedList = Object.keys(list).map(key => ({ ...list[key], key })).sort((a, b) => a.timestamp - b.timestamp);
            
            sortedList.forEach(w => {
                const tr = document.createElement('tr');
                const time = new Date(w.timestamp).toLocaleString();
                
                let btnText = 'åˆªé™¤';
                let btnClass = 'danger';
                
                if (w.status === 'deleted') {
                    tr.classList.add('row-deleted'); // è®Šç°
                    btnText = 'æ°¸ä¹…åˆªé™¤';
                    btnClass = 'dark';
                }

                tr.innerHTML = `
                    <td>${coursesData[filterId].subject} ${coursesData[filterId].classType || ''}</td>
                    <td>${w.studentName}</td>
                    <td>${w.parentPhone}</td>
                    <td>${w.note || '-'}</td>
                    <td>${time}</td>
                    <td>
                        <button class="warning" style="padding:5px 10px; font-size:12px;" onclick="window.editWaitlist('${filterId}', '${w.key}', '${w.studentName}', '${w.parentPhone}', '${w.note}')">ç·¨è¼¯</button>
                        <button class="${btnClass}" style="padding:5px 10px; font-size:12px;" onclick="window.deleteWaitlist('${filterId}', '${w.key}', '${w.status}')">${btnText}</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        // â˜…â˜…â˜… ä¿®æ”¹ï¼šdeleteWaitlist æ”¯æ´è»Ÿåˆªé™¤/ç¡¬åˆªé™¤é‚è¼¯ â˜…â˜…â˜…
        window.deleteWaitlist = function(courseId, waitlistId, currentStatus) {
            const pwd = document.getElementById('adminPwd').value.trim();
            if (!pwd) return alert("è«‹å…ˆè¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼");

            if (currentStatus === 'deleted') {
                if (confirm("ç¢ºå®šè¦ã€æ°¸ä¹…åˆªé™¤ã€‘æ­¤å€™è£œå—ï¼Ÿ")) {
                    set(ref(db, `waitlist/${courseId}/${waitlistId}`), null);
                }
            } else {
                if (confirm("ç¢ºå®šç§»é™¤æ­¤å€™è£œï¼Ÿ(è³‡æ–™å°‡ä¿ç•™)")) {
                    update(ref(db, `waitlist/${courseId}/${waitlistId}`), {
                        status: 'deleted',
                        adminPwd: pwd
                    });
                }
            }
        };

        window.editWaitlist = function(courseId, waitlistId, oldName, oldPhone, oldNote) {
            const pwd = document.getElementById('adminPwd').value.trim();
            if (!pwd) return alert("è«‹å…ˆè¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼");

            const newName = prompt("ä¿®æ”¹å§“å", oldName);
            const newPhone = prompt("ä¿®æ”¹é›»è©±", oldPhone);
            const newNote = prompt("ä¿®æ”¹å‚™è¨»", oldNote);

            if (newName && newPhone) {
                update(ref(db, `waitlist/${courseId}/${waitlistId}`), {
                    studentName: newName,
                    parentPhone: newPhone,
                    note: newNote,
                    adminPwd: pwd
                }).then(() => alert("ä¿®æ”¹æˆåŠŸ")).catch(e => alert("ä¿®æ”¹å¤±æ•—ï¼š" + e.message));
            }
        };

        document.getElementById('waitlistSelector').addEventListener('change', renderWaitlistTable);

        function renderClassroomPreview() {
            const list = document.getElementById('classroomList');
            list.innerHTML = "";
            Object.keys(classrooms).forEach(key => {
                const c = classrooms[key];
                const card = document.createElement('div');
                card.className = 'classroom-card';
                card.innerHTML = `<h4>${c.name}</h4><div style="font-size:12px; color:#666;">ä»£ç¢¼: ${key}</div>`;
                card.onclick = () => showPreview(key); 
                list.appendChild(card);
            });
        }
        
        window.showPreview = function(key) {
            const modal = document.getElementById('previewModal');
            const title = document.getElementById('previewTitle');
            const content = document.getElementById('previewContent');
            const config = classrooms[key];
            
            title.textContent = config.name;
            content.innerHTML = "";
            
            config.layout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';
                row.forEach(seatCode => {
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    let code = seatCode;
                    if (seatCode.includes(':X')) { code = seatCode.split(':')[0]; seat.classList.add('blocked'); }
                    if (code === "_") seat.classList.add('aisle');
                    else if (code === "DOOR") { seat.textContent = "é–€"; seat.classList.add('aisle'); }
                    else if (code === "PILLAR") { seat.textContent = "æŸ±"; seat.classList.add('aisle'); }
                    else seat.textContent = code;
                    rowDiv.appendChild(seat);
                });
                content.appendChild(rowDiv);
            });
            
            modal.style.display = "flex";
        };
        
        window.closePreview = function() {
            document.getElementById('previewModal').style.display = "none";
        };
        
        renderClassroomPreview();

        const ZOMBIE_TIMEOUT = 2 * 60 * 1000; 
        const SWEEP_INTERVAL = 10 * 1000; 

        function startZombieSweeper() {
            const statusDiv = document.getElementById('sweeperStatus');
            
            setInterval(() => {
                const now = Date.now();
                let clearedCount = 0;

                Object.keys(seatsData).forEach(courseId => {
                    const seats = seatsData[courseId];
                    Object.keys(seats).forEach(seatId => {
                        if (seatId === '_settings') return;
                        const info = seats[seatId];
                        
                        if (info.status === 'locked' && info.user !== 'admin_reserved') {
                            if (now - info.timestamp > ZOMBIE_TIMEOUT) {
                                set(ref(db, `seats/${courseId}/${seatId}`), null);
                                clearedCount++;
                                console.log(`[Sweeper] æ¸…é™¤æ®­å±åº§ä½: ${courseId} - ${seatId}`);
                            }
                        }
                    });
                });

                if (clearedCount > 0) {
                    statusDiv.textContent = `ğŸ§¹ å‰›å‰›æ¸…é™¤äº† ${clearedCount} å€‹æ®­å±åº§ä½`;
                    statusDiv.style.backgroundColor = "#e74c3c";
                    setTimeout(() => {
                        statusDiv.textContent = "ğŸ§¹ æ®­å±æ¸…é™¤å™¨ï¼šå¾…å‘½";
                        statusDiv.style.backgroundColor = "rgba(0,0,0,0.7)";
                    }, 3000);
                }
            }, SWEEP_INTERVAL);
        }

        startZombieSweeper();

    </script>
</body>
</html>