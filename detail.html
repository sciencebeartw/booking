<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²ç¨‹è©³æƒ… - å±±ç†Šç§‘å­¸</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f8f9fa; margin: 0; padding: 0; }
        header { background: #2c3e50; padding: 15px 20px; display: flex; justify-content: center; align-items: center; gap: 20px; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header img { height: 60px; }
        header h1 { margin: 0; font-size: 24px; letter-spacing: 1px; text-align: center; color: white; }
        .container { max-width: 900px; margin: 40px auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-size: 16px; font-weight: bold; border: 1px solid #3498db; padding: 8px 20px; border-radius: 20px; transition: 0.3s; }
        .back-link:hover { background: #3498db; color: white; }
        .course-header { display: flex; gap: 30px; margin-bottom: 40px; flex-wrap: wrap; }
        .course-img { flex: 1; min-width: 300px; height: 300px; background-size: cover; background-position: center; border-radius: 10px; background-color: #eee; }
        .course-meta { flex: 1; min-width: 300px; }
        .badge { display: inline-block; padding: 5px 10px; background: #e74c3c; color: white; border-radius: 5px; font-size: 14px; margin-bottom: 10px; }
        h1 { margin: 0 0 15px 0; color: #2c3e50; font-size: 32px; }
        .price { font-size: 28px; color: #27ae60; font-weight: bold; margin-bottom: 20px; }
        .info-item { margin-bottom: 10px; font-size: 16px; color: #555; }
        .info-item strong { color: #333; margin-right: 10px; }
        .countdown-box { background: #fdf2e9; border: 2px solid #f39c12; padding: 20px; border-radius: 10px; text-align: center; margin-top: 30px; }
        
        /* â˜…â˜…â˜… ä¿®æ”¹ï¼šå¼·åˆ¶æ–‡å­—ä¸æ›è¡Œ â˜…â˜…â˜… */
        .timer-label { font-size: 16px; color: #d35400; margin-bottom: 5px; white-space: nowrap; }
        .timer-text { font-size: 28px; font-weight: bold; color: #d35400; font-family: monospace; white-space: nowrap; }
        
        .btn-action { display: inline-block; width: 100%; padding: 15px; text-align: center; border: none; border-radius: 8px; font-size: 20px; font-weight: bold; cursor: pointer; text-decoration: none; transition: 0.3s; margin-top: 10px; }
        .btn-disabled { background: #bdc3c7; color: white; cursor: not-allowed; pointer-events: none; }
        .btn-active { background: #27ae60; color: white; box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4); }
        .btn-active:hover { background: #219150; transform: translateY(-2px); }
        .course-desc { border-top: 1px solid #eee; margin-top: 40px; padding-top: 30px; line-height: 1.8; color: #333; }
        .course-desc img { max-width: 100%; height: auto; border-radius: 5px; }
        .bottom-action-area { margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px; }
        footer { text-align: center; padding: 40px; color: #999; font-size: 14px; background-color: #2c3e50; color: white; margin-top: 80px; }
        .float-line-btn { position: fixed; bottom: 25px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background-color: #06C755; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 9999; cursor: pointer; transition: transform 0.2s; animation: bounce 2s ease-in-out infinite; display: flex; align-items: center; justify-content: center; text-decoration: none; color: white; font-weight: 900; font-size: 1.2rem; font-family: Arial, sans-serif; letter-spacing: 0.5px; }
        .float-line-btn:active { transform: scale(0.9); animation: none; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }

        /* â˜…â˜…â˜… æ–°å¢ï¼šæ‰‹æ©Ÿç‰ˆå¾®èª¿å­—é«”ï¼Œç¢ºä¿ä¸æ›è¡Œæ™‚ä¸æœƒçˆ†ç‰ˆ â˜…â˜…â˜… */
        @media (max-width: 768px) {
            .timer-text { font-size: 22px; }
            .timer-label { font-size: 15px; }
        }
    </style>
</head>
<body>

    <header>
        <img src="logo1.png" alt="å±±ç†Šç§‘å­¸">
        <h1>å±±ç†Šç§‘å­¸ / å±±ç†Šå‡å¤§</h1>
        <img src="logo2.png" alt="å±±ç†Šå‡å¤§">
    </header>

    <div class="container">
        <a href="index.html" class="back-link">â¬… å›åˆ°èª²ç¨‹åˆ—è¡¨</a>
        
        <div id="loading" style="text-align:center; padding:50px;">è¼‰å…¥ä¸­...</div>

        <div id="content" style="display:none;">
            <div class="course-header">
                <div class="course-img" id="c_img"></div>
                <div class="course-meta">
                    <span class="badge" id="c_grade">å¹´ç´š</span>
                    <h1 id="c_title">èª²ç¨‹åç¨±</h1>
                    <div class="price" id="c_price">$0</div>
                    
                    <div class="info-item"><strong>â° ä¸Šèª²æ™‚é–“:</strong> <span id="c_time_desc">-</span></div>
                    <div class="info-item"><strong>ğŸ‘¨â€ğŸ« æˆèª²è€å¸«:</strong> <span id="c_teacher">-</span></div>
                    <div class="info-item"><strong>ğŸ“ ä¸Šèª²æ•™å®¤:</strong> <span id="c_classroom">-</span></div>
                    <div class="info-item"><strong>ğŸ“… é–‹èª²æ—¥æœŸ:</strong> <span id="c_start_date">-</span></div>
                    
                    <div id="time_labels"></div>
                </div>
            </div>

            <div class="course-desc">
                <h3>èª²ç¨‹ä»‹ç´¹</h3>
                <div id="c_desc_content"></div>
            </div>

            <div class="bottom-action-area">
                <div class="countdown-box">
                    <div id="timerLabel" class="timer-label">è·é›¢é–‹æ”¾é‚„æœ‰</div>
                    <div id="timerText" class="timer-text">è¨ˆç®—ä¸­...</div>
                    <a href="#" id="actionBtn" class="btn-action btn-disabled">å°šæœªé–‹æ”¾</a>
                </div>
            </div>
        </div>
    </div>

    <footer>
        &copy; 2024 å±±ç†Šç§‘å­¸è£œç¿’ç­ | ç³»çµ±é–‹ç™¼ï¼šSciencebear Tech Team
    </footer>

    <a href="https://lin.ee/oGKweky" target="_blank" class="float-line-btn" title="è¯ç¹«å®˜æ–¹LINE">LINE</a>

    <script type="module">
        import { db, ref, child } from './firebase-config.js';
        import { onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const classroomNames = {
            "high_red": "é«˜ä¸­ç´…æ•™å®¤", "high_orange": "é«˜ä¸­æ©˜æ•™å®¤", "high_green": "é«˜ä¸­ç¶ æ•™å®¤",
            "high_yellow": "é«˜ä¸­é»ƒæ•™å®¤", "high_blue": "é«˜ä¸­è—æ•™å®¤",
            "middle_new_orange": "åœ‹ä¸­æ–°æ©˜æ•™å®¤", "middle_new_blue": "åœ‹ä¸­æ–°è—æ•™å®¤", "middle_new_yellow": "åœ‹ä¸­æ–°é»ƒæ•™å®¤",
            "middle_new_red": "åœ‹ä¸­æ–°ç´…æ•™å®¤", "middle_big_red": "åœ‹ä¸­å¤§ç´…æ•™å®¤",
            "middle_da_chiao": "åœ‹ä¸­å¤§æ©‹æ•™å®¤", "middle_big_green": "åœ‹ä¸­å¤§ç¶ æ•™å®¤",
            "test_room": "ğŸ§ª æ¸¬è©¦å°ˆç”¨æ•™å®¤"
        };

        const params = new URLSearchParams(window.location.search);
        const courseId = params.get('id') ? params.get('id').trim() : null;

        if (!courseId) {
            alert("ç„¡æ•ˆçš„èª²ç¨‹é€£çµï¼");
            window.location.href = "index.html"; 
        }

        const dbRef = ref(db, `courses/${courseId}`);
        
        onValue(dbRef, (snapshot) => {
            if (snapshot.exists()) {
                const c = snapshot.val();
                c.id = courseId; 
                renderPage(c);
            } else {
                console.error("èª²ç¨‹ä¸å­˜åœ¨:", courseId);
                alert("æ‰¾ä¸åˆ°æ­¤èª²ç¨‹ï¼");
                window.location.href = "index.html"; 
            }
        }, (error) => {
            console.error("è®€å–å¤±æ•—:", error);
            alert("è®€å–èª²ç¨‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™ã€‚");
        });

        let timerInterval = null;

        function renderPage(c) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            const title = `${c.subject} ${c.classType || ''}`;
            document.title = `${title} - èª²ç¨‹è©³æƒ…`;
            
            document.getElementById('c_img').style.backgroundImage = `url('${c.image}')`;
            document.getElementById('c_grade').textContent = c.grade;
            document.getElementById('c_title').textContent = title;
            document.getElementById('c_price').textContent = c.price;
            document.getElementById('c_teacher').textContent = c.teacher;
            document.getElementById('c_time_desc').textContent = c.timeDescription || '-';
            document.getElementById('c_start_date').textContent = c.startDate || '-';
            document.getElementById('c_classroom').textContent = classroomNames[c.classroom] || c.classroom; 
            document.getElementById('c_desc_content').innerHTML = c.desc;

            const start1 = new Date(c.start1);
            const hasStart2 = c.start2 && new Date(c.start2).getFullYear() < 3000;

            const timeLabels = document.getElementById('time_labels');
            let html = '';

            if (hasStart2) {
                html += `<div class="info-item"><strong>ğŸ”¥ ä¸€éšé–‹æ”¾:</strong> ${start1.toLocaleString()}</div>`;
                html += `<div class="info-item"><strong>ğŸ”¥ äºŒéšé–‹æ”¾:</strong> ${new Date(c.start2).toLocaleString()}</div>`;
            } else {
                html += `<div class="info-item"><strong>ğŸ”¥ åŠƒä½é–‹æ”¾:</strong> ${start1.toLocaleString()}</div>`;
            }
            timeLabels.innerHTML = html;

            if (timerInterval) clearInterval(timerInterval);
            startTimer(c);
        }

        function startTimer(c) {
            const timerLabel = document.getElementById('timerLabel');
            const timerText = document.getElementById('timerText');
            const btn = document.getElementById('actionBtn');

            const start1 = new Date(c.start1).getTime();
            const end1 = c.end1 ? new Date(c.end1).getTime() : 9999999999999;
            const start2 = c.start2 ? new Date(c.start2).getTime() : 9999999999999;
            const end2 = c.end2 ? new Date(c.end2).getTime() : 9999999999999;

            const hasStart2 = c.start2 && new Date(c.start2).getFullYear() < 3000;

            function update() {
                const now = Date.now();

                if (now < start1) {
                    const diff = start1 - now;
                    timerLabel.textContent = "è·é›¢é–‹æ”¾é‚„æœ‰";
                    timerText.textContent = formatTime(diff);
                    btn.textContent = "å°šæœªé–‹æ”¾";
                    btn.className = "btn-action btn-disabled";
                }
                else if (now >= start1 && now < end1) {
                    timerLabel.textContent = "ğŸ”¥ ç›®å‰ç‹€æ…‹";
                    timerText.textContent = "é–‹æ”¾åŠƒä½ä¸­";
                    btn.textContent = "å‰å¾€åŠƒä½ âœ";
                    btn.className = "btn-action btn-active";
                    btn.href = `booking.html?class=${c.id}`;
                }
                else if (now >= end1 && now < start2 && hasStart2) {
                    const diff = start2 - now;
                    timerLabel.textContent = "ç³»çµ±æ•´ç†ä¸­ (æš«åœé–‹æ”¾)";
                    timerText.textContent = `è·é›¢äºŒéšé‚„æœ‰ï¼š${formatTime(diff)}`;
                    btn.textContent = "æš«åœé–‹æ”¾";
                    btn.className = "btn-action btn-disabled";
                }
                else if (hasStart2 && now >= start2 && now < end2) {
                    timerLabel.textContent = "ğŸ”¥ ç›®å‰ç‹€æ…‹";
                    timerText.textContent = "ç¬¬äºŒéšæ®µé–‹æ”¾ä¸­ (å«å€™è£œ)";
                    btn.textContent = "å‰å¾€åŠƒä½ âœ";
                    btn.className = "btn-action btn-active";
                    btn.href = `booking.html?class=${c.id}`;
                }
                else {
                    timerLabel.textContent = "â›” ç‹€æ…‹";
                    timerText.textContent = "åŠƒä½å·²çµæŸ";
                    btn.textContent = "å·²æˆªæ­¢";
                    btn.className = "btn-action btn-disabled";
                }
            }

            timerInterval = setInterval(update, 1000);
            update();
        }

        function formatTime(ms) {
            const totalSec = Math.floor(ms / 1000);
            const h = Math.floor(totalSec / 3600);
            const m = Math.floor((totalSec % 3600) / 60);
            const s = totalSec % 60;
            return `${h}æ™‚ ${m}åˆ† ${s}ç§’`;
        }
    </script>
</body>
</html>