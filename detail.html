<!-- æª”æ¡ˆï¼šdetail.html -->
<!-- ç‰ˆæœ¬ï¼šV33.0 (æ”¯æ´è³‡æ–™é©…å‹•éœæ…‹é è¦½) -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²ç¨‹è©³æƒ… - å±±ç†Šç§‘å­¸</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f8f9fa; margin: 0; padding: 0; }
        header { background: #2c3e50; padding: 15px 20px; display: flex; justify-content: center; align-items: center; gap: 20px; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header img { height: 60px; }
        header h1 { margin: 0; font-size: 24px; letter-spacing: 1px; text-align: center; color: white; }
        .container { max-width: 900px; margin: 40px auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-size: 16px; font-weight: bold; border: 1px solid #3498db; padding: 8px 20px; border-radius: 20px; transition: 0.3s; }
        .back-link:hover { background: #3498db; color: white; }
        .course-header { display: flex; gap: 30px; margin-bottom: 40px; flex-wrap: wrap; }
        .course-img { flex: 1; min-width: 300px; height: 300px; background-size: cover; background-position: center; border-radius: 10px; background-color: #eee; }
        .course-meta { flex: 1; min-width: 300px; }
        .badge { display: inline-block; padding: 5px 10px; background: #e74c3c; color: white; border-radius: 5px; font-size: 14px; margin-bottom: 10px; }
        h1 { margin: 0 0 15px 0; color: #2c3e50; font-size: 32px; }
        .price { font-size: 28px; color: #27ae60; font-weight: bold; margin-bottom: 20px; }
        .info-item { margin-bottom: 10px; font-size: 16px; color: #555; }
        .info-item strong { color: #333; margin-right: 10px; }
        .countdown-box { background: #fdf2e9; border: 2px solid #f39c12; padding: 20px; border-radius: 10px; text-align: center; margin-top: 30px; box-sizing: border-box; width: 100%; }
        
        .timer-label { font-size: 16px; color: #d35400; margin-bottom: 5px; white-space: nowrap; }
        .timer-text { font-size: 28px; font-weight: bold; color: #d35400; font-family: monospace; white-space: nowrap; }
        
        .btn-action { display: inline-block; width: 100%; padding: 15px; text-align: center; border: none; border-radius: 8px; font-size: 20px; font-weight: bold; cursor: pointer; text-decoration: none; transition: 0.3s; margin-top: 10px; box-sizing: border-box; }
        .btn-disabled { background: #bdc3c7; color: white; cursor: not-allowed; pointer-events: none; }
        .btn-active { background: #27ae60; color: white; box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4); }
        .btn-active:hover { background: #219150; transform: translateY(-2px); }
        .course-desc { border-top: 1px solid #eee; margin-top: 40px; padding-top: 30px; line-height: 1.8; color: #333; }
        .course-desc img { max-width: 100%; height: auto; border-radius: 5px; }
        .bottom-action-area { margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px; }
        footer { text-align: center; padding: 40px; color: #999; font-size: 14px; background-color: #2c3e50; color: white; margin-top: 80px; }
        
        /* â˜…â˜…â˜… æ•™å®¤é è¦½æ¨£å¼ (ç§»æ¤è‡ª booking.html ä¸¦èª¿æ•´ç‚ºéœæ…‹å±•ç¤º) â˜…â˜…â˜… */
        .preview-section { margin-top: 40px; padding: 20px; background: #f9f9f9; border-radius: 10px; border: 1px dashed #ccc; }
        .preview-title { text-align: center; font-weight: bold; color: #2c3e50; margin-bottom: 5px; font-size: 18px; }
        .preview-subtitle { text-align: center; color: #7f8c8d; font-size: 13px; margin-bottom: 20px; }
        
        .classroom-wrapper { 
            overflow-x: auto; 
            padding-bottom: 10px; 
            text-align: center; 
            user-select: none; 
            -webkit-overflow-scrolling: touch; 
        }
        
        /* â˜… çµ‚æ¥µç½®ä¸­è§£æ³•ï¼šè®“å®ƒè®Šæˆå€å¡Šï¼Œå¯¬åº¦è²¼åˆå…§å®¹ï¼Œç„¶å¾Œå·¦å³è‡ªå‹•æ¨æ“ ç½®ä¸­ï¼ */
        .classroom-inner {
            display: block;
            width: max-content;
            margin: 0 auto;
        }

        /* ç¢ºä¿è¬›å°èˆ‡åº§ä½è¡¨å¡«æ»¿ inner çš„çœŸå¯¦å¯¬åº¦ */
        #stageArea, #classroomGrid {
            display: block; 
            width: 100%;
        }

        .stage-box { 
            width: 100%; /* è¬›å°æœƒè‡ªå‹•æ‹‰ä¼¸åˆ°è·Ÿåº§ä½ä¸€æ¨¡ä¸€æ¨£å¯¬ */
            margin: 0 auto 20px auto; 
            padding: 8px; 
            border: 2px solid #333; 
            background-color: #fff; 
            font-weight: bold; 
            font-size: 16px; 
            letter-spacing: 5px; 
            text-align: center; 
            color: #333; 
            box-sizing: border-box;
        }
        
        .row { 
            display: flex; 
            justify-content: center; 
            gap: 5px; 
            margin-bottom: 10px; 
        }
        
        /* é è¦½æ™‚åº§ä½ç¨å¾®ç¸®å°ä¸€é»ï¼Œä¸”é è¨­ç‚ºç¶ è‰² (ä»£è¡¨ä½ç½®å­˜åœ¨) */
        /* â˜…â˜…â˜… V33.2 é›»è…¦ç‰ˆçµ‚æ¥µä¿®æ­£ï¼šå­—é«”éš¨è¦–çª—ç¸®æ”¾ + çµ•å°ä¸æ›è¡Œ â˜…â˜…â˜… */
        /* â˜…â˜…â˜… V33.3 ä¿®æ­£ï¼šåŒæ­¥å¯¬åº¦ + è™•ç†ç€è¦½å™¨æœ€å°å­—é«”é™åˆ¶ â˜…â˜…â˜… */
        .seat { 
            /* 1. çµ±ä¸€æ¨™æº–ï¼šé€™è£¡è¨­ 45ï¼Œä¸‹é¢ flex ä¹Ÿè¦ 45 */
            width: 45px; 
            height: auto; 
            aspect-ratio: 45 / 55; 
            
            /* 2. å½ˆæ€§è¨­å®šï¼šåŸºæº–å€¼æ”¹ç‚º 45pxï¼Œå…è¨±ç¸®å°åˆ° 28px */
            flex: 0 1 45px; 
            min-width: 28px; 

            /* 3. å­—é«”é­”æ³•ï¼š
               æœ€å°è¨­ 10px (é€™æ˜¯å¤§éƒ¨åˆ†ç€è¦½å™¨çš„ç‰©ç†æ¥µé™)
               ä¸­é–“æ”¹ 2vw (è®“å®ƒå°è¦–çª—å¯¬åº¦æ›´æ•æ„Ÿ)
               æœ€å¤§ 14px 
            */
            font-size: clamp(10px, 2vw, 14px); 
            
            /* 4. éµè¡€ç´€å¾‹ï¼šçµ•å°ä¸æ›è¡Œï¼Œè¶…å‡ºç¯„åœå°±è—èµ·ä¾† (ä¿æŒç‰ˆé¢æ•´é½Š) */
            white-space: nowrap; 
            overflow: hidden; 
            
            background-color: #4CAF50; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 6px; 
            font-weight: bold; 
            position: relative; 
            margin: 0 1px; 
        }
        
        
        /* é è¦½å°ˆç”¨ç‹€æ…‹ï¼šè¢«æ“‹ä½çš„è®Šç°ï¼Œèµ°é“é€æ˜ */
        .seat.blocked { background-color: #bdc3c7; color: transparent; }
        .seat.aisle { background-color: transparent; color: transparent; }
        .seat.door { background-color: #fff; color: #333; border: 1px solid #333; writing-mode: vertical-rl; }
        .seat.pillar { background-color: #7f8c8d; color: white; }

        /* â˜…â˜…â˜… é›™ LINE æŒ‰éˆ•æ¨£å¼ â˜…â˜…â˜… */
        .float-line-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 9999; align-items: center; }
        .line-btn { width: 65px; height: 65px; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: white; font-family: Arial, sans-serif; transition: transform 0.2s; animation: bounce 2s ease-in-out infinite; }
        .line-btn:active { transform: scale(0.9); animation: none; }
        .line-btn span.small { font-size: 10px; font-weight: bold; margin-bottom: 2px; letter-spacing: 0px; }
        .line-btn span.large { font-size: 18px; font-weight: 900; letter-spacing: 1px; }
        
        .btn-bear { background-color: #06C755; } /* å±±ç†Šç§‘å­¸ - ç¶ è‰² */
        .btn-high { background-color: #0077CC; animation-delay: 1s; } /* å±±ç†Šå‡å¤§ - æ·±æ°´è— */

        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }

        @media (max-width: 768px) {
            .main-container { padding-top: 60px; }
            .back-btn { top: 15px; left: 15px; padding: 5px 10px; font-size: 14px; }
            .course-info-header h2 { font-size: 20px; margin-top: 10px; }
            .status-bar { flex-direction: column; align-items: center; gap: 5px; }
            
            /* â˜…â˜…â˜… æ™ºæ…§åº§ä½ç¸®æ”¾é­”æ³•é–‹å§‹ â˜…â˜…â˜… */
            .classroom-inner {
                max-width: 100%; /* é—œéµï¼šç¢ºä¿æ•™å®¤å®¹å™¨æœ€å¤§åªåˆ°è¢å¹•é‚Šç·£ï¼Œå°æ•™å®¤æœƒç¶­æŒåŸæœ¬å¯¬åº¦ */
            }
            .stage-box { 
                font-size: 14px;
                padding: 6px;
                margin-bottom: 12px;
                letter-spacing: 5px;
            }
            .row {
                width: 100%; /* è®“æ’èˆ‡æ’ä¹‹é–“çŸ¥é“é‚Šç•Œï¼Œæ“ ä¸ä¸‹çš„æ™‚å€™æ‰æœƒè§¸ç™¼ç¸®å° */
                gap: 2px; 
                margin-bottom: 5px; 
            }
            .seat { 
                /* flex é­”æ³•è¨­å®šï¼š 
                   0 = ä¸å¼·åˆ¶æ”¾å¤§å¡«æ»¿è¢å¹• (å°æ•™å®¤æ‰ä¸æœƒè®Šè¶…èƒ–)
                   1 = å…è¨±ç¸®å° (å¤§æ•™å®¤é‡åˆ°è¢å¹•é‚Šç·£æœƒè‡ªå‹•æ“ æ‰)
                   40px = åº§ä½åœ¨æ‰‹æ©Ÿä¸Šçš„ç†æƒ³åˆå§‹å¯¬åº¦ 
                */
                flex: 0 1 40px; 
                min-width: 21px;       /* å°±ç®—å¤§æ•™å®¤å†æ€éº¼æ“ ï¼Œæœ€å°ä¹Ÿä¸è¦ä½æ–¼ 21pxï¼Œä¿æŒå¯è®€æ€§ */
                height: auto;          /* å»¢é™¤å›ºå®šé«˜åº¦ï¼ */
                aspect-ratio: 45 / 55; /* ç¥å¥‡å±¬æ€§ï¼šé«˜åº¦æ°¸é è‡ªå‹•è·Ÿè‘—å¯¬åº¦ç¶­æŒ 45:55 çš„å®Œç¾æ¯”ä¾‹ */
                font-size: clamp(8px, 2.5vw, 12px) !important; /* å­—é«”å¤§å°ä¹Ÿæœƒè·Ÿè‘—å‹•æ…‹ç¸®æ”¾ */
                border-radius: 3px;
                padding: 0;
            }
            .seat:hover, .seat.locked { transform: scale(1.05); } 
        }
    </style>
</head>
<body>

    <header>
        <img src="logo1.png" alt="å±±ç†Šç§‘å­¸">
        <h1>å±±ç†Šç§‘å­¸ / å±±ç†Šå‡å¤§</h1>
        <img src="logo2.png" alt="å±±ç†Šå‡å¤§">
    </header>

    <div class="container">
        <a href="index.html" class="back-link">â¬… å›åˆ°èª²ç¨‹åˆ—è¡¨</a>
        
        <div id="loading" style="text-align:center; padding:50px;">è¼‰å…¥ä¸­...</div>

        <div id="content" style="display:none;">
            <div class="course-header">
                <div class="course-img" id="c_img"></div>
                <div class="course-meta">
                    <span class="badge" id="c_grade">å¹´ç´š</span>
                    <h1 id="c_title">èª²ç¨‹åç¨±</h1>
                    <div class="price" id="c_price">$0</div>
                    
                    <div class="info-item"><strong>â° ä¸Šèª²æ™‚é–“:</strong> <span id="c_time_desc">-</span></div>
                    <div class="info-item"><strong>ğŸ‘¨â€ğŸ« æˆèª²è€å¸«:</strong> <span id="c_teacher">-</span></div>
                    <div class="info-item"><strong>ğŸ“ ä¸Šèª²æ•™å®¤:</strong> <span id="c_classroom">-</span></div>
                    <div class="info-item"><strong>ğŸ“… é–‹èª²æ—¥æœŸ:</strong> <span id="c_start_date">-</span></div>
                    
                    <div id="time_labels"></div>
                </div>
            </div>

            <!-- â˜…â˜…â˜… éœæ…‹æ•™å®¤é è¦½ (ç¶ è‰²å…¨é–‹ç‰ˆ) â˜…â˜…â˜… -->
            <div class="preview-section" id="classroomPreviewSection" style="display:none;">
                <div class="preview-title">ğŸ« æ•™å®¤é…ç½®ç¤ºæ„åœ–</div>
                <div class="preview-subtitle">æ­¤ç‚ºåº§ä½åˆ†ä½ˆåƒè€ƒï¼Œå¯¦éš›å‰©é¤˜åº§ä½è«‹ä»¥åŠƒä½é é¢ç‚ºä¸»</div>
                <div class="classroom-wrapper">
                    <div class="classroom-inner"> 
                        <div id="stageArea"></div>
                        <div id="classroomGrid"></div>
                    </div>
                </div>
            </div>

            <div class="course-desc">
                <h3>èª²ç¨‹ä»‹ç´¹</h3>
                <div id="c_desc_content"></div>
            </div>

            <div class="bottom-action-area">
                <div class="countdown-box">
                    <div id="timerLabel" class="timer-label">è·é›¢é–‹æ”¾é‚„æœ‰</div>
                    <div id="timerText" class="timer-text">è¨ˆç®—ä¸­...</div>
                    <a href="#" id="actionBtn" class="btn-action btn-disabled">å°šæœªé–‹æ”¾</a>
                </div>
            </div>
        </div>
    </div>

    <footer>
        &copy; 2024 å±±ç†Šç§‘å­¸è£œç¿’ç­ | ç³»çµ±é–‹ç™¼ï¼šSciencebear Tech Team
    </footer>

    <!-- â˜…â˜…â˜… é›™ LINE æŒ‰éˆ• â˜…â˜…â˜… -->
    <div class="float-line-container">
        <a href="https://lin.ee/FDQ1BLD" target="_blank" class="line-btn btn-bear" title="å±±ç†Šç§‘å­¸å®˜æ–¹LINE">
            <span class="small">å±±ç†Šç§‘å­¸</span>
            <span class="large">LINE</span>
        </a>
        <a href="https://lin.ee/kzE9NrI" target="_blank" class="line-btn btn-high" title="å±±ç†Šå‡å¤§å®˜æ–¹LINE">
            <span class="small">å±±ç†Šå‡å¤§</span>
            <span class="large">LINE</span>
        </a>
    </div>

    <script type="module">
        import { db, ref, child } from './firebase-config.js';
        import { onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // â˜…â˜…â˜… æ•™å®¤å®šç¾© (è¤‡è£½è‡ª booking.htmlï¼Œç¢ºä¿è³‡æ–™ä¸€è‡´) â˜…â˜…â˜…
        const classrooms = {
            "high_red": { name: "é«˜ä¸­ç´…æ•™å®¤", layout: [ ["1-1:X", "1-2:X", "_", "1-3", "1-4", "1-5", "_", "1-6", "1-7", "1-8", "_", "1-9:X", "1-10:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8", "_", "2-9", "2-10"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8", "_", "3-9", "3-10"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8", "_", "4-9", "4-10"], ["5-1", "5-2", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "5-8", "_", "5-9", "5-10"], ["6-1", "6-2", "_", "6-3", "6-4", "6-5", "_", "6-6", "6-7", "6-8", "_", "6-9", "6-10"], ["7-1", "7-2", "_", "7-3", "7-4", "7-5", "_", "7-6", "7-7", "7-8", "_", "7-9", "7-10"], ["8-1:X", "8-2:X", "_", "8-3:X", "8-4:X", "8-5:X", "_", "8-6:X", "8-7:X", "8-8:X", "_", "_", "DOOR"] ] },
            "high_orange": { name: "é«˜ä¸­æ©˜æ•™å®¤", layout: [ ["1-1:X", "1-2:X", "_", "1-3", "1-4", "1-5", "_", "1-6", "1-7", "1-8", "_", "1-9:X", "1-10:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8", "_", "2-9", "2-10"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8", "_", "3-9", "3-10"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8", "_", "4-9", "4-10"], ["5-1", "5-2", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "5-8", "_", "5-9", "5-10"], ["6-1", "6-2", "_", "6-3", "6-4", "6-5", "_", "6-6", "6-7", "6-8", "_", "6-9", "6-10"], ["_","_","_","_","_","_","_","_","_","_","_","_","DOOR"] ] },
            "high_green": { name: "é«˜ä¸­ç¶ æ•™å®¤", layout: [ ["1-1:X", "1-2", "_", "1-3", "1-4", "1-5", "_", "1-6:X", "1-7:X", "1-8:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8"], ["5-1", "5-2", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "5-8:X"], ["6-1:X", "6-2:X", "_", "6-3:X", "6-4:X", "6-5:X", "_", "_", "_", "DOOR"] ] },
            "high_yellow": { name: "é«˜ä¸­é»ƒæ•™å®¤", layout: [ ["1-1:X", "1-2:X", "_", "1-3", "1-4", "1-5", "_", "1-6:X", "1-7:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7"], ["DOOR", "_", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7"], ["_", "_", "_", "5-3:X", "5-4:X", "5-5:X", "_", "5-6:X", "5-7:X"], ["_", "_", "_", "_", "_", "_", "_", "_", "_"] ] },
            "high_blue": { name: "é«˜ä¸­è—æ•™å®¤", layout: [ ["1-1:X", "1-2", "_", "1-3", "1-4", "1-5", "_", "1-6:X", "1-7:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7"], ["5-1:X", "5-2:X", "_", "5-3:X", "5-4:X", "_", "_", "5-6:X", "5-7:X"], ["6-1:X", "6-2:X", "_", "_", "DOOR", "_", "_", "_", "_"] ] },
            "middle_new_orange": { name: "åœ‹ä¸­æ–°æ©˜æ•™å®¤", layout: [ ["1-1:X", "1-2", "_", "1-3", "1-4", "1-5", "_", "1-6", "1-7", "1-8:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8:X"], ["DOOR", "_", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "PILLAR"] ] },
            "middle_new_blue": { name: "åœ‹ä¸­æ–°è—æ•™å®¤", layout: [ ["1-1", "1-2", "1-3", "_", "1-4", "1-5", "1-6", "1-7:X"], ["2-1", "2-2", "2-3", "_", "2-4", "2-5", "2-6", "2-7:X"], ["3-1", "3-2", "3-3", "_", "3-4", "3-5", "3-6", "3-7:X"], ["4-1", "4-2", "4-3", "_", "4-4", "4-5", "4-6", "4-7:X"], ["5-1", "5-2", "5-3", "_", "5-4", "5-5", "5-6", "5-7:X"], ["6-1:X", "6-2:X", "6-3:X", "_", "6-4:X", "6-5:X", "6-6:X", "6-7:X"], ["7-1:X", "7-2:X", "7-3:X", "_", "7-4:X", "7-5:X", "7-6:X", "7-7:X"], ["DOOR", "_", "_", "_", "_", "_", "_", "_"] ] },
            "middle_new_yellow": { name: "åœ‹ä¸­æ–°é»ƒæ•™å®¤", layout: [ ["1-1:X", "1-2", "1-3", "_", "1-4", "1-5", "1-6", "_", "1-7", "1-8:X"], ["PILLAR", "2-2", "2-3", "_", "2-4", "2-5", "2-6", "_", "2-7", "2-8:X"], ["3-1:X", "3-2", "3-3", "_", "3-4", "3-5", "3-6", "_", "3-7", "3-8"], ["4-1", "4-2", "4-3", "_", "4-4", "4-5", "4-6", "_", "4-7", "4-8"], ["5-1", "5-2", "5-3", "_", "5-4", "5-5", "5-6", "_", "5-7", "5-8"], ["6-1:X", "6-2", "6-3", "_", "6-4", "6-5", "6-6", "_", "6-7", "6-8"], ["DOOR", "_", "_", "_", "_", "_", "_", "_", "_", "_"] ] },
            "middle_new_red": { name: "åœ‹ä¸­æ–°ç´…æ•™å®¤", layout: [ ["1-1:X", "1-2:X", "1-3", "_", "1-4", "1-5", "1-6", "1-7", "_", "1-8", "1-9:X", "1-10:X"], ["2-1", "2-2", "2-3", "_", "2-4", "2-5", "2-6", "2-7", "_", "2-8", "2-9", "2-10"], ["3-1", "3-2", "3-3", "_", "3-4", "3-5", "3-6", "3-7", "_", "3-8", "3-9", "3-10"], ["DOOR", "_", "_", "_", "_", "_", "_", "_", "_", "_", "_", "_"], ["4-1", "4-2", "4-3", "_", "4-4", "4-5", "4-6", "4-7", "_", "4-8", "4-9", "4-10"], ["5-1", "5-2", "5-3", "_", "5-4", "5-5", "5-6", "5-7", "_", "5-8", "5-9", "5-10"], ["6-1", "6-2", "6-3", "_", "6-4", "6-5", "6-6", "6-7", "_", "6-8", "6-9", "6-10"], ["7-1", "7-2", "7-3", "_", "7-4", "7-5", "7-6", "7-7", "_", "7-8", "7-9", "7-10"], ["8-1:X", "8-2:X", "8-3:X","_","8-4:X", "8-5:X", "8-6:X", "8-7:X", "_", "8-8:X", "8-9:X", "8-10:X"] ] },
            "middle_big_red": { name: "åœ‹ä¸­å¤§ç´…æ•™å®¤", layout: [ ["1-1:X", "1-2:X", "_", "1-3", "1-4", "1-5", "_", "1-6", "1-7", "1-8", "_", "1-9:X", "1-10:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8", "_", "2-9", "2-10"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8", "_", "3-9", "3-10"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8", "_", "4-9", "4-10"], ["5-1", "5-2", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "5-8", "_", "5-9", "5-10"], ["6-1", "6-2", "_", "6-3", "6-4", "6-5", "_", "6-6", "6-7", "6-8", "_", "6-9", "6-10"], ["7-1:X", "7-2:X", "_", "7-3:X", "7-4:X", "7-5:X", "_", "7-6:X", "7-7:X", "7-8:X", "_", "7-9:X", "7-10:X"], ["_","_","_","_","_","_","_","_","_","_","_","_","DOOR"] ] },
            "middle_da_chiao": { name: "åœ‹ä¸­å¤§æ©˜æ•™å®¤", layout: [ ["1-1:X", "1-2:X", "1-3", "_", "1-4", "1-5", "1-6", "_", "1-7", "1-8:X"], ["2-1", "2-2", "2-3", "_", "2-4", "2-5", "2-6", "_", "2-7", "2-8"], ["3-1", "3-2", "3-3", "_", "3-4", "3-5", "3-6", "_", "3-7", "3-8"], ["4-1", "4-2", "4-3", "_", "4-4", "4-5", "4-6", "_", "4-7", "4-8"], ["5-1", "5-2", "5-3", "_", "5-4", "5-5", "5-6", "_", "_", "DOOR"] ] },
            "middle_big_green": { name: "åœ‹ä¸­å¤§ç¶ æ•™å®¤", layout: [ ["DOOR", "_", "_", "_", "_", "_"], ["1-1", "1-2", "1-3", "_", "1-4", "1-5"], ["2-1", "2-2", "2-3", "_", "2-4", "2-5"], ["3-1", "3-2", "3-3", "_", "3-4", "3-5"], ["PILLAR", "4-2", "4-3", "_", "4-4", "4-5"] ] },
            "test_room": { 
                name: "æ¸¬è©¦å°ˆç”¨æ•™å®¤", 
                hasStage: true, 
                layout: [ 
                    ["1-1", "1-2"]
                ] 
            }
        };

        const params = new URLSearchParams(window.location.search);
        const courseId = params.get('id') ? params.get('id').trim() : null;

        if (!courseId) {
            alert("ç„¡æ•ˆçš„èª²ç¨‹é€£çµï¼");
            window.location.href = "index.html"; 
        }

        const dbRef = ref(db, `courses/${courseId}`);
        
        onValue(dbRef, (snapshot) => {
            if (snapshot.exists()) {
                const c = snapshot.val();
                c.id = courseId; 
                renderPage(c);
            } else {
                console.error("èª²ç¨‹ä¸å­˜åœ¨:", courseId);
                alert("æ‰¾ä¸åˆ°æ­¤èª²ç¨‹ï¼");
                window.location.href = "index.html"; 
            }
        }, (error) => {
            console.error("è®€å–å¤±æ•—:", error);
            alert("è®€å–èª²ç¨‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™ã€‚");
        });

        let timerInterval = null;

        function renderPage(c) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            const title = `${c.subject} ${c.classType || ''}`;
            document.title = `${title} - èª²ç¨‹è©³æƒ…`;
            
            document.getElementById('c_img').style.backgroundImage = `url('${c.image}')`;
            document.getElementById('c_grade').textContent = c.grade;
            document.getElementById('c_title').textContent = title;
            document.getElementById('c_price').textContent = c.price;
            document.getElementById('c_teacher').textContent = c.teacher;
            document.getElementById('c_time_desc').textContent = c.timeDescription || '-';
            document.getElementById('c_start_date').textContent = c.startDate || '-';
            
            // ä½¿ç”¨ classrooms ç‰©ä»¶å–å¾—ä¸­æ–‡åç¨±ï¼Œè‹¥ç„¡å‰‡å›é€€åˆ° c.classroom
            document.getElementById('c_classroom').textContent = classrooms[c.classroom] ? classrooms[c.classroom].name : c.classroom; 
            
            document.getElementById('c_desc_content').innerHTML = c.desc;

            // â˜…â˜…â˜… V33.0 å‡ç´šï¼šè³‡æ–™é©…å‹•éœæ…‹é è¦½ â˜…â˜…â˜…
            // ç›´æ¥å‚³å…¥æ•´å€‹ course ç‰©ä»¶ï¼Œè®“å‡½å¼è‡ªå·±åˆ¤æ–·è¦ç”¨ layout é‚„æ˜¯é è¨­ç¯„æœ¬
            renderClassroomPreview(c);
            document.getElementById('classroomPreviewSection').style.display = 'block';

            const start1 = new Date(c.start1);
            const hasStart2 = c.start2 && new Date(c.start2).getFullYear() < 3000;

            const timeLabels = document.getElementById('time_labels');
            let html = '';

            if (hasStart2) {
                html += `<div class="info-item"><strong>ğŸ”¥ ä¸€éšé–‹æ”¾:</strong> ${start1.toLocaleString()}</div>`;
                html += `<div class="info-item"><strong>ğŸ”¥ äºŒéšé–‹æ”¾:</strong> ${new Date(c.start2).toLocaleString()}</div>`;
            } else {
                html += `<div class="info-item"><strong>ğŸ”¥ åŠƒä½é–‹æ”¾:</strong> ${start1.toLocaleString()}</div>`;
            }
            timeLabels.innerHTML = html;

            if (timerInterval) clearInterval(timerInterval);
            startTimer(c);
        }

        // â˜…â˜…â˜… V33.0 å‡ç´šï¼šæ¸²æŸ“æ•™å®¤ (éœæ…‹) â˜…â˜…â˜…
        function renderClassroomPreview(courseData) {
            // å„ªå…ˆæª¢æŸ¥æ˜¯å¦æœ‰å®¢è£½åŒ– Layout
            let layoutToRender = null;
            let hasStage = true;

            if (courseData.layout) {
                layoutToRender = courseData.layout;
            } else if (classrooms[courseData.classroom]) {
                layoutToRender = classrooms[courseData.classroom].layout;
                hasStage = classrooms[courseData.classroom].hasStage;
            }

            if (!layoutToRender) return;

            const stageArea = document.getElementById('stageArea');
            const grid = document.getElementById('classroomGrid');
            
            stageArea.innerHTML = hasStage ? '<div class="stage-box">è¬›ã€€å°</div>' : '';
            grid.innerHTML = "";

            layoutToRender.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';
                row.forEach(seatCode => {
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    let code = seatCode;
                    let isBlocked = false;

                    // è™•ç† :X é˜»æ“‹ä½
                    if (seatCode.includes(':X')) {
                        code = seatCode.split(':')[0];
                        isBlocked = true;
                    }

                    if (code === "_") {
                        seat.classList.add('aisle');
                    } else if (code === "DOOR") {
                        seat.classList.add('door');
                        seat.textContent = "é–€";
                    } else if (code === "PILLAR") {
                        seat.classList.add('pillar');
                        seat.textContent = "æŸ±";
                    } else {
                        // æ­£å¸¸åº§ä½
                        seat.textContent = code;
                        if (isBlocked) {
                            seat.classList.add('blocked');
                        }
                        // å…¶é¤˜ä¸€èˆ¬åº§ä½ä¿æŒç¶ è‰² (é è¨­æ¨£å¼)
                    }
                    rowDiv.appendChild(seat);
                });
                grid.appendChild(rowDiv);
            });
        }

        function startTimer(c) {
            const timerLabel = document.getElementById('timerLabel');
            const timerText = document.getElementById('timerText');
            const btn = document.getElementById('actionBtn');

            const start1 = new Date(c.start1).getTime();
            const end1 = c.end1 ? new Date(c.end1).getTime() : 9999999999999;
            const start2 = c.start2 ? new Date(c.start2).getTime() : 9999999999999;
            const end2 = c.end2 ? new Date(c.end2).getTime() : 9999999999999;

            const hasStart2 = c.start2 && new Date(c.start2).getFullYear() < 3000;

            function update() {
                const now = Date.now();

                if (now < start1) {
                    const diff = start1 - now;
                    timerLabel.textContent = "è·é›¢é–‹æ”¾é‚„æœ‰";
                    timerText.textContent = formatTime(diff);
                    btn.textContent = "å°šæœªé–‹æ”¾";
                    btn.className = "btn-action btn-disabled";
                }
                else if (now >= start1 && now < end1) {
                    timerLabel.textContent = "ğŸ”¥ ç›®å‰ç‹€æ…‹";
                    timerText.textContent = "é–‹æ”¾åŠƒä½ä¸­";
                    btn.textContent = "å‰å¾€åŠƒä½ âœ";
                    btn.className = "btn-action btn-active";
                    btn.href = `booking.html?class=${c.id}`;
                }
                else if (now >= end1 && now < start2 && hasStart2) {
                    const diff = start2 - now;
                    timerLabel.textContent = "ç³»çµ±æ•´ç†ä¸­ (æš«åœé–‹æ”¾)";
                    timerText.textContent = `è·é›¢äºŒéšé‚„æœ‰ï¼š${formatTime(diff)}`;
                    btn.textContent = "æš«åœé–‹æ”¾";
                    btn.className = "btn-action btn-disabled";
                }
                else if (hasStart2 && now >= start2 && now < end2) {
                    timerLabel.textContent = "ğŸ”¥ ç›®å‰ç‹€æ…‹";
                    timerText.textContent = "ç¬¬äºŒéšæ®µé–‹æ”¾ä¸­ (å«å€™è£œ)";
                    btn.textContent = "å‰å¾€åŠƒä½ âœ";
                    btn.className = "btn-action btn-active";
                    btn.href = `booking.html?class=${c.id}`;
                }
                else {
                    timerLabel.textContent = "â›” ç‹€æ…‹";
                    timerText.textContent = "åŠƒä½å·²çµæŸ";
                    btn.textContent = "å·²æˆªæ­¢";
                    btn.className = "btn-action btn-disabled";
                }
            }

            timerInterval = setInterval(update, 1000);
            update();
        }

        function formatTime(ms) {
            const totalSec = Math.floor(ms / 1000);
            const h = Math.floor(totalSec / 3600);
            const m = Math.floor((totalSec % 3600) / 60);
            const s = totalSec % 60;
            return `${h}æ™‚ ${m}åˆ† ${s}ç§’`;
        }
    </script>
</body>
</html>