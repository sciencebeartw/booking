<!-- æª”æ¡ˆï¼šindex.html -->
<!-- ç‰ˆæœ¬ï¼šV28.12 (å€™è£œæ¨™ç±¤é‚è¼¯ä¿®æ­£ + Iconæ›´æ–°) -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ» å±±ç†Šç§‘å­¸ - èª²ç¨‹åŠƒä½å…¥å£</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f8f9fa; margin: 0; padding: 0; }
        header { background: #2c3e50; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .header-container { max-width: 1200px; margin: 0 auto; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .header-left { display: flex; align-items: center; gap: 15px; cursor: pointer; user-select: none; }
        .header-left img { height: 50px; }
        .header-left h1 { margin: 0; font-size: 22px; letter-spacing: 1px; color: white; }
        .header-right { display: flex; gap: 15px; align-items: center; }
        .nav-link { color: white; text-decoration: none; font-size: 15px; font-weight: bold; padding: 8px 12px; border-radius: 5px; transition: 0.3s; display: flex; align-items: center; gap: 5px; }
        .nav-link:hover { background: rgba(255,255,255,0.1); }
        @media (max-width: 768px) { .header-container { flex-direction: column; gap: 10px; } .header-right { gap: 10px; flex-wrap: wrap; justify-content: center; } .nav-link { font-size: 14px; padding: 5px 10px; } }
        .carousel { position: relative; width: 100%; height: 400px; overflow: hidden; background: #eee; margin-bottom: 20px; }
        .carousel-track { display: flex; transition: transform 0.5s ease-in-out; height: 100%; }
        .carousel-slide { min-width: 100%; height: 100%; background-size: contain; background-repeat: no-repeat; background-position: center; }
        .carousel-nav { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
        .carousel-dot { width: 12px; height: 12px; background: rgba(0,0,0,0.3); border-radius: 50%; cursor: pointer; }
        .carousel-dot.active { background: #e74c3c; }
        .filter-container { max-width: 1100px; margin: 0 auto; padding: 0 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .filter-btn { padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 30px; cursor: pointer; font-size: 16px; transition: 0.3s; color: #555; }
        .filter-btn:hover { background: #eee; }
        .filter-btn.active { background: #2c3e50; color: white; border-color: #2c3e50; }
        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 30px; justify-content: center; }
        .container:has(> :nth-child(1):last-child) { display: flex; justify-content: center; }
        .container:has(> :nth-child(1):last-child) .course-card { width: 100%; max-width: 400px; }
        @media (min-width: 800px) { .container:has(> :nth-child(2):last-child) { display: flex; justify-content: center; gap: 30px; } .container:has(> :nth-child(2):last-child) .course-card { width: 100%; max-width: 400px; } }
        .course-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.05); transition: 0.3s; display: flex; flex-direction: column; border: 1px solid #eee; cursor: pointer; text-decoration: none; color: inherit; position: relative; }
        .course-card:hover { transform: translateY(-10px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .card-img { height: 200px; background-size: cover; background-position: center; background-color: #eee; }
        .card-body { padding: 25px; flex-grow: 1; display: flex; flex-direction: column; }
        .card-category { font-size: 12px; color: #e74c3c; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .card-title { font-size: 22px; font-weight: bold; margin-bottom: 10px; color: #2c3e50; }
        .card-info { font-size: 15px; color: #555; margin-bottom: 15px; line-height: 1.6; }
        .card-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .card-price { font-size: 18px; font-weight: bold; color: #27ae60; }
        .btn-view { background: #3498db; color: white; padding: 8px 15px; border-radius: 5px; font-size: 14px; }
        .status-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: white; margin-left: auto; }
        .status-open { background: #27ae60; }
        .status-wait { background: #f39c12; }
        .status-full { background: #e74c3c; }
        .status-closed { background: #95a5a6; }
        .loading { text-align: center; padding: 50px; font-size: 20px; color: #999; grid-column: 1 / -1; }
        footer { text-align: center; padding: 40px; color: #999; font-size: 14px; background-color: #2c3e50; color: white; margin-top: 80px; }
        .float-line-btn { position: fixed; bottom: 25px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background-color: #06C755; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 9999; cursor: pointer; transition: transform 0.2s; animation: bounce 2s ease-in-out infinite; display: flex; align-items: center; justify-content: center; text-decoration: none; color: white; font-weight: 900; font-size: 1.2rem; font-family: Arial, sans-serif; letter-spacing: 0.5px; }
        .float-line-btn:active { transform: scale(0.9); animation: none; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }
    </style>
</head>
<body>

    <header>
        <div class="header-container">
            <div class="header-left" onclick="secretKnock()">
                <img src="logo1.png" alt="å±±ç†Šç§‘å­¸">
                <h1>å±±ç†Šç§‘å­¸ / å±±ç†Šå‡å¤§</h1>
                <img src="logo2.png" alt="å±±ç†Šå‡å¤§">
            </div>
            <div class="header-right">
                <a href="sop.html" class="nav-link" target="_blank">ğŸ“– åŠƒä½é ˆçŸ¥</a>
                <a href="check.html" class="nav-link">ğŸ” æŸ¥è©¢çµæœ</a>
            </div>
        </div>
    </header>

    <div class="carousel">
        <div class="carousel-track" id="track"></div>
        <div class="carousel-nav" id="nav"></div>
    </div>

    <div id="filterContainer" class="filter-container">
        <button class="filter-btn active" onclick="filterCourses('all')">å…¨éƒ¨èª²ç¨‹</button>
    </div>

    <div id="courseContainer" class="container">
        <div class="loading">æ­£åœ¨è¼‰å…¥èª²ç¨‹è³‡æ–™...</div>
    </div>

    <footer>
        &copy; 2024 å±±ç†Šç§‘å­¸è£œç¿’ç­ | ç³»çµ±é–‹ç™¼ï¼šSciencebear Tech Team
    </footer>

    <a href="https://lin.ee/oGKweky" target="_blank" class="float-line-btn" title="è¯ç¹«å®˜æ–¹LINE">LINE</a>

    <script type="module">
        import { db, ref } from './firebase-config.js';
        import { onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        let knockCount = 0;
        let knockTimer = null;
        window.secretKnock = function() {
            knockCount++;
            clearTimeout(knockTimer);
            knockTimer = setTimeout(() => { knockCount = 0; }, 2000);
            if (knockCount >= 5) {
                knockCount = 0;
                const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
                if (pwd && pwd.trim() !== "") {
                    const targetFile = "admin_" + pwd.trim() + ".html";
                    fetch(targetFile, { method: 'HEAD' })
                        .then(response => {
                            if (response.ok) window.location.href = targetFile;
                            else alert("å¯†ç¢¼éŒ¯èª¤ï¼");
                        })
                        .catch(error => alert("ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"));
                }
            }
        };

        const track = document.getElementById('track');
        const nav = document.getElementById('nav');
        let currentSlide = 0;
        let slideCount = 0;

        onValue(ref(db, 'banners'), snapshot => {
            const data = snapshot.val() || {};
            track.innerHTML = "";
            nav.innerHTML = "";
            const banners = Object.values(data);
            slideCount = banners.length;
            if (slideCount === 0) {
                track.innerHTML = '<div class="carousel-slide" style="background-image: url(\'https://via.placeholder.com/1200x400?text=Welcome\');"></div>';
                return;
            }
            banners.forEach((b, index) => {
                const slide = document.createElement('div');
                slide.className = 'carousel-slide';
                slide.style.backgroundImage = `url('${b.url}')`;
                track.appendChild(slide);
                const dot = document.createElement('div');
                dot.className = `carousel-dot ${index === 0 ? 'active' : ''}`;
                dot.onclick = () => goToSlide(index);
                nav.appendChild(dot);
            });
        });

        function goToSlide(index) {
            currentSlide = index;
            track.style.transform = `translateX(-${index * 100}%)`;
            document.querySelectorAll('.carousel-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
        }
        setInterval(() => {
            if (slideCount > 1) {
                currentSlide = (currentSlide + 1) % slideCount;
                goToSlide(currentSlide);
            }
        }, 5000);

        const courseContainer = document.getElementById('courseContainer');
        const filterContainer = document.getElementById('filterContainer');
        let allCourses = [];
        let seatsStatus = {}; 
        let waitlistStatus = {}; 
        let categories = new Set();
        let currentCategory = 'all';

        onValue(ref(db, 'courses'), (snapshot) => {
            const data = snapshot.val();
            allCourses = [];
            categories = new Set();

            if (!data) {
                courseContainer.innerHTML = '<div class="loading">ç›®å‰æ²’æœ‰é–‹æ”¾çš„èª²ç¨‹ã€‚</div>';
                return;
            }

            Object.keys(data).forEach(key => {
                const c = data[key];
                c.id = key; 
                allCourses.push(c);
                if (c.grade) categories.add(c.grade);
            });

            if (filterContainer.children.length <= 1) {
                const gradeOrder = ["å‡å°äº”èª²ç¨‹", "å‡å°å…­èª²ç¨‹", "å‡åœ‹ä¸€èª²ç¨‹", "å‡åœ‹äºŒèª²ç¨‹", "å‡åœ‹ä¸‰èª²ç¨‹", "å‡é«˜ä¸€èª²ç¨‹", "å‡é«˜äºŒèª²ç¨‹", "å‡é«˜ä¸‰èª²ç¨‹"];
                const sortedCategories = Array.from(categories).sort((a, b) => gradeOrder.indexOf(a) - gradeOrder.indexOf(b));
                sortedCategories.forEach(cat => {
                    const btn = document.createElement('button');
                    btn.className = 'filter-btn';
                    btn.textContent = cat;
                    btn.onclick = () => window.filterCourses(cat);
                    filterContainer.appendChild(btn);
                });
            }
            refreshDisplay();
        });

        onValue(ref(db, 'seats'), (snapshot) => {
            const data = snapshot.val() || {};
            seatsStatus = {};
            Object.keys(data).forEach(courseId => {
                const seats = data[courseId];
                let soldCount = 0;
                
                Object.keys(seats).forEach(seatId => {
                    if (seatId === '_settings') return;
                    if (seats[seatId].status === 'sold') {
                        soldCount++;
                    }
                });
                seatsStatus[courseId] = { sold: soldCount };
            });
            refreshDisplay();
        });

        onValue(ref(db, 'waitlist'), (snapshot) => {
            const data = snapshot.val() || {};
            waitlistStatus = {};
            Object.keys(data).forEach(courseId => {
                waitlistStatus[courseId] = Object.keys(data[courseId]).length;
            });
            refreshDisplay();
        });

        function refreshDisplay() {
            if (allCourses.length === 0) return;
            
            const now = Date.now();
            const visibleCourses = allCourses.filter(c => {
                const start = c.displayStart ? new Date(c.displayStart).getTime() : 0;
                const end = c.displayEnd ? new Date(c.displayEnd).getTime() : 9999999999999;
                return now >= start && now <= end;
            });

            let finalCourses = visibleCourses;
            if (currentCategory !== 'all') {
                finalCourses = visibleCourses.filter(c => c.grade === currentCategory);
            }

            renderCourses(finalCourses);
        }

        setInterval(refreshDisplay, 1000);

        function getStatusBadge(c, now) {
            const start1 = new Date(c.start1).getTime();
            const end1 = c.end1 ? new Date(c.end1).getTime() : 9999999999999;
            const start2 = c.start2 ? new Date(c.start2).getTime() : 9999999999999;
            const end2 = c.end2 ? new Date(c.end2).getTime() : 9999999999999;
            
            const hasEnd1 = c.end1 && new Date(c.end1).getFullYear() < 3000;
            const hasStart2 = c.start2 && new Date(c.start2).getFullYear() < 3000;
            const hasEnd2 = c.end2 && new Date(c.end2).getFullYear() < 3000;

            const soldCount = (seatsStatus[c.id] && seatsStatus[c.id].sold) || 0;
            const totalSeats = c.totalSeats || 999; 
            const isFull = soldCount >= totalSeats;

            const waitlistCount = waitlistStatus[c.id] || 0;
            const waitlistLimit = c.waitlistLimit || 0;
            const isWaitlistFull = (waitlistLimit > 0 && waitlistCount >= waitlistLimit);

            // 1. å°šæœªé–‹å§‹
            if (now < start1) return '<div class="status-badge status-closed">å°šæœªé–‹æ”¾</div>';

            // 2. ç¬¬ä¸€éšæ®µ
            if (now >= start1 && now < end1) {
                if (isFull) return '<div class="status-badge status-full">ğŸ”´ æ­¤éšæ®µå·²é¡æ»¿</div>';
                return '<div class="status-badge status-open">ğŸŸ¢ é–‹æ”¾åŠƒä½ä¸­</div>';
            }

            // 3. ä¸€éšçµæŸï¼ŒäºŒéšæœªé–‹å§‹ (æš«åœ)
            if (hasEnd1 && hasStart2 && now >= end1 && now < start2) {
                return '<div class="status-badge status-closed">â›” ç³»çµ±æ•´ç†ä¸­</div>';
            }

            // 4. ç¬¬äºŒéšæ®µ (æˆ–åªæœ‰ä¸€éšä¸”ç„¡çµæŸæ™‚é–“)
            if ((hasStart2 && now >= start2 && now < end2) || (!hasEnd1 && now >= start1)) {
                if (isFull) {
                    if (c.waitlistEnabled) {
                        // â˜…â˜…â˜… ä¿®æ­£ï¼šå¦‚æœæ²’æœ‰äºŒéšï¼Œç›´æ¥é¡¯ç¤ºå€™è£œï¼›å¦‚æœæœ‰äºŒéšï¼Œå¿…é ˆäºŒéšé–‹å§‹æ‰é¡¯ç¤º â˜…â˜…â˜…
                        if (!hasStart2 || (hasStart2 && now >= start2)) {
                            if (isWaitlistFull) return '<div class="status-badge status-full">ğŸ”´ å€™è£œå·²é¡æ»¿</div>';
                            return '<div class="status-badge status-wait">ğŸŸ¡ é–‹æ”¾å€™è£œä¸­</div>';
                        }
                    }
                    return '<div class="status-badge status-full">ğŸ”´ å·²é¡æ»¿</div>';
                }
                return '<div class="status-badge status-open">ğŸŸ¢ é–‹æ”¾åŠƒä½ä¸­</div>';
            }

            // 5. å…¨éƒ¨çµæŸ
            if (hasEnd2 && now >= end2) {
                return '<div class="status-badge status-full">ğŸ”´ åŠƒä½å·²çµæŸ</div>';
            }
            
            return '<div class="status-badge status-closed">å°šæœªé–‹æ”¾</div>';
        }

        function renderCourses(courses) {
            if (courses.length === 0) {
                courseContainer.innerHTML = '<div class="loading">ç›®å‰æ²’æœ‰ç¬¦åˆçš„èª²ç¨‹ã€‚</div>';
                return;
            }

            const currentIds = new Set(courses.map(c => `card-${c.id}`));
            Array.from(courseContainer.children).forEach(child => {
                if (child.id && !currentIds.has(child.id) && !child.classList.contains('loading')) {
                    courseContainer.removeChild(child);
                }
            });
            
            const loadingEl = courseContainer.querySelector('.loading');
            if (loadingEl) courseContainer.removeChild(loadingEl);

            const now = Date.now();

            courses.forEach(c => {
                const statusBadge = getStatusBadge(c, now);
                const cardId = `card-${c.id}`;
                let card = document.getElementById(cardId);

                if (card) {
                    const badgeContainer = card.querySelector('.status-badge-container');
                    if (badgeContainer.innerHTML !== statusBadge) {
                        badgeContainer.innerHTML = statusBadge;
                    }
                } else {
                    card = document.createElement('a');
                    card.className = 'course-card';
                    card.id = cardId; 
                    card.href = `detail.html?id=${c.id}`; 
                    
                    card.innerHTML = `
                        <div class="card-img" style="background-image: url('${c.image || 'https://via.placeholder.com/400x200'}');"></div>
                        <div class="card-body">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                <div class="card-category">${c.grade}</div>
                                <div class="status-badge-container">${statusBadge}</div>
                            </div>
                            <div class="card-title">${c.subject} ${c.classType || ''}</div>
                            <div class="card-info">
                                ğŸ‘¨â€ğŸ« ${c.teacher}<br>
                                â° ${c.timeDescription || 'æ™‚é–“æœªå®š'}
                            </div>
                            <div class="card-footer">
                                <div class="card-price">${c.price}</div>
                                <div class="btn-view">æŸ¥çœ‹è©³æƒ… âœ</div>
                            </div>
                        </div>
                    `;
                    courseContainer.appendChild(card);
                }
            });
        }

        window.filterCourses = function(category) {
            currentCategory = category;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.textContent === category || (category === 'all' && btn.textContent === 'å…¨éƒ¨èª²ç¨‹')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            refreshDisplay();
        };
    </script>
</body>
</html>