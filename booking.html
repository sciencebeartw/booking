<!-- æª”æ¡ˆï¼šbooking.html -->
<!-- ç‰ˆæœ¬ï¼šV33.1 (ä¿®æ­£ï¼šåº§ä½è¡¨å³æ™‚ç†±æ›´æ–°) -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ» å±±ç†Šç§‘å­¸ - åŠƒä½ç³»çµ±</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://www.google.com/recaptcha/api.js?hl=zh-TW" async defer></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f4f9; text-align: center; margin: 0; padding: 0; }
        header { background: #2c3e50; padding: 15px 20px; display: flex; justify-content: center; align-items: center; gap: 20px; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        header img { height: 60px; } 
        header h1 { margin: 0; font-size: 24px; letter-spacing: 1px; text-align: center; }
        
        .main-container { background: white; max-width: 1000px; margin: 20px auto; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); position: relative; }
        
        .back-btn { position: absolute; top: 20px; left: 20px; text-decoration: none; color: #3498db; font-weight: bold; font-size: 16px; border: 1px solid #3498db; padding: 5px 15px; border-radius: 20px; transition: 0.3s; z-index: 100; }
        .back-btn:hover { background: #3498db; color: white; }

        .course-info-header { margin-bottom: 20px; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .course-info-header h2 { margin: 0 0 10px 0; color: #2c3e50; font-size: 28px; }
        .course-info-header p { margin: 5px 0; color: #555; font-size: 16px; display: inline-block; margin: 0 10px; }
        
        #deadlineTimer { background: #e74c3c; color: white; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-weight: bold; display: none; }

        .classroom-wrapper { overflow-x: auto; padding-bottom: 20px; text-align: center; -webkit-overflow-scrolling: touch; }
        
        .classroom-inner { display: inline-block; margin: 0 auto; }
        #stageArea, #classroom { display: block; width: 100%; }

        .stage-box { width: 100%; margin: 0 auto 20px auto; padding: 12px; border: 3px solid #333; background-color: #fff; font-weight: bold; font-size: 22px; letter-spacing: 8px; text-align: center; box-sizing: border-box; }
        .row { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; }
        
        .seat { width: 45px; height: 55px; background-color: #4CAF50; color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; user-select: none; position: relative; transition: 0.2s; box-sizing: border-box; }
        .seat:hover { transform: scale(1.1); z-index: 10; }
        .seat.sold { background-color: #e74c3c; cursor: not-allowed; transform: none; pointer-events: none; }
        
        .seat.locked { background-color: #f39c12; transform: scale(1.05); pointer-events: none; }
        
        .seat.mylocked { background-color: #3498db; border: 2px solid #2980b9; z-index: 20; cursor: pointer; pointer-events: auto; }
        
        .seat.blocked { background-color: #95a5a6; cursor: not-allowed; transform: none; }
        .seat.aisle { background-color: transparent; color: transparent; pointer-events: none; cursor: default; }
        .seat.door { background-color: #fff; color: #333; border: 2px solid #333; font-size: 16px; writing-mode: vertical-rl; cursor: default; pointer-events: none; transform: none; }
        .seat.pillar { background-color: #7f8c8d; color: white; cursor: default; pointer-events: none; transform: none; border-radius: 2px; }
        .seat.loading { opacity: 0.5; pointer-events: none; }
        
        .status-bar { margin: 10px 0; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; line-height: 2; }
        .status-group { display: inline-block; white-space: nowrap; }
        .dot { height: 12px; width: 12px; display: inline-block; border-radius: 50%; margin-right: 5px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 999; }
        .modal-box { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 420px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; border-top: 5px solid #f39c12; max-height: 90vh; overflow-y: auto; }
        .modal-title { font-size: 20px; font-weight: bold; margin-bottom: 5px; color: #333; }
        .modal-desc { font-size: 20px; color: #333; margin-bottom: 15px; font-weight: bold; text-align: center; background: #fdf2e9; padding: 10px; border-radius: 5px; }
        .timer-box { background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; margin-bottom: 15px; border: 1px solid #ffeeba; }
        
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        .input-hint { font-size: 12px; color: #999; margin-top: 3px; }
        
        .recaptcha-wrapper { display: flex; justify-content: center; margin-bottom: 15px; margin-top: 10px; }
        .btn-group { display: flex; justify-content: space-between; gap: 10px; margin-top: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; flex: 1; transition: 0.3s; }
        .btn-confirm { background-color: #4CAF50; color: white; }
        .btn-confirm:disabled { background-color: #ccc; cursor: not-allowed; } 
        .btn-cancel { background-color: #e74c3c; color: white; }
        #loadingMask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 24px; color: #555; flex-direction: column; }
        .waitlist-area { margin-top: 30px; padding: 20px; background: #fff3e0; border-radius: 10px; display: none; }
        .btn-waitlist { background-color: #e67e22; color: white; padding: 12px 30px; font-size: 18px; border: none; border-radius: 30px; cursor: pointer; box-shadow: 0 4px 6px rgba(230, 126, 34, 0.3); transition: 0.3s; }
        .btn-waitlist:hover { background-color: #d35400; transform: translateY(-2px); }
        .btn-waitlist:disabled { background-color: #95a5a6; cursor: not-allowed; transform: none; box-shadow: none; }
        .modal-course-info { background: #f0f2f5; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; color: #555; line-height: 1.6; text-align: center; }
        .modal-course-info strong { color: #2c3e50; font-size: 16px; display: block; margin-bottom: 5px; }
        .warning-text { color: #e74c3c; font-size: 13px; margin-bottom: 15px; line-height: 1.5; font-weight: bold; background: #fff5f5; padding: 10px; border-radius: 5px; border: 1px dashed #e74c3c; text-align: center; }
        #expirationMessage { display: none; text-align: center; padding: 20px; }
        #expirationMessage h3 { color: #e74c3c; font-size: 24px; margin-bottom: 10px; }
        #expirationMessage p { font-size: 16px; color: #555; margin-bottom: 20px; }
        footer { text-align: center; padding: 40px; color: #999; font-size: 14px; background-color: #2c3e50; color: white; margin-top: 80px; }

        .float-line-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 9999; align-items: center; }
        .line-btn { width: 65px; height: 65px; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: white; font-family: Arial, sans-serif; transition: transform 0.2s; animation: bounce 2s ease-in-out infinite; }
        .line-btn:active { transform: scale(0.9); animation: none; }
        .line-btn span.small { font-size: 10px; font-weight: bold; margin-bottom: 2px; letter-spacing: 0px; }
        .line-btn span.large { font-size: 18px; font-weight: 900; letter-spacing: 1px; }
        
        .btn-bear { background-color: #06C755; } /* å±±ç†Šç§‘å­¸ - ç¶ è‰² */
        .btn-high { background-color: #0077CC; animation-delay: 1s; } /* å±±ç†Šå‡å¤§ - æ·±æ°´è— */

        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }

        @media (max-width: 768px) {
            .main-container { padding-top: 60px; }
            .back-btn { top: 15px; left: 15px; padding: 5px 10px; font-size: 14px; }
            .course-info-header h2 { font-size: 20px; margin-top: 10px; }
            .status-bar { flex-direction: column; align-items: center; gap: 5px; }
            
            .classroom-inner { max-width: 100%; }
            .stage-box { font-size: 14px; padding: 6px; margin-bottom: 12px; letter-spacing: 5px; }
            .row { width: 100%; gap: 2px; margin-bottom: 5px; }
            .seat { 
                flex: 0 1 40px; 
                min-width: 21px;
                height: auto;
                aspect-ratio: 45 / 55;
                font-size: clamp(8px, 2.5vw, 12px) !important;
                border-radius: 3px;
                padding: 0;
            }
            .seat:hover, .seat.locked { transform: scale(1.05); } 
        }
    </style>
</head>
<body>
    
    <div id="loadingMask">
        <div>â³ ç³»çµ±é€£ç·šä¸­...</div>
        <div style="font-size:16px; margin-top:10px; color:#999;">æ­£åœ¨æ ¡å°ä¼ºæœå™¨æ™‚é–“</div>
    </div>

    <header>
        <img src="logo1.png" alt="å±±ç†Šç§‘å­¸">
        <h1>å±±ç†Šç§‘å­¸ / å±±ç†Šå‡å¤§</h1>
        <img src="logo2.png" alt="å±±ç†Šå‡å¤§">
    </header>

    <div class="main-container">
        <a href="index.html" class="back-btn">å›ä¸Šä¸€é </a>

        <div id="courseInfoHeader" class="course-info-header">
            <h2 id="pageTitle">èª²ç¨‹åç¨±</h2>
            <p>ğŸ‘¨â€ğŸ« æˆèª²è€å¸«ï¼š<span id="pageTeacher">-</span></p>
            <p>â° ä¸Šèª²æ™‚é–“ï¼š<span id="pageTime">-</span></p>
            <p>ğŸ“ ä¸Šèª²æ•™å®¤ï¼š<span id="pageClassroom">-</span></p>
        </div>
        
        <div id="deadlineTimer"></div>

        <div class="status-bar">
            <span class="status-group">
                <span class="dot" style="background:#4CAF50;"></span>å¯é¸æ“‡
                <span class="dot" style="background:#e74c3c;"></span>å·²è¢«é¸å–
                <span class="dot" style="background:#f39c12;"></span>æœ‰äººå¡«å¯«ä¸­
            </span>
            <span class="status-group">
                <span class="dot" style="background:#3498db;"></span>æ‚¨çš„åº§ä½
                <span class="dot" style="background:#95a5a6;"></span>ä¸é–‹æ”¾
            </span>
        </div>

        <div class="classroom-wrapper">
            <div class="classroom-inner">
                <div id="stageArea"></div>
                <div id="classroom">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <div id="waitlistArea" class="waitlist-area">
            <p style="color:#d35400; font-weight:bold; margin-bottom:10px;">âš ï¸ åº§ä½å·²æ»¿ï¼Ÿæ‚¨å¯ä»¥ç™»è¨˜å€™è£œï¼š</p>
            <button id="btnWaitlist" class="btn-waitlist" onclick="openWaitlistModal()">ğŸ“ ç™»è¨˜å€™è£œ</button>
        </div>
    </div>

    <div id="bookingModal" class="modal-overlay">
        <div class="modal-box">
            <div id="bookingFormContent">
                <div class="modal-title">âš ï¸ å ±åå°šæœªå®Œæˆï¼Œè«‹å¡«å¯«å­¸ç”Ÿè³‡æ–™</div>
                <div id="modalCourseInfo" class="modal-course-info"></div>
                <div class="warning-text">
                    âš ï¸ è«‹åœ¨å€’æ•¸æ™‚é–“å…§å®Œæˆè³‡è¨Šï¼Œé€å‡ºæ‰ç®—åŠƒä½å®Œæˆã€‚<br>
                    âš ï¸ å­¸ç”Ÿå§“åé€å‡ºå¾Œç„¡æ³•æ›´æ”¹ï¼Œè«‹ç¢ºèªå¾Œå†é€å‡ºã€‚<br>
                    âš ï¸ é‡è¦†åŠƒä½æœƒè¢«ç³»çµ±éš¨æ©Ÿå–æ¶ˆç¬¬äºŒå€‹ä»¥ä¸Šçš„åº§ä½ã€‚
                </div>
                <div class="modal-desc">æ‚¨ç›®å‰é¸æ“‡çš„åº§ä½æ˜¯ï¼š<span id="modalSeatLabel" style="color:#e74c3c; font-size:24px;"></span></div>
                <div id="timerDisplay" class="timer-box">è¨ˆç®—å‰©é¤˜æ™‚é–“ä¸­...</div>
                <div class="form-group">
                    <label>å­¸ç”Ÿå§“åï¼š</label>
                    <input type="text" id="studentName" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">
                </div>
                <div class="form-group">
                    <label>å®¶é•·æ‰‹æ©Ÿï¼š</label>
                    <input type="tel" id="parentPhone" placeholder="09xxxxxxxx" maxlength="10">
                    <div class="input-hint">è«‹è¼¸å…¥ 10 ç¢¼æ‰‹æ©Ÿè™Ÿç¢¼ (å°‡ä½œç‚ºæŸ¥è©¢ä¾æ“š)</div>
                </div>
                <div style="display: none;">
                    <label>è«‹å‹¿å¡«å¯«æ­¤æ¬„ä½ (æ©Ÿå™¨äººé™·é˜±)ï¼š</label>
                    <input type="text" id="honeyPotField" value="" tabindex="-1" autocomplete="off">
                </div>
                <div class="recaptcha-wrapper">
                    <div id="recaptcha1"></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-cancel" id="cancelBtn">æ”¾æ£„é›¢é–‹</button>
                    <button class="btn btn-confirm" id="confirmBtn" disabled>ç¢ºèªé€å‡º</button>
                </div>
            </div>
            <div id="expirationMessage">
                <div style="font-size:50px;">â°</div>
                <h3>å¡«å¯«æ™‚é–“å·²åˆ°</h3>
                <p>åº§ä½å·²é‡‹å‡ºçµ¦å…¶ä»–äººï¼Œè«‹é‡æ–°é¸ä½ã€‚</p>
                <button class="btn btn-cancel" onclick="closeModal()">é—œé–‰è¦–çª—</button>
            </div>
        </div>
    </div>

    <div id="waitlistModal" class="modal-overlay">
        <div class="modal-box" style="border-top: 5px solid #e67e22;">
            <div class="modal-title">ğŸ“ ç™»è¨˜å€™è£œ</div>
            <div id="waitlistCourseInfo" class="modal-course-info"></div>
            <div class="warning-text">
                âš ï¸ è‹¥æœ‰åº§ä½é‡‹å‡ºï¼Œå°‡ä¾ç™»è¨˜é †åºé€šçŸ¥ã€‚<br>
                âš ï¸ è«‹å‹™å¿…å¡«å¯«æ­£ç¢ºè¯çµ¡è³‡è¨Šã€‚
            </div>
            <div class="form-group">
                <label>å­¸ç”Ÿå§“åï¼š</label>
                <input type="text" id="w_studentName" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">
            </div>
            <div class="form-group">
                <label>å®¶é•·æ‰‹æ©Ÿï¼š</label>
                <input type="tel" id="w_parentPhone" placeholder="09xxxxxxxx" maxlength="10">
            </div>
            <div class="form-group">
                <label>å‚™è¨» (å¯é¸)ï¼š</label>
                <input type="text" id="w_note" placeholder="ä¾‹å¦‚ï¼šå¸Œæœ›æ’é€±å››ç­">
            </div>
            <div class="recaptcha-wrapper">
                <div id="recaptcha2"></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-cancel" onclick="closeWaitlistModal()">å–æ¶ˆ</button>
                <button class="btn btn-confirm" id="w_confirmBtn" style="background-color:#e67e22;" disabled>é€å‡ºå€™è£œ</button>
            </div>
        </div>
    </div>

    <footer>
        &copy; 2024 å±±ç†Šç§‘å­¸è£œç¿’ç­ | ç³»çµ±é–‹ç™¼ï¼šSciencebear Tech Team
    </footer>

    <!-- â˜…â˜…â˜… é›™ LINE æŒ‰éˆ• â˜…â˜…â˜… -->
    <div class="float-line-container">
        <a href="https://lin.ee/FDQ1BLD" target="_blank" class="line-btn btn-bear" title="å±±ç†Šç§‘å­¸å®˜æ–¹LINE">
            <span class="small">å±±ç†Šç§‘å­¸</span>
            <span class="large">LINE</span>
        </a>
        <a href="https://lin.ee/kzE9NrI" target="_blank" class="line-btn btn-high" title="å±±ç†Šå‡å¤§å®˜æ–¹LINE">
            <span class="small">å±±ç†Šå‡å¤§</span>
            <span class="large">LINE</span>
        </a>
    </div>

    <script type="module">
        import { db, ref, set, update, get, child, push } from './firebase-config.js';
        import { onValue, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        let widgetId1, widgetId2;
        let isVerified1 = false; 
        let isVerified2 = false; 
        let serverTimeOffset = 0; 
        let courseSettings = null; 
        let waitlistCount = 0;
        let totalSeats = 0;
        let soldCount = 0;
        let isClassroomRendered = false;
        
        let isManualRelease = false; 
        
        // â˜…â˜…â˜… æ–°å¢ï¼šåæ‡‰æ™‚é–“ç´€éŒ„è®Šæ•¸ â˜…â˜…â˜…
        let pageLoadTime = 0;
        let reactionMs = 0;

        window.onloadCallback = function() {
            widgetId1 = grecaptcha.render('recaptcha1', {
                'sitekey': '6LdkWVwsAAAAAKBQSZKiPxOQ7E3ZbL0V-zaclqt5',
                'callback': function() { isVerified1 = true; document.getElementById('confirmBtn').disabled = false; },
                'expired-callback': function() { isVerified1 = false; document.getElementById('confirmBtn').disabled = true; }
            });
            widgetId2 = grecaptcha.render('recaptcha2', {
                'sitekey': '6LdkWVwsAAAAAKBQSZKiPxOQ7E3ZbL0V-zaclqt5',
                'callback': function() { isVerified2 = true; document.getElementById('w_confirmBtn').disabled = false; },
                'expired-callback': function() { isVerified2 = false; document.getElementById('w_confirmBtn').disabled = true; }
            });
        };

        const classrooms = {
            "high_red": { name: "é«˜ä¸­ç´…æ•™å®¤", layout: [ ["1-1:X", "1-2:X", "_", "1-3", "1-4", "1-5", "_", "1-6", "1-7", "1-8", "_", "1-9:X", "1-10:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8", "_", "2-9", "2-10"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8", "_", "3-9", "3-10"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8", "_", "4-9", "4-10"], ["5-1", "5-2", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "5-8", "_", "5-9", "5-10"], ["6-1", "6-2", "_", "6-3", "6-4", "6-5", "_", "6-6", "6-7", "6-8", "_", "6-9", "6-10"], ["7-1", "7-2", "_", "7-3", "7-4", "7-5", "_", "7-6", "7-7", "7-8", "_", "7-9", "7-10"], ["8-1:X", "8-2:X", "_", "8-3:X", "8-4:X", "8-5:X", "_", "8-6:X", "8-7:X", "8-8:X", "_", "_", "DOOR"] ] },
            "high_orange": { name: "é«˜ä¸­æ©˜æ•™å®¤", layout: [ ["1-1:X", "1-2:X", "_", "1-3", "1-4", "1-5", "_", "1-6", "1-7", "1-8", "_", "1-9:X", "1-10:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8", "_", "2-9", "2-10"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8", "_", "3-9", "3-10"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8", "_", "4-9", "4-10"], ["5-1", "5-2", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "5-8", "_", "5-9", "5-10"], ["6-1", "6-2", "_", "6-3", "6-4", "6-5", "_", "6-6", "6-7", "6-8", "_", "6-9", "6-10"], ["_","_","_","_","_","_","_","_","_","_","_","_","DOOR"] ] },
            "high_green": { name: "é«˜ä¸­ç¶ æ•™å®¤", layout: [ ["1-1:X", "1-2", "_", "1-3", "1-4", "1-5", "_", "1-6:X", "1-7:X", "1-8:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8"], ["5-1", "5-2", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "5-8:X"], ["6-1:X", "6-2:X", "_", "6-3:X", "6-4:X", "6-5:X", "_", "_", "_", "DOOR"] ] },
            "high_yellow": { name: "é«˜ä¸­é»ƒæ•™å®¤", layout: [ ["1-1:X", "1-2:X", "_", "1-3", "1-4", "1-5", "_", "1-6:X", "1-7:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7"], ["DOOR", "_", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7"], ["_", "_", "_", "5-3:X", "5-4:X", "5-5:X", "_", "5-6:X", "5-7:X"], ["_", "_", "_", "_", "_", "_", "_", "_", "_"] ] },
            "high_blue": { name: "é«˜ä¸­è—æ•™å®¤", layout: [ ["1-1:X", "1-2", "_", "1-3", "1-4", "1-5", "_", "1-6:X", "1-7:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7"], ["5-1:X", "5-2:X", "_", "5-3:X", "5-4:X", "_", "_", "5-6:X", "5-7:X"], ["6-1:X", "6-2:X", "_", "_", "DOOR", "_", "_", "_", "_"] ] },
            "middle_new_orange": { name: "åœ‹ä¸­æ–°æ©˜æ•™å®¤", layout: [ ["1-1:X", "1-2", "_", "1-3", "1-4", "1-5", "_", "1-6", "1-7", "1-8:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8:X"], ["DOOR", "_", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "PILLAR"] ] },
            "middle_new_blue": { name: "åœ‹ä¸­æ–°è—æ•™å®¤", layout: [ ["1-1", "1-2", "1-3", "_", "1-4", "1-5", "1-6", "1-7:X"], ["2-1", "2-2", "2-3", "_", "2-4", "2-5", "2-6", "2-7:X"], ["3-1", "3-2", "3-3", "_", "3-4", "3-5", "3-6", "3-7:X"], ["4-1", "4-2", "4-3", "_", "4-4", "4-5", "4-6", "4-7:X"], ["5-1", "5-2", "5-3", "_", "5-4", "5-5", "5-6", "5-7:X"], ["6-1:X", "6-2:X", "6-3:X", "_", "6-4:X", "6-5:X", "6-6:X", "6-7:X"], ["7-1:X", "7-2:X", "7-3:X", "_", "7-4:X", "7-5:X", "7-6:X", "7-7:X"], ["DOOR", "_", "_", "_", "_", "_", "_", "_"] ] },
            "middle_new_yellow": { name: "åœ‹ä¸­æ–°é»ƒæ•™å®¤", layout: [ ["1-1:X", "1-2", "1-3", "_", "1-4", "1-5", "1-6", "_", "1-7", "1-8:X"], ["PILLAR", "2-2", "2-3", "_", "2-4", "2-5", "2-6", "_", "2-7", "2-8:X"], ["3-1:X", "3-2", "3-3", "_", "3-4", "3-5", "3-6", "_", "3-7", "3-8"], ["4-1", "4-2", "4-3", "_", "4-4", "4-5", "4-6", "_", "4-7", "4-8"], ["5-1", "5-2", "5-3", "_", "5-4", "5-5", "5-6", "_", "5-7", "5-8"], ["6-1:X", "6-2", "6-3", "_", "6-4", "6-5", "6-6", "_", "6-7", "6-8"], ["DOOR", "_", "_", "_", "_", "_", "_", "_", "_", "_"] ] },
            "middle_new_red": { name: "åœ‹ä¸­æ–°ç´…æ•™å®¤", layout: [ ["1-1:X", "1-2:X", "1-3", "_", "1-4", "1-5", "1-6", "1-7", "_", "1-8", "1-9:X", "1-10:X"], ["2-1", "2-2", "2-3", "_", "2-4", "2-5", "2-6", "2-7", "_", "2-8", "2-9", "2-10"], ["3-1", "3-2", "3-3", "_", "3-4", "3-5", "3-6", "3-7", "_", "3-8", "3-9", "3-10"], ["DOOR", "_", "_", "_", "_", "_", "_", "_", "_", "_", "_", "_"], ["4-1", "4-2", "4-3", "_", "4-4", "4-5", "4-6", "4-7", "_", "4-8", "4-9", "4-10"], ["5-1", "5-2", "5-3", "_", "5-4", "5-5", "5-6", "5-7", "_", "5-8", "5-9", "5-10"], ["6-1", "6-2", "6-3", "_", "6-4", "6-5", "6-6", "6-7", "_", "6-8", "6-9", "6-10"], ["7-1", "7-2", "7-3", "_", "7-4", "7-5", "7-6", "7-7", "_", "7-8", "7-9", "7-10"], ["8-1:X", "8-2:X", "8-3:X","_","8-4:X", "8-5:X", "8-6:X", "8-7:X", "_", "8-8:X", "8-9:X", "8-10:X"] ] },
            "middle_big_red": { name: "åœ‹ä¸­å¤§ç´…æ•™å®¤", layout: [ ["1-1:X", "1-2:X", "_", "1-3", "1-4", "1-5", "_", "1-6", "1-7", "1-8", "_", "1-9:X", "1-10:X"], ["2-1", "2-2", "_", "2-3", "2-4", "2-5", "_", "2-6", "2-7", "2-8", "_", "2-9", "2-10"], ["3-1", "3-2", "_", "3-3", "3-4", "3-5", "_", "3-6", "3-7", "3-8", "_", "3-9", "3-10"], ["4-1", "4-2", "_", "4-3", "4-4", "4-5", "_", "4-6", "4-7", "4-8", "_", "4-9", "4-10"], ["5-1", "5-2", "_", "5-3", "5-4", "5-5", "_", "5-6", "5-7", "5-8", "_", "5-9", "5-10"], ["6-1", "6-2", "_", "6-3", "6-4", "6-5", "_", "6-6", "6-7", "6-8", "_", "6-9", "6-10"], ["7-1:X", "7-2:X", "_", "7-3:X", "7-4:X", "7-5:X", "_", "7-6:X", "7-7:X", "7-8:X", "_", "7-9:X", "7-10:X"], ["_","_","_","_","_","_","_","_","_","_","_","_","DOOR"] ] },
            "middle_da_chiao": { name: "åœ‹ä¸­å¤§æ©˜æ•™å®¤", layout: [ ["1-1:X", "1-2:X", "1-3", "_", "1-4", "1-5", "1-6", "_", "1-7", "1-8:X"], ["2-1", "2-2", "2-3", "_", "2-4", "2-5", "2-6", "_", "2-7", "2-8"], ["3-1", "3-2", "3-3", "_", "3-4", "3-5", "3-6", "_", "3-7", "3-8"], ["4-1", "4-2", "4-3", "_", "4-4", "4-5", "4-6", "_", "4-7", "4-8"], ["5-1", "5-2", "5-3", "_", "5-4", "5-5", "5-6", "_", "_", "DOOR"] ] },
            "middle_big_green": { name: "åœ‹ä¸­å¤§ç¶ æ•™å®¤", layout: [ ["DOOR", "_", "_", "_", "_", "_"], ["1-1", "1-2", "1-3", "_", "1-4", "1-5"], ["2-1", "2-2", "2-3", "_", "2-4", "2-5"], ["3-1", "3-2", "3-3", "_", "3-4", "3-5"], ["PILLAR", "4-2", "4-3", "_", "4-4", "4-5"] ] },
            
            "test_room": { 
                name: "æ¸¬è©¦å°ˆç”¨æ•™å®¤", 
                hasStage: true, 
                layout: [ 
                    ["1-1", "1-2"]
                ] 
            }
        };

        let currentClassId = null;
        let currentCourseData = null;
        let myUserId = localStorage.getItem('tempUserId');
        if (!myUserId) {
            myUserId = 'user_' + Math.floor(Math.random() * 100000);
            localStorage.setItem('tempUserId', myUserId);
        }
        
        const classroomDiv = document.getElementById('classroom');
        const stageArea = document.getElementById('stageArea');
        const loadingMask = document.getElementById('loadingMask');
        const waitlistArea = document.getElementById('waitlistArea');
        const deadlineTimer = document.getElementById('deadlineTimer');
        const btnWaitlist = document.getElementById('btnWaitlist');
        let currentSeatId = null;
        let timerInterval = null;
        const TIMEOUT_SECONDS = 60;
        let unsubscribe = null; 

        async function init() {
            // â˜…â˜…â˜… æ–°å¢ï¼šå•Ÿå‹•ç¢¼è¡¨ â˜…â˜…â˜…
            pageLoadTime = Date.now();

            const params = new URLSearchParams(window.location.search);
            const courseId = params.get('class'); 

            if (!courseId) {
                alert("ç„¡æ•ˆçš„èª²ç¨‹é€£çµï¼");
                window.location.href = "index.html"; 
                return;
            }

            currentClassId = courseId;

            onValue(ref(db, `courses/${courseId}`), (snapshot) => {
                if (!snapshot.exists()) {
                    alert("èª²ç¨‹ä¸å­˜åœ¨");
                    window.location.href = "index.html";
                    return;
                }
                currentCourseData = snapshot.val();
                
                document.getElementById('pageTitle').textContent = `ğŸ» ${currentCourseData.subject} ${currentCourseData.classType || ''} - åŠƒä½`;
                document.getElementById('pageTeacher').textContent = currentCourseData.teacher;
                document.getElementById('pageTime').textContent = currentCourseData.timeDescription;
                
                const classroomType = currentCourseData.classroom;
                if (classrooms[classroomType]) {
                    document.getElementById('pageClassroom').textContent = classrooms[classroomType].name;
                }
                
                updateWaitlistButton();

                // â˜…â˜…â˜… V33.1 ä¿®æ­£ï¼šå³æ™‚ç›£è½ Layout è®ŠåŒ– â˜…â˜…â˜…
                // å¦‚æœæ•™å®¤å·²ç¶“æ¸²æŸ“éä¸€æ¬¡ï¼Œä»£è¡¨ä½¿ç”¨è€…æ­£åœ¨çœ‹é é¢
                // é€™æ™‚å€™å¦‚æœå¾Œå°æ”¹äº† Layoutï¼Œæˆ‘å€‘è¦å¼·åˆ¶é‡ç•«
                if (isClassroomRendered) {
                    console.log("åµæ¸¬åˆ°èª²ç¨‹è³‡æ–™è®Šæ›´ï¼Œé‡æ–°æ¸²æŸ“åº§ä½è¡¨...");
                    renderClassroom(currentCourseData.classroom);
                    // é‡ç•«å¾Œï¼Œå¿…é ˆé‡æ–°æ›è¼‰åº§ä½ç‹€æ…‹ç›£è½ (ç´…/é»ƒç‡ˆ)
                    startRealtimeListener();
                }
            });

            onValue(ref(db, `seats/${courseId}/_settings`), (snapshot) => {
                if (!snapshot.exists()) return;
                courseSettings = snapshot.val();
                
                onValue(ref(db, ".info/serverTimeOffset"), (snap) => {
                    serverTimeOffset = snap.val() || 0;
                    const serverTime = Date.now() + serverTimeOffset;
                    
                    if (currentCourseData) {
                        checkTimeAndRender(serverTime, courseSettings, currentCourseData.classroom);
                    } else {
                        setTimeout(() => {
                            if (currentCourseData) checkTimeAndRender(serverTime, courseSettings, currentCourseData.classroom);
                        }, 500);
                    }
                    
                    setInterval(() => checkExpiration(courseSettings), 1000);
                }, { onlyOnce: true });
            });

            onValue(ref(db, `waitlist/${courseId}`), (snapshot) => {
                const data = snapshot.val() || {};
                waitlistCount = 0;
                Object.values(data).forEach(w => {
                    if (w.status !== 'deleted') {
                        waitlistCount++;
                    }
                });
                updateWaitlistButton();
            });
        }

        function checkTimeAndRender(now, settings, classroomType) {
            const { start1, end1, start2, end2 } = settings;
            const isOpen1 = (now >= start1 && now < end1);
            const isOpen2 = (now >= start2 && (!end2 || now < end2));

            if (!isOpen1 && !isOpen2) {
                let msg = "â›” ç›®å‰éé–‹æ”¾åŠƒä½æ™‚é–“ï¼";
                if (now < start1) msg = "â›” åŠƒä½å°šæœªé–‹å§‹ï¼è«‹å‹¿å·è·‘ï¼";
                if (now >= end1 && now < start2) msg = "â›” ç³»çµ±æ•´ç†ä¸­ï¼Œæš«åœé–‹æ”¾ï¼";
                alert(msg);
                window.location.href = "index.html"; 
                return;
            }

            const hasPhase2 = (start2 && start2 < 9999999999999);
            const isPhase2 = (now >= start2);

            if (currentCourseData && currentCourseData.waitlistEnabled && soldCount >= totalSeats) {
                if (!hasPhase2 || (hasPhase2 && isPhase2)) {
                    waitlistArea.style.display = "block";
                    updateWaitlistButton();
                } else {
                    waitlistArea.style.display = "none";
                }
            } else {
                waitlistArea.style.display = "none";
            }

            let targetTime = null;
            if (isOpen1) {
                if (end1 < 9999999999999) targetTime = end1;
            } else if (isOpen2) {
                if (end2 && end2 < 9999999999999) targetTime = end2;
            }

            if (targetTime) {
                deadlineTimer.style.display = "block";
                updateDeadlineTimer(targetTime);
                setInterval(() => updateDeadlineTimer(targetTime), 1000);
            } else {
                deadlineTimer.style.display = "none";
            }

            loadingMask.style.display = "none";
            
            if (!isClassroomRendered) {
                renderClassroom(classroomType);
                startRealtimeListener();
                isClassroomRendered = true;
            }
        }

        function updateWaitlistButton() {
            if (!currentCourseData) return;
            const limit = currentCourseData.waitlistLimit || 0;
            
            if (limit > 0 && waitlistCount >= limit) {
                btnWaitlist.textContent = "ğŸ”´ å€™è£œå·²é¡æ»¿";
                btnWaitlist.disabled = true;
                btnWaitlist.style.backgroundColor = "#e74c3c";
            } else {
                btnWaitlist.textContent = "ğŸ“ ç™»è¨˜å€™è£œ";
                btnWaitlist.disabled = false;
                btnWaitlist.style.backgroundColor = "#e67e22";
            }
        }

        function updateDeadlineTimer(targetTime) {
            const now = Date.now() + serverTimeOffset;
            const diff = targetTime - now;
            if (diff <= 0) {
                deadlineTimer.textContent = "åŠƒä½æ™‚é–“å·²çµæŸ";
            } else {
                const totalSec = Math.floor(diff / 1000);
                const h = Math.floor(totalSec / 3600);
                const m = Math.floor((totalSec % 3600) / 60);
                const s = totalSec % 60;
                deadlineTimer.textContent = `â³ è·é›¢åŠƒä½çµæŸé‚„æœ‰ï¼š${h}æ™‚ ${m}åˆ† ${s}ç§’`;
            }
        }

        function checkExpiration(settings) {
            const now = Date.now() + serverTimeOffset;
            const { start1, end1, start2, end2 } = settings;
            
            if (now >= end1 && now < start2) {
                alert("â° ç¬¬ä¸€éšæ®µåŠƒä½æ™‚é–“å·²çµæŸï¼\nç³»çµ±æ•´ç†ä¸­ï¼Œè«‹ç¨å¾Œå†å›ä¾†ã€‚");
                window.location.href = "index.html";
            }
            if (end2 && end2 < 9999999999999 && now >= end2) {
                alert("â° åŠƒä½æ™‚é–“å·²å…¨éƒ¨çµæŸï¼");
                window.location.href = "index.html";
            }
        }

        function renderClassroom(type) {
            // â˜…â˜…â˜… V33.0 æ ¸å¿ƒå‡ç´šï¼šè³‡æ–™é©…å‹•æ¸²æŸ“ â˜…â˜…â˜…
            // å„ªå…ˆæª¢æŸ¥è©²èª²ç¨‹æ˜¯å¦æœ‰ã€Œå®¢è£½åŒ– Layoutã€(å½±å°å­˜æª”)
            // å¦‚æœæ²’æœ‰ï¼Œæ‰å›é€€ä½¿ç”¨ classrooms[type] çš„é è¨­ç¯„æœ¬
            
            let layoutToRender = null;
            let hasStage = true; // é è¨­æœ‰è¬›å°

            if (currentCourseData && currentCourseData.layout) {
                layoutToRender = currentCourseData.layout;
                // å®¢è£½åŒ– Layout é è¨­è¦–ç‚ºæœ‰è¬›å° (æˆ–æœªä¾†å¯æ“´å……æ¬„ä½)
            } else if (classrooms[type]) {
                layoutToRender = classrooms[type].layout;
                hasStage = classrooms[type].hasStage;
            }

            if (!layoutToRender) {
                classroomDiv.innerHTML = "ç„¡æ³•è¼‰å…¥åº§ä½è¡¨";
                return;
            }

            stageArea.innerHTML = hasStage ? '<div class="stage-box">è¬›ã€€å°</div>' : '';
            classroomDiv.innerHTML = "";
            totalSeats = 0; 
            
            layoutToRender.forEach((row) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';
                row.forEach((seatCode) => {
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    let code = seatCode;
                    let isBlocked = false;
                    if (seatCode.includes(':X')) { code = seatCode.split(':')[0]; isBlocked = true; }

                    if (code === "_") seat.classList.add('aisle');
                    else if (code === "DOOR") { seat.classList.add('door'); seat.textContent = "é–€"; }
                    else if (code === "PILLAR") { seat.classList.add('pillar'); seat.textContent = "æŸ±"; }
                    else {
                        seat.textContent = code;
                        seat.dataset.id = code;
                        seat.id = `seat-${code}`;
                        if (isBlocked) seat.classList.add('blocked');
                        else {
                            seat.addEventListener('click', () => tryLockSeat(code));
                            totalSeats++; 
                        }
                    }
                    rowDiv.appendChild(seat);
                });
                classroomDiv.appendChild(rowDiv);
            });
        }

        function startRealtimeListener() {
            if (unsubscribe) unsubscribe();
            const classRef = ref(db, `seats/${currentClassId}`);
            
            unsubscribe = onValue(classRef, (snapshot) => {
                const data = snapshot.val() || {};
                soldCount = 0; 

                if (currentSeatId) {
                    const currentSeatData = data[currentSeatId];
                    if (!currentSeatData || (currentSeatData.user !== myUserId && currentSeatData.status !== 'sold')) {
                         if (!isManualRelease) {
                             if (!currentSeatData || currentSeatData.user !== myUserId) {
                                 alert("âš ï¸ æ‚¨çš„ä¿ç•™ä½å·²è¢«é‡‹å‡ºæˆ–ç”±ç®¡ç†å“¡ç§»é™¤ï¼è«‹é‡æ–°åŠƒä½ã€‚");
                                 closeModal(); 
                             }
                         }
                         isManualRelease = false; 
                    }
                }

                document.querySelectorAll('.seat').forEach(seatEl => {
                    const seatId = seatEl.dataset.id;
                    if (!seatId || seatEl.classList.contains('blocked')) return;

                    const seatInfo = data[seatId];
                    seatEl.classList.remove('sold', 'locked', 'mylocked'); 
                    seatEl.style.backgroundColor = ""; 
                    
                    if (seatInfo) {
                        if (seatInfo.status === 'sold') {
                            if (seatInfo.user === myUserId) {
                                seatEl.classList.add('mylocked'); 
                            } else {
                                seatEl.classList.add('sold'); 
                            }
                            soldCount++; 
                        } else if (seatInfo.status === 'locked') {
                            if (seatInfo.user === myUserId) {
                                seatEl.classList.add('mylocked'); 
                                checkAndRestoreSession(seatId, seatInfo.timestamp);
                            } else if (seatInfo.user === 'admin_reserved') {
                                seatEl.classList.add('locked'); 
                            } else {
                                seatEl.classList.add('locked'); 
                            }
                        }
                    }
                });

                const now = Date.now() + serverTimeOffset;
                if (courseSettings) {
                    const { start2 } = courseSettings;
                    const hasPhase2 = (start2 && start2 < 9999999999999);
                    const isPhase2 = (now >= start2);

                    if (currentCourseData && currentCourseData.waitlistEnabled && soldCount >= totalSeats) {
                        if (!hasPhase2 || (hasPhase2 && isPhase2)) {
                            waitlistArea.style.display = "block";
                            updateWaitlistButton();
                        } else {
                            waitlistArea.style.display = "none";
                        }
                    } else {
                        waitlistArea.style.display = "none";
                    }
                }
            });
        }

        function openWaitlistModal() {
            document.getElementById('waitlistModal').style.display = 'flex';
            
            if (currentCourseData) {
                document.getElementById('waitlistCourseInfo').innerHTML = 
                    `<strong>${currentCourseData.subject} ${currentCourseData.classType || ''}</strong><br>
                     ğŸ‘¨â€ğŸ« ${currentCourseData.teacher}<br>
                     â° ${currentCourseData.timeDescription || ''}<br>
                     ğŸ“… é–‹èª²ï¼š${currentCourseData.startDate || ''}`;
            }

            try { if(grecaptcha && grecaptcha.reset && widgetId2 !== undefined) grecaptcha.reset(widgetId2); } catch(e) { console.log("ReCAPTCHA reset skipped"); }
        }

        function closeWaitlistModal() {
            document.getElementById('waitlistModal').style.display = 'none';
        }

        document.getElementById('w_confirmBtn').addEventListener('click', () => {
            if (!isVerified2) { alert("ğŸ¤– è«‹å‹¾é¸ã€Œæˆ‘ä¸æ˜¯æ©Ÿå™¨äººã€ï¼"); return; } 

            const name = document.getElementById('w_studentName').value.trim();
            const phone = document.getElementById('w_parentPhone').value.trim();
            const note = document.getElementById('w_note').value.trim();

            if (!name || !phone) { alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™ï¼"); return; }
            const phoneRegex = /^09\d{8}$/;
            if (!phoneRegex.test(phone)) { alert("âŒ æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼éŒ¯èª¤ï¼"); return; }

            const waitlistRef = push(ref(db, `waitlist/${currentClassId}`));
            set(waitlistRef, {
                studentName: name,
                parentPhone: phone,
                note: note,
                timestamp: serverTimestamp()
            }).then(() => {
                alert("âœ… å€™è£œç™»è¨˜æˆåŠŸï¼\nè‹¥æœ‰åº§ä½é‡‹å‡ºï¼Œå°‡ä¾åºé€šçŸ¥ã€‚");
                closeWaitlistModal();
            }).catch(err => alert("éŒ¯èª¤ï¼š" + err));
        });

        function tryLockSeat(seatId) {
            // â˜…â˜…â˜… æ–°å¢ï¼šé»æ“Šæ™‚è¨ˆç®—åæ‡‰æ™‚é–“ â˜…â˜…â˜…
            const clickTime = Date.now();
            reactionMs = clickTime - pageLoadTime;
            console.log(`åæ‡‰æ™‚é–“: ${reactionMs} ms`);

            if (currentSeatId && currentSeatId !== seatId) { alert("æ‚¨å·²ç¶“æœ‰ä¸€å€‹åº§ä½æ­£åœ¨ä¿ç•™ä¸­ï¼"); return; }
            const seatEl = document.getElementById(`seat-${seatId}`);
            
            if (seatEl.classList.contains('sold') || seatEl.classList.contains('locked') || seatEl.classList.contains('blocked')) {
                return; 
            }
            if (seatEl.classList.contains('mylocked')) {
                return;
            }

            seatEl.classList.add('loading');
            const seatRef = ref(db, `seats/${currentClassId}/${seatId}`);
            
            const nowTimestamp = Date.now() + serverTimeOffset;
            
            runTransaction(seatRef, (currentData) => {
                if (currentData === null || (currentData && currentData.status === 'deleted')) { 
                    return { status: 'locked', user: myUserId, timestamp: nowTimestamp }; 
                } else { 
                    return; 
                }
            }).then((result) => {
                seatEl.classList.remove('loading');
                if (result.committed) { openBookingModal(seatId, nowTimestamp); } 
                else { alert("æ…¢äº†ä¸€æ­¥ï¼"); }
            }).catch(err => {
                console.error(err);
                seatEl.classList.remove('loading');
                alert("âŒ åŠƒä½å¤±æ•—ï¼(å¯èƒ½æ˜¯éé–‹æ”¾æ™‚é–“)");
            });
        }

        const modal = document.getElementById('bookingModal');
        const modalSeatLabel = document.getElementById('modalSeatLabel');
        const nameInput = document.getElementById('studentName');
        const phoneInput = document.getElementById('parentPhone');
        const honeyPotInput = document.getElementById('honeyPotField');
        const timerDisplay = document.getElementById('timerDisplay');
        const confirmBtn = document.getElementById('confirmBtn');

        function checkAndRestoreSession(seatId, lockTimestamp) {
            const modal = document.getElementById('bookingModal');
            if (currentSeatId === seatId && modal.style.display === "flex") return;
            
            const now = Date.now() + serverTimeOffset;
            const elapsedSeconds = Math.floor((now - lockTimestamp) / 1000);
            const remaining = TIMEOUT_SECONDS - elapsedSeconds;
            if (remaining > 0) { openBookingModal(seatId, lockTimestamp); } 
            else { if (currentSeatId !== seatId) { currentSeatId = seatId; releaseSeat(true); } }
        }

        function openBookingModal(seatId, lockTimestamp) {
            currentSeatId = seatId;
            modalSeatLabel.textContent = seatId;
            
            if (currentCourseData) {
                document.getElementById('modalCourseInfo').innerHTML = 
                    `<strong>${currentCourseData.subject} ${currentCourseData.classType || ''}</strong><br>
                     ğŸ‘¨â€ğŸ« ${currentCourseData.teacher}<br>
                     â° ${currentCourseData.timeDescription || ''}<br>
                     ğŸ“… é–‹èª²ï¼š${currentCourseData.startDate || ''}`;
            }

            document.getElementById('bookingFormContent').style.display = 'block';
            document.getElementById('expirationMessage').style.display = 'none';

            modal.style.display = "flex";
            isVerified1 = false; 
            confirmBtn.disabled = true; 
            honeyPotInput.value = ""; 
            try { if(grecaptcha && grecaptcha.reset && widgetId1 !== undefined) grecaptcha.reset(widgetId1); } catch(e) { console.log("ReCAPTCHA reset skipped"); }
            startPrecisionTimer(lockTimestamp);
        }

        function startPrecisionTimer(startTimestamp) {
            clearInterval(timerInterval);
            updateTimerLoop(startTimestamp);
            timerInterval = setInterval(() => { updateTimerLoop(startTimestamp); }, 1000);
        }

        function updateTimerLoop(startTimestamp) {
            const now = Date.now() + serverTimeOffset;
            const elapsed = Math.floor((now - startTimestamp) / 1000);
            const remaining = TIMEOUT_SECONDS - elapsed;
            
            if (remaining <= 0) {
                clearInterval(timerInterval);
                handleTimeout(); 
            } else { 
                updateTimerDisplay(remaining); 
            }
        }

        function handleTimeout() {
            document.getElementById('bookingFormContent').style.display = 'none';
            document.getElementById('expirationMessage').style.display = 'block';
            releaseSeat(true);
        }

        function updateTimerDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            timerDisplay.textContent = `å‰©é¤˜æ™‚é–“ï¼š0${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
            if (seconds < 10) { timerDisplay.style.backgroundColor = "#ffcccc"; timerDisplay.style.color = "red"; } 
            else { timerDisplay.style.backgroundColor = "#fff3cd"; timerDisplay.style.color = "#856404"; }
        }

        function releaseSeat(isAuto = false) {
            if (!currentSeatId) return;
            const seatToRelease = currentSeatId;
            
            if (!isAuto) {
                isManualRelease = true;
            }

            if (isAuto) {
                currentSeatId = null;
                set(ref(db, `seats/${currentClassId}/${seatToRelease}`), null);
            } else {
                set(ref(db, `seats/${currentClassId}/${seatToRelease}`), null).then(() => {
                    closeModal(); 
                    if (!isAuto) { alert("å·²å–æ¶ˆä¿ç•™ã€‚"); }
                }).catch(err => { console.error("é‡‹å‡ºå¤±æ•—", err); closeModal(); });
            }
        }
        
        function closeModal() {
            modal.style.display = "none";
            currentSeatId = null;
            clearInterval(timerInterval);
            nameInput.value = ""; phoneInput.value = "";
        }

        document.getElementById('cancelBtn').addEventListener('click', () => releaseSeat(false));

        confirmBtn.addEventListener('click', () => {
            if (honeyPotInput.value !== "") { alert("ç³»çµ±åµæ¸¬åˆ°ç•°å¸¸æ“ä½œã€‚"); return; }
            if (!currentSeatId) { alert("âš ï¸ åº§ä½ä¿ç•™æ™‚é–“å·²åˆ°ï¼Œè«‹é‡æ–°é¸ä½ï¼"); closeModal(); return; } 
            
            const name = nameInput.value.trim();
            const phone = phoneInput.value.trim();
            if (!isVerified1) { alert("ğŸ¤– è«‹å‹¾é¸ã€Œæˆ‘ä¸æ˜¯æ©Ÿå™¨äººã€ï¼"); return; } 
            if (!name || !phone) { alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™ï¼"); return; }
            const phoneRegex = /^09\d{8}$/;
            if (!phoneRegex.test(phone)) { alert("âŒ æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼éŒ¯èª¤ï¼"); return; }
            
            const orderId = Date.now().toString().slice(-6) + Math.floor(Math.random() * 100);
            const timestamp = new Date().toLocaleString();

            const seatData = {
                status: 'sold', 
                studentName: name, 
                parentPhone: phone, 
                soldTime: timestamp,
                orderId: orderId,
                user: myUserId 
            };

            const orderData = {
                orderId: orderId,
                courseId: currentClassId,
                seatId: currentSeatId,
                studentName: name,
                parentPhone: phone,
                timestamp: serverTimestamp(), 
                displayTime: timestamp,
                reactionTime: reactionMs // â˜…â˜…â˜… æ–°å¢ï¼šå¯«å…¥åæ‡‰æ™‚é–“ â˜…â˜…â˜…
            };

            const updates = {};
            updates[`seats/${currentClassId}/${currentSeatId}`] = seatData;
            updates[`orders/${phone}/${orderId}`] = orderData; 

            update(ref(db), updates).then(() => {
                alert(`âœ… åŠƒä½æˆåŠŸï¼\nåº§ä½ï¼š${currentSeatId}\nè¨‚å–®ç·¨è™Ÿï¼š${orderId}\nè«‹æˆªåœ–ç•™å­˜ï¼`);
                closeModal();
            }).catch((err) => {
                if (err.message.includes("PERMISSION_DENIED")) {
                    alert("é€å‡ºå¤±æ•—ï¼šâ›” ç›®å‰éåŠƒä½æ™‚æ®µæˆ–å·²è¢«æ¶èµ°ï¼");
                } else {
                    alert("é€å‡ºå¤±æ•—ï¼š" + err.message);
                }
                console.error(err);
            });
        });

        window.openWaitlistModal = openWaitlistModal;
        window.closeWaitlistModal = closeWaitlistModal;
        window.closeModal = closeModal;

        init();
    </script>
    <script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit&hl=zh-TW" async defer></script>
</body>
</html>