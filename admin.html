<!-- æª”æ¡ˆï¼šadmin.html -->
<!-- ç‰ˆæœ¬ï¼šV13.0 æœ€çµ‚ç‰ˆ (TinyMCE æ­£ç‰ˆ + Firebase Storage) -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ» å±±ç†Šç§‘å­¸ - å¾Œå°æŒ‡æ®ä¸­å¿ƒ</title>
    
    <!-- å¼•å…¥ TinyMCE (ä½¿ç”¨é˜¿å–µè€å¸«çš„ API Key) -->
    <script src="https://cdn.tiny.cloud/1/2nwvnffdvbvf93d6ry0sov7w0d7yabtr1d6tp8l38cb6hoh1/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; padding: 20px; margin: 0; }
        .navbar { background-color: #2c3e50; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; color: white; }
        .nav-title { font-size: 24px; font-weight: bold; }
        .nav-tabs button { background: none; border: none; color: #bdc3c7; font-size: 18px; cursor: pointer; margin-left: 20px; padding: 5px 10px; transition: 0.3s; }
        .nav-tabs button.active { color: white; border-bottom: 3px solid #e74c3c; font-weight: bold; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .form-container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 900px; margin: 0 auto; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        .form-row { display: flex; gap: 20px; }
        .form-row .form-group { flex: 1; }
        button { cursor: pointer; background-color: #3498db; color: white; border: none; font-weight: bold; padding: 10px 20px; border-radius: 5px; font-size: 16px; }
        button:hover { background-color: #2980b9; }
        button.danger { background-color: #e74c3c; }
        button.success { background-color: #27ae60; }
        .course-list { margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .admin-course-card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 5px solid #3498db; position: relative; }
        .btn-delete { position: absolute; top: 10px; right: 10px; background: #e74c3c; padding: 5px 10px; font-size: 12px; }
        .table-container { overflow-x: auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #34495e; color: white; }
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; color: white; }
        .badge.sold { background-color: #27ae60; }
        .badge.locked { background-color: #f39c12; }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="nav-title">ğŸ» å±±ç†Šç§‘å­¸å¾Œå°</div>
        <div class="nav-tabs">
            <button class="active" onclick="switchTab('monitor')">ğŸ“Š åŠƒä½ç›£æ§</button>
            <button onclick="switchTab('courses')">ğŸ“ èª²ç¨‹ç®¡ç†</button>
        </div>
    </div>

    <!-- åˆ†é  1ï¼šåŠƒä½ç›£æ§ -->
    <div id="tab-monitor" class="page-section active">
        <div style="text-align:center; margin-bottom:20px;">
            ç›®å‰æª¢è¦–ï¼š<span id="currentClassName" style="font-weight:bold;">æ‰€æœ‰èª²ç¨‹</span> | 
            å·²åŠƒä½ï¼š<span id="totalSold" style="font-weight:bold;">0</span>
        </div>
        <div style="background:white; padding:20px; border-radius:10px; margin-bottom:20px; display:flex; gap:10px;">
            <select id="classSelector"><option value="all">å…¨éƒ¨èª²ç¨‹ç¸½è¦½</option></select>
            <input type="text" id="searchInput" placeholder="æœå°‹å§“åæˆ–é›»è©±...">
            <button onclick="exportToCSV()" class="success">ğŸ“¥ åŒ¯å‡º Excel</button>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>èª²ç¨‹</th><th>åº§ä½</th><th>ç‹€æ…‹</th><th>å§“å</th><th>é›»è©±</th><th>æ™‚é–“</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="bookingTable"></tbody>
            </table>
        </div>
    </div>

    <!-- åˆ†é  2ï¼šèª²ç¨‹ç®¡ç† -->
    <div id="tab-courses" class="page-section">
        <div class="form-container">
            <h2 style="margin-top:0;">â• æ–°å¢èª²ç¨‹</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label>èª²ç¨‹åˆ†é¡</label>
                    <input list="category_list" id="c_category" placeholder="é¸æ“‡æˆ–è¼¸å…¥åˆ†é¡">
                    <datalist id="category_list">
                        <option value="å‡åœ‹ä¸€ç”Ÿç‰©"></option>
                        <option value="å‡åœ‹ä¸€æ•¸å­¸"></option>
                        <option value="å‡åœ‹äºŒç†åŒ–"></option>
                        <option value="å‡åœ‹ä¸‰ç¸½è¤‡ç¿’"></option>
                        <option value="å‡å°å…­è³‡å„ªè‡ªç„¶"></option>
                        <option value="å‡å°å…­è³‡å„ªæ•¸å­¸"></option>
                        <option value="å‡åœ‹ä¸€è‡ªç„¶è¶…å‰ç­"></option>
                        <option value="å‡åœ‹ä¸€æ•¸å­¸è¶…å‰ç­"></option>
                        <option value="å‡å°äº”é‚è¼¯æ•¸å­¸"></option>
                    </datalist>
                </div>
                <div class="form-group">
                    <label>èª²ç¨‹åç¨± (ç­ç´š)</label>
                    <input type="text" id="c_name" placeholder="ä¾‹å¦‚ï¼šé€±ä¸€å››ç­">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>æˆèª²è€å¸«</label>
                    <input list="teacher_list" id="c_teacher" placeholder="é¸æ“‡æˆ–è¼¸å…¥è€å¸«">
                    <datalist id="teacher_list">
                        <option value="ç™½ç†Šè€å¸«"></option>
                        <option value="é˜¿å–µè€å¸«"></option>
                        <option value="å°å½¥è€å¸«"></option>
                        <option value="å°æ±è€å¸«"></option>
                        <option value="æç¿”è€å¸«"></option>
                        <option value="å† ç¶­è€å¸«"></option>
                        <option value="å°æšè€å¸«"></option>
                        <option value="é»ƒé“è€å¸«"></option>
                        <option value="åŒ–éˆè€å¸«"></option>
                    </datalist>
                </div>
                <div class="form-group">
                    <label>ä½¿ç”¨æ•™å®¤</label>
                    <select id="c_classroom">
                        <option value="high_red">é«˜ä¸­ç´…æ•™å®¤</option>
                        <option value="high_orange">é«˜ä¸­æ©˜æ•™å®¤</option>
                        <option value="high_green">é«˜ä¸­ç¶ æ•™å®¤</option>
                        <option value="high_yellow">é«˜ä¸­é»ƒæ•™å®¤</option>
                        <option value="high_blue">é«˜ä¸­è—æ•™å®¤</option>
                        <option value="middle_new_orange">åœ‹ä¸­æ–°æ©˜æ•™å®¤</option>
                        <option value="middle_new_blue">åœ‹ä¸­æ–°è—æ•™å®¤</option>
                        <option value="middle_new_yellow">åœ‹ä¸­æ–°é»ƒæ•™å®¤</option>
                        <option value="middle_new_red">åœ‹ä¸­æ–°ç´…æ•™å®¤</option>
                        <option value="middle_big_red">åœ‹ä¸­å¤§ç´…æ•™å®¤</option>
                        <option value="middle_da_chiao">åœ‹ä¸­å¤§æ©‹æ•™å®¤</option>
                        <option value="middle_big_green">åœ‹ä¸­å¤§ç¶ æ•™å®¤</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>å°é¢åœ–ç‰‡ (å»ºè­° 800x400)</label>
                <input type="file" id="c_image_file" accept="image/*">
                <div id="uploadStatus" style="font-size:12px; color:#666; margin-top:5px;"></div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ä¸€éšé–‹æ”¾ (é–‹å§‹)</label>
                    <input type="datetime-local" id="c_start1">
                </div>
                <div class="form-group">
                    <label>ä¸€éšé–‹æ”¾ (çµæŸ)</label>
                    <input type="datetime-local" id="c_end1">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>äºŒéšé–‹æ”¾ (é–‹å§‹)</label>
                    <input type="datetime-local" id="c_start2">
                </div>
                <div class="form-group">
                    <label>è²»ç”¨</label>
                    <input type="text" id="c_price" placeholder="ä¾‹å¦‚ï¼š$5000">
                </div>
            </div>

            <div class="form-group">
                <label>èª²ç¨‹ä»‹ç´¹ / æ³¨æ„äº‹é …</label>
                <textarea id="c_desc"></textarea>
            </div>

            <button onclick="addCourse()" class="success" style="width:100%;">ç¢ºèªæ–°å¢èª²ç¨‹</button>
        </div>

        <h2 style="text-align:center; margin-top:40px;">ğŸ“‹ ç›®å‰èª²ç¨‹åˆ—è¡¨</h2>
        <div id="courseList" class="course-list"></div>
    </div>

    <script type="module">
        import { db, ref, set, remove, push, storage, storageRef, uploadBytes, getDownloadURL } from './firebase-config.js';
        import { onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // åˆå§‹åŒ– TinyMCE
        tinymce.init({
            selector: '#c_desc',
            plugins: 'image link lists media table',
            toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | image',
            height: 400,
            menubar: true
        });

        // ----- å…¨åŸŸè®Šæ•¸ -----
        let allBookings = [];
        let coursesData = {};

        window.switchTab = function(tabName) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tabs button').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        };

        // ----- èª²ç¨‹ç®¡ç†é‚è¼¯ -----
        const coursesRef = ref(db, 'courses');

        onValue(coursesRef, (snapshot) => {
            coursesData = snapshot.val() || {};
            renderCourseList();
            updateClassSelector(); 
        });

        window.addCourse = async function() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = "è™•ç†ä¸­...";

            try {
                const descContent = tinymce.get('c_desc').getContent();
                const category = document.getElementById('c_category').value;
                const name = document.getElementById('c_name').value;
                const teacher = document.getElementById('c_teacher').value;
                const classroom = document.getElementById('c_classroom').value;
                const start1 = document.getElementById('c_start1').value;
                const end1 = document.getElementById('c_end1').value;
                const start2 = document.getElementById('c_start2').value;
                const price = document.getElementById('c_price').value;
                const fileInput = document.getElementById('c_image_file');

                if (!category || !name || !start1) throw new Error("è«‹å¡«å¯«å®Œæ•´è³‡æ–™ï¼");

                // ä¸Šå‚³åœ–ç‰‡ (ä½¿ç”¨ Firebase Storage)
                let imageUrl = "https://via.placeholder.com/400x200?text=No+Image";
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const storagePath = `course_images/${Date.now()}_${file.name}`;
                    const imgRef = storageRef(storage, storagePath);
                    
                    document.getElementById('uploadStatus').textContent = "ä¸Šå‚³åœ–ç‰‡åˆ° Firebase ä¸­...";
                    
                    // å¢åŠ  metadata å˜—è©¦è§£æ±º CORS (åœ¨ GitHub ä¸ŠæœƒæˆåŠŸ)
                    const metadata = { contentType: file.type };
                    await uploadBytes(imgRef, file, metadata);
                    imageUrl = await getDownloadURL(imgRef);
                }

                // å¯«å…¥è³‡æ–™åº«
                const newCourseRef = push(coursesRef);
                await set(newCourseRef, {
                    category, name, teacher, classroom,
                    start1, end1, start2, price, 
                    desc: descContent, 
                    image: imageUrl,
                    createdAt: Date.now()
                });

                alert("âœ… èª²ç¨‹æ–°å¢æˆåŠŸï¼");
                document.querySelectorAll('input').forEach(i => i.value = '');
                tinymce.get('c_desc').setContent('');
                document.getElementById('uploadStatus').textContent = "";

            } catch (err) {
                alert("éŒ¯èª¤ï¼š" + err.message + "\n(å¦‚æœæ˜¯åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œè«‹å˜—è©¦ä¸Šå‚³åˆ° GitHub å¾Œå†è©¦)");
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.textContent = "ç¢ºèªæ–°å¢èª²ç¨‹";
            }
        };

        function renderCourseList() {
            const listDiv = document.getElementById('courseList');
            listDiv.innerHTML = "";
            Object.keys(coursesData).forEach(key => {
                const c = coursesData[key];
                const card = document.createElement('div');
                card.className = 'admin-course-card';
                card.innerHTML = `
                    <h3>[${c.category}] ${c.name}</h3>
                    <p>ğŸ‘¨â€ğŸ« ${c.teacher} | ğŸ“ ${c.classroom}</p>
                    <p>â° ä¸€éšï¼š${new Date(c.start1).toLocaleString()}</p>
                    <button class="btn-delete" onclick="window.deleteCourse('${key}')">åˆªé™¤</button>
                `;
                listDiv.appendChild(card);
            });
        }

        window.deleteCourse = function(courseId) {
            if (confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤ï¼Ÿ")) remove(ref(db, `courses/${courseId}`));
        };

        // ----- åŠƒä½ç›£æ§é‚è¼¯ (ç¶­æŒä¸è®Š) -----
        const allSeatsRef = ref(db, 'seats');
        onValue(allSeatsRef, (snapshot) => {
            const data = snapshot.val() || {};
            allBookings = [];
            Object.keys(data).forEach(courseId => {
                const seats = data[courseId];
                const courseName = coursesData[courseId] ? `[${coursesData[courseId].category}] ${coursesData[courseId].name}` : courseId;
                Object.keys(seats).forEach(seatId => {
                    const info = seats[seatId];
                    if (info.status === 'sold' || info.status === 'locked') {
                        allBookings.push({
                            courseId, courseName, seatId, status: info.status,
                            studentName: info.studentName || '-', parentPhone: info.parentPhone || '-',
                            time: info.soldTime || '-', rawTime: info.timestamp
                        });
                    }
                });
            });
            allBookings.sort((a, b) => b.rawTime - a.rawTime);
            renderTable();
            updateStats();
        });

        function updateClassSelector() {
            const selector = document.getElementById('classSelector');
            selector.innerHTML = '<option value="all">å…¨éƒ¨èª²ç¨‹ç¸½è¦½</option>';
            Object.keys(coursesData).forEach(key => {
                const c = coursesData[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `[${c.category}] ${c.name}`;
                selector.appendChild(option);
            });
        }

        function renderTable() {
            const filterId = document.getElementById('classSelector').value;
            const searchText = document.getElementById('searchInput').value.trim().toLowerCase();
            const tbody = document.getElementById('bookingTable');
            tbody.innerHTML = "";
            
            allBookings.forEach(b => {
                if (filterId !== 'all' && b.courseId !== filterId) return;
                if (searchText && !b.studentName.includes(searchText) && !b.parentPhone.includes(searchText)) return;
                const tr = document.createElement('tr');
                const statusBadge = b.status === 'sold' ? '<span class="badge sold">å·²åŠƒä½</span>' : '<span class="badge locked">å¡«å¯«ä¸­</span>';
                tr.innerHTML = `<td>${b.courseName}</td><td>${b.seatId}</td><td>${statusBadge}</td><td>${b.studentName}</td><td>${b.parentPhone}</td><td>${b.time}</td><td><button class="danger" onclick="window.releaseSeat('${b.courseId}', '${b.seatId}')">é‡‹å‡º</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function updateStats() {
            document.getElementById('totalSold').textContent = allBookings.filter(b => b.status === 'sold').length;
        }

        window.releaseSeat = function(courseId, seatId) {
            if (confirm("âš ï¸ ç¢ºå®šé‡‹å‡ºï¼Ÿ")) set(ref(db, `seats/${courseId}/${seatId}`), null);
        };

        window.exportToCSV = function() {
            let csv = "\uFEFFèª²ç¨‹,åº§ä½,ç‹€æ…‹,å§“å,é›»è©±,æ™‚é–“\n";
            allBookings.forEach(b => csv += `${b.courseName},${b.seatId},${b.status},${b.studentName},'${b.parentPhone},${b.time}\n`);
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "booking_data.csv";
            link.click();
        };

        document.getElementById('classSelector').addEventListener('change', () => {
            const sel = document.getElementById('classSelector');
            document.getElementById('currentClassName').textContent = sel.options[sel.selectedIndex].text;
            renderTable();
        });
        document.getElementById('searchInput').addEventListener('input', renderTable);

    </script>
</body>
</html>